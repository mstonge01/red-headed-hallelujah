<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Red-Headed Hallelujah</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter (sans-serif) and Staatliches (blocky, for title) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Staatliches&display=swap" rel="stylesheet">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json?v=3"> <!-- Matches the v3 in sw.js -->
    <meta name="theme-color" content="#EF4444">
    
    <style>
        /* Custom styles to match the album art aesthetic */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Using 'Staatliches' for the main album title to mimic the cover font */
        .font-album-title {
            font-family: 'Staatliches', cursive;
        }

        /* Custom scrollbar for playlists */
        #playlist::-webkit-scrollbar,
        #video-playlist::-webkit-scrollbar,
        #flipper-back::-webkit-scrollbar {
            width: 8px;
        }
        #playlist::-webkit-scrollbar-track,
        #video-playlist::-webkit-scrollbar-track,
        #flipper-back::-webkit-scrollbar-track {
            background: #374151; /* gray-700 */
            border-radius: 10px;
        }
        #playlist::-webkit-scrollbar-thumb,
        #video-playlist::-webkit-scrollbar-thumb,
        #flipper-back::-webkit-scrollbar-thumb {
            background: #EF4444; /* red-500 */
            border-radius: 10px;
        }
        #playlist::-webkit-scrollbar-thumb:hover,
        #video-playlist::-webkit-scrollbar-thumb:hover,
        #flipper-back::-webkit-scrollbar-thumb:hover {
            background: #DC2626; /* red-600 */
        }

        /* Style for the currently active playlist item */
        .playlist-item.active {
            background-color: #EF4444; /* red-500 */
            color: #FFFFFF; /* white */
        }
        
        /* Style for video item */
        .video-item.active {
             background-color: #EF4444; /* red-500 */
        }
        .video-item.active .video-title {
            color: #FFFFFF; /* white */
        }
         .video-item.active .video-artist {
            color: #E5E7EB; /* gray-200 */
        }


        /* Custom style for the progress bar slider thumb */
        #progress-bar-container input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #EF4444; /* red-500 */
            border-radius: 3px;
            cursor: pointer;
            margin-top: -6px; /* Center the thumb on the track */
        }
        
        #progress-bar-container input[type=range]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #EF4444; /* red-500 */
            border-radius: 3px;
            cursor: pointer;
        }

        /* Custom style for the progress bar track */
        #progress-bar-container input[type=range] {
             -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: #4B5563; /* gray-600 */
            outline: none;
        }

        /* Class for the player texture */
        .player-texture {
            background-color: #1F2937; /* This is Tailwind's bg-gray-800 */
            background-image: url('https://www.transparenttextures.com/patterns/stucco.png');
        }
        
        /* 'Live Glow' Pulse Animation */
        @keyframes pulseGlow {
            0%, 100% {
                box-shadow: 0 0 10px rgba(239, 68, 68, 0.4), 0 0 12px rgba(239, 68, 68, 0.3);
            }
            50% {
                box-shadow: 0 0 16px rgba(239, 68, 68, 0.7), 0 0 20px rgba(239, 68, 68, 0.5);
            }
        }
        
        .is-playing-glow {
            animation: pulseGlow 2.5s infinite ease-in-out;
        }

        /* --- Flipper, Video Panel, & Art Styles --- */
        .art-container {
            padding-top: 100%; /* Creates a 1:1 aspect ratio */
        }
        
        #flipper {
            transform-style: preserve-3d;
            transition: transform 0.8s;
        }
        #flipper.is-flipped {
            transform: rotateY(180deg);
        }
        .flipper-front,
        .flipper-back {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }
        #flipper-back {
            transform: rotateY(180deg);
            background-color: #4B5563; /* gray-600 */
            background-image: url('https://www.transparenttextures.com/patterns/concrete-wall.png');
        }
        #note-body {
            white-space: pre-wrap;
        }
        
        #song-art {
            transition: opacity 0.5s ease-in-out;
            opacity: 0;
        }
        #song-art.is-visible {
            opacity: 1;
        }
        
        /* Video Panel Styles */
        #video-panel {
            background-color: #000;
            z-index: 10; /* Sits on top of the flipper */
        }

        /* --- Splash Screen Styles --- */
        #enter-btn {
            background: rgba(239, 68, 68, 0.8); /* red-500 with 80% opacity */
            border: 2px solid rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
        }
        #enter-btn:hover {
            background: rgba(220, 38, 38, 1); /* red-600 */
            border-color: white;
            transform: scale(1.05);
        }
        #enter-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
        #update-status {
            background: rgba(17, 24, 39, 0.8); /* gray-900 with 80% opacity */
        }

        /* --- Skip Intro Button Style --- */
        #skip-intro-btn {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        #skip-intro-btn:hover {
            background: rgba(0, 0, 0, 0.75);
            border-color: rgba(255, 255, 255, 0.7);
        }
        
        /* --- Audio/Video Tab Styles --- */
        /* REMOVED .tab-btn styles from here. They are now directly on the HTML elements. */

    </style>
</head>
<body class="bg-gray-900 text-gray-300 min-h-screen flex items-center justify-center p-4">

    <!-- Video Splash Screen -->
    <div id="splash-screen" class="fixed top-0 left-0 w-full h-full bg-gray-900 z-50 flex items-center justify-center opacity-100 transition-opacity duration-1000">
        
        <!-- Video: NO Autoplay -->
        <video id="splash-video" class="max-w-full max-h-full object-contain" preload="auto" playsinline>
            <source src="paint-video.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        
        <!-- Status / Button Container -->
        <div class="absolute inset-0 flex items-center justify-center">
             <!-- "Checking for Updates..." - Only shown on PWA app load -->
            <div id="update-status" class="hidden p-4 rounded-lg text-white font-album-title text-xl tracking-wider">
                Checking for Updates...
            </div>

            <!-- "Click to Begin" Button - Hidden until check is done -->
            <button id="enter-btn" class="hidden z-60 text-white p-4 px-8 font-album-title text-xl tracking-wider rounded-lg" disabled>
                Click to Begin
            </button>
        </div>

        <!-- Skip Intro Button -->
        <button id="skip-intro-btn" class="hidden absolute bottom-5 left-1/2 -translate-x-1/2 z-60 text-white px-4 py-2 rounded-lg text-sm hover:bg-black/75 transition">
            Skip Intro
        </button>
    </div>

    <!-- Main Player Container (starts invisible) -->
    <div id="player-container" class="w-full max-w-4xl opacity-0 transition-opacity duration-1000">
        
        <!-- Player Container -->
        <div class="player-texture shadow-2xl overflow-hidden flex flex-col md:flex-row rounded-lg">
            
            <!-- Left Side: Art, Video, Liner Notes -->
            <div class="w-full md:w-1/2 flex-shrink-0 flex flex-col">
                <!-- 1:1 Aspect Ratio Container -->
                <div class="relative w-full art-container"> 
                    
                    <!-- Video Panel (Hidden by default) -->
                    <div id="video-panel" class="absolute top-0 left-0 w-full h-full hidden">
                        <iframe id="youtube-player" class="w-full h-full" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                    </div>

                    <!-- 3D Flipper -->
                    <div id="flipper" class="absolute top-0 left-0 w-full h-full">
                        <!-- FRONT (Album Art) -->
                        <div class="flipper-front absolute w-full h-full">
                            <!-- Main Album Art -->
                            <img src="cover.png" alt="Album Art for Red-Headed Hallelujah" class="w-full h-full object-cover">
                            <!-- Song-Specific Art (fades in) -->
                            <img id="song-art" src="" alt="Song-specific art" class="absolute top-0 left-0 w-full h-full object-cover">
                        </div>
                        <!-- BACK (Liner Notes) -->
                        <div id="flipper-back" class="flipper-back absolute w-full h-full p-6 overflow-y-auto">
                            <h3 id="note-title" class="font-album-title text-3xl text-yellow-400 tracking-wider mb-4"></h3>
                            <p id="note-body" class="text-gray-200"></p>
                        </div>
                    </div>
                </div>
                
                <!-- Buttons Below Art -->
                <div class="grid grid-cols-2">
                    <button id="liner-notes-btn" class="w-full bg-red-500 text-white font-album-title tracking-wider text-lg p-3 hover:bg-red-600 transition-colors duration-200 rounded-bl-lg">
                        Liner Notes
                    </button>
                     <button id="about-btn" class="w-full bg-gray-600 text-white font-album-title tracking-wider text-lg p-3 hover:bg-gray-700 transition-colors duration-200">
                        About This App
                    </button>
                </div>
            </div>

            <!-- Right Side: Info, Controls, Playlist -->
            <div class="w-full md:w-1/2 p-6 flex flex-col justify-between">
                
                <!-- Top-Right: Current Song Info -->
                <div class="mb-4 flex-shrink-0">
                    <p class="text-lg uppercase tracking-widest text-red-500 font-album-title">Now Playing</p>
                    <h2 id="song-title" class="text-3xl text-yellow-400 truncate font-album-title tracking-wider">Song Title</h2>
                    <h3 id="song-artist" class="text-lg text-gray-300">A mstonge01 Project</h3>
                </div>

                <!-- Middle-Right: Controls & Progress Bar -->
                <div class="mb-4 flex-shrink-0">
                    <!-- Progress Bar -->
                    <div id="progress-bar-container" class="mb-3">
                         <input type="range" id="progress-bar" class="w-full h-1 bg-gray-700 rounded-lg cursor-pointer" value="0" min="0" max="100">
                    </div>
                    <!-- Time Display -->
                    <div class="flex justify-between text-sm text-gray-400">
                        <span id="current-time">0:00</span>
                        <span id="duration-time">0:00</span>
                    </div>

                    <!-- Controls -->
                    <div class="flex justify-center items-center space-x-6 mt-4">
                        <!-- Previous Button -->
                        <button id="prev-btn" class="text-gray-400 hover:text-red-500 transition-colors duration-200">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M8.445 14.832A1 1 0 0010 14.03V5.969a1 1 0 00-1.555-.832L4.12 9.168a1 1 0 000 1.664l4.325 4zM10.879 9.168a1 1 0 000 1.664l4.325 4A1 1 0 0017 14.03V5.969a1 1 0 00-1.555-.832l-4.325 4z"/></svg>
                        </button>
                        <!-- Play/Pause Button -->
                        <button id="play-pause-btn" class="w-16 h-16 bg-red-500 text-white rounded-full flex items-center justify-center text-2xl hover:bg-red-600 transition-colors duration-200 shadow-lg">
                            <!-- Play Icon -->
                            <svg id="play-icon" class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8.002v3.996a1 1 0 001.555.832l3.197-1.998a1 1 0 000-1.664l-3.197-1.998z" clip-rule="evenodd"/></svg>
                            <!-- Pause Icon (hidden by default) -->
                            <svg id="pause-icon" class="w-8 h-8 hidden" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h1a1 1 0 001-1V8a1 1 0 00-1-1H8zm5 0a1 1 0 00-1 1v4a1 1 0 001 1h1a1 1 0 001-1V8a1 1 0 00-1-1h-1z" clip-rule="evenodd"/></svg>
                        </button>
                        <!-- Next Button -->
                        <button id="next-btn" class="text-gray-400 hover:text-red-500 transition-colors duration-200">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M4.555 5.168A1 1 0 003 5.969v8.062a1 1 0 001.555.832l4.325-4a1 1 0 000-1.664l-4.325-4zM10.879 5.168A1 1 0 009.324 5.97v8.062a1 1 0 001.555.832l4.325-4a1 1 0 000-1.664l-4.325-4z"/></svg>
                        </button>
                    </div>
                </div>
                
                <!-- Bottom-Right: Tabs & Playlists -->
                <div class="flex-grow min-h-0 flex flex-col">
                    <!-- Audio/Video Tabs -->
                    <div class="flex-shrink-0 flex">
                        <button id="audio-tab" class="w-1/2 p-3 text-center font-album-title tracking-wider text-lg transition-colors duration-200 rounded-tl-lg bg-red-500 text-white active">Audio</button>
                        <button id="video-tab" class="w-1/2 p-3 text-center font-album-title tracking-wider text-lg transition-colors duration-200 rounded-tr-lg text-gray-400 bg-gray-700 hover:bg-gray-600 hover:text-gray-200">Video</button>
                    </div>
                    
                    <!-- Playlist Container -->
                    <div class="flex-grow min-h-0 relative h-80 md:h-auto">
                        <!-- Audio Playlist -->
                        <div id="playlist" class="absolute inset-0 overflow-y-auto pr-2 bg-gray-800 rounded-b-lg">
                            <!-- Audio items will be injected here -->
                        </div>
                        <!-- Video Playlist -->
                        <div id="video-playlist" class="absolute inset-0 overflow-y-auto pr-2 bg-gray-800 rounded-b-lg hidden">
                            <!-- Video items will be injected here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- The actual audio element, hidden from view -->
    <audio id="audio-player"></audio>
    <audio id="intro-audio" src="hallelujah-intro.mp3" preload="auto"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 1. DATABASES ---
            const songs = [
                { 
                    title: "Intro", 
                    src: "01-intro.mp3",
                    image_src: "01-intro-art.png",
                    note: ``
                },
                { 
                    title: "The Crimson Tide", 
                    src: "02-the-crimson-tide.mp3",
                    image_src: "02-the-crimson-tide-art.png",
                    note: ``
                },
                { 
                    title: "Real Women", 
                    src: "03-real-women.mp3",
                    image_src: "03-real-women-art.png",
                    note: ``
                },
                { 
                    title: "Red-Headed Hallelujah", 
                    src: "04-red-headed-hallelujah.mp3",
                    image_src: "04-red-headed-hallelujah-art.png",
                    note: ``
                },
                { 
                    title: "The Good Stuff", 
                    src: "05-the_good_stuff.mp3",
                    image_src: "05-the_good_stuff-art.png",
                    note: ``
                },
                { 
                    title: "Zero-Degree Beach", 
                    src: "06-zero-degree-beach.mp3",
                    image_src: "06-zero-degree-beach-art.png",
                    note: ``
                },
                { 
                    title: "Caps", 
                    src: "07-caps.mp3",
                    image_src: "07-caps-art.png",
                    note: ``
                },
                { 
                    title: "Interrupted", 
                    src: "08-interrupted.mp3",
                    image_src: "08-interrupted-art.png",
                    note: ``
                },
                { 
                    title: "Cinnamon Serenade", 
                    src: "09-cinnamon-serenade.mp3",
                    image_src: "09-cinnamon-serenade-art.png",
                    note: ``
                },
                { 
                    title: "Golden Devotion", 
                    src: "10-golden-devotion.mp3",
                    image_src: "10-golden-devotion-art.png",
                    note: ``
                },
                { 
                    title: "Natural Magic", 
                    src: "11-natural-magic.mp3",
                    image_src: "11-natural-magic-art.png",
                    note: ``
                },
                { 
                    title: "Outro", 
                    src: "12-outro.mp3",
                    image_src: "12-outro-art.png",
                    note: ``
                },
                { 
                    title: "[Bonus Track] Red-Headed Hallelujah (Guitar)", 
                    src: "13-red-headed-hallelujah-guitar.mp3",
                    image_src: "13-red-headed-hallelujah-guitar-art.png",
                    note: ``
                },
                { 
                    title: "[Bonus Track] Natural Magic (Acoustic)", 
                    src: "14-natural-magic-acoustic.mp3",
                    image_src: "11-natural-magic-art.png", // Uses Natural Magic art
                    note: ``
                }
            ];

            const videos = [
                {
                    title: "Real Women",
                    src: "https://www.youtube.com/embed/VXiXI-mZvL4",
                    image_src: "03-real-women-art.png" // This matches song index 2
                },
                {
                    title: "Red-Headed Hallelujah",
                    src: "https://www.youtube.com/embed/UDf9TQ6QDsc",
                    image_src: "04-red-headed-hallelujah-art.png" // This matches song index 3
                },
                {
                    title: "Natural Magic",
                    src: "https://www.youtube.com/embed/usGSmvYKI5c",
                    image_src: "11-natural-magic-art.png" // This matches song index 10
                }
            ];

            const artistName = "A mstonge01 Project";
            const albumTitle = "Red-Headed Hallelujah";
            const albumNote = `Welcome to Red-Headed Hallelujah, a digital music experience that is part concept album, part street-art gallery, and part AI-assisted love letter. This project was conceived and directed by mstonge01 as a dedicated gift to his wife, Rebecca, blending personal storytelling with cutting-edge technology. This isn't just a website. It's a custom-built Progressive Web App (PWA), designed from the ground up to work perfectly on any device, from a desktop browser to a mobile phone. When installed, it functions as a complete, offline-first application. The app shell loads instantly, while the entire album and its corresponding artwork are cached in the background, allowing for a seamless, high-fidelity listening experience anywhere, with or without an internet connection. The player is deeply integrated with native Media Session controls, meaning the album's art, titles, and playback can be managed directly from your phone's lock screen or your car's dashboard—a testament to its technical polish. The Concept: A Graffiti Tribute. The album's visual identity is rooted in the raw, authentic aesthetic of urban stencil art. The cover and all accompanying track images were created in this high-contrast style, depicting the "Red-Headed Hallelujah" herself in various moments and personas. Like a series of tributes painted on a weathered concrete wall, each image tells a story. You'll find a defiant driver in a doorless Jeep for "Real Women," a saint-like figure bathed in holy light for the title track, and a tender portrait of motherhood for "Natural Magic." A central feature of this site is the Liner Notes button. Click it, and the artwork performs a 3D flip, revealing the story and lyrics behind each song, much like discovering a hidden message on the back of a physical record sleeve. The Music: The "Red-Headed Rock" Aesthetic. Musically, Red-Headed Hallelujah is a high-energy "Red-Headed Rock" album at its core, but it masterfully explores the full spectrum of a life lived together. While generated with the assistance of AI, each track was painstakingly directed, with custom lyrics and styling to create a cohesive and deeply personal narrative. The album opens with the driving, dangerous hard rock of "The Crimson Tide," a symbolic tale of a siren-like mermaid, before moving into the gritty, fuzzed-out blues-rock defiance of "Real Women." The experience flows from chaotic, comedic pop-punk ("Interrupted") and playful funk-rock ("Caps") to moments of profound tenderness, like the intimate acoustic folk of "Natural Magic." The album hits its emotional peak with the soaring, choir-backed anthem "Red-Headed Hallelujah" and the rugged, soulful southern rock ballad "Cinnamon Serenade"—a raw ode to love's less-than-glamorous, unconditional moments. This is a technical and artistic creation, a digital monument to a real-world muse. Enjoy the experience.`;
            const albumName = "Red-Headed Hallelujah";

            // --- 2. DOM ELEMENT REFERENCES ---
            const splashScreen = document.getElementById('splash-screen');
            const splashVideo = document.getElementById('splash-video');
            const enterBtn = document.getElementById('enter-btn');
            const skipIntroBtn = document.getElementById('skip-intro-btn');
            const updateStatusEl = document.getElementById('update-status'); // "Checking for Updates..." message
            const playerContainer = document.getElementById('player-container');
            const audioPlayer = document.getElementById('audio-player');
            const introAudio = document.getElementById('intro-audio');
            const songTitleEl = document.getElementById('song-title');
            const songArtistEl = document.getElementById('song-artist');
            
            const playlistEl = document.getElementById('playlist');
            const videoPlaylistEl = document.getElementById('video-playlist');
            const audioTab = document.getElementById('audio-tab');
            const videoTab = document.getElementById('video-tab');
            
            const playPauseBtn = document.getElementById('play-pause-btn');
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const progressBar = document.getElementById('progress-bar');
            const currentTimeEl = document.getElementById('current-time');
            const durationTimeEl = document.getElementById('duration-time');
            
            const linerNotesBtn = document.getElementById('liner-notes-btn');
            const aboutBtn = document.getElementById('about-btn');
            const flipper = document.getElementById('flipper');
            const noteTitleEl = document.getElementById('note-title');
            const noteBodyEl = document.getElementById('note-body');
            const songArtEl = document.getElementById('song-art');
            const mainPlayerDiv = document.querySelector('.player-texture');
            
            const videoPanel = document.getElementById('video-panel');
            const youtubePlayer = document.getElementById('youtube-player');


            // --- 3. PLAYER STATE ---
            let currentSongIndex = 0;
            let currentVideoIndex = null; // To track active video
            let isPlaying = false;
            let hasUserInteracted = false;
            let currentNote = 'album'; // 'album', 'about', or song index

            // --- 4. FUNCTIONS ---
            
            // This function now just shows the "Click to Begin" button.
            // It's called after the PWA check (if any) is complete.
            function showBeginButton() {
                updateStatusEl.style.display = 'none'; // Hide "Checking for Updates..."
                enterBtn.textContent = 'Click to Begin';
                enterBtn.style.display = 'block'; // Show the button
                enterBtn.disabled = false;
            }

            // This function handles the intro video and audio sequence
            function startVideoTransition() {
                if(hasUserInteracted) return;
                hasUserInteracted = true;
                
                // Tell the service worker to start caching songs in the background (if it's the app)
                if (window.matchMedia('(display-mode: standalone)').matches && 'serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    console.log('Sending cache-content message to SW');
                    navigator.serviceWorker.controller.postMessage({ action: 'cache-content' });
                }
                
                introAudio.load(); // Preload the intro audio
                enterBtn.style.display = 'none'; // Hide the "Click to Begin" button
                skipIntroBtn.classList.remove('hidden'); // Show the "Skip Intro" button

                // Manually play the video (no autoplay)
                splashVideo.play().then(() => {
                    // Video started!
                }).catch(error => {
                    console.warn("Video play failed even after click:", error);
                    transitionToPlayer(); // Failsafe in case video fails
                });
            }

            // New function to skip the intro
            function skipIntro() {
                splashVideo.pause();
                introAudio.pause(); // Stop the intro audio just in case
                skipIntroBtn.classList.add('hidden'); // Hide skip button
                transitionToPlayer(); // Go right to the player
            }

            // This function fades to the player
            function transitionToPlayer() {
                skipIntroBtn.classList.add('hidden'); // Hide skip button
                // Wait 1 second after intro audio finishes (or skip is clicked)
                setTimeout(() => {
                    splashScreen.style.opacity = '0';
                    playerContainer.style.opacity = '1';
                    
                    // After the fade, remove the splash screen
                    setTimeout(() => {
                        splashScreen.style.display = 'none';
                    }, 1000); // Must match the transition duration
                    
                }, 1000); // 1-second pause
            }
            
            function showVideoPanel(show) {
                if (show) {
                    videoPanel.classList.remove('hidden');
                    flipper.classList.add('hidden');
                } else {
                    videoPanel.classList.add('hidden');
                    flipper.classList.remove('hidden');
                    // Stop the YouTube video
                    youtubePlayer.src = ''; 
                    updateActiveVideoItem(null);
                }
            }

            // --- All other player functions (updatePositionState, updateMediaSession, etc.) are correct ---
            function updatePositionState() {
                if ('mediaSession' in navigator && navigator.mediaSession.metadata) {
                    const { duration, currentTime } = audioPlayer;
                    if (duration && isFinite(duration)) {
                        navigator.mediaSession.setPositionState({
                            duration: duration,
                            playbackRate: audioPlayer.playbackRate,
                            position: currentTime
                        });
                    }
                }
            }
            
            function updateMediaSession(song) {
                if ('mediaSession' in navigator) {
                    if (song) {
                        // Song is playing
                        navigator.mediaSession.metadata = new MediaMetadata({
                            title: song.title,
                            artist: artistName,
                            album: albumName,
                            artwork: [
                                { src: song.image_src, sizes: '512x512', type: 'image/png' }
                            ]
                        });
                        navigator.mediaSession.playbackState = "playing";
                    } else {
                        // Song is paused
                        if (navigator.mediaSession.metadata) {
                             navigator.mediaSession.playbackState = "paused";
                        }
                    }
                    updatePositionState(); // Update progress bar
                }
            }
            
            function updateNoteContent() {
                if (currentNote === 'album') {
                    noteTitleEl.textContent = albumTitle;
                    noteBodyEl.innerHTML = albumNote;
                } else if (currentNote === 'about') {
                    noteTitleEl.textContent = "About This App";
                    noteBodyEl.innerHTML = albumNote; // 'albumNote' is a mistake in original, but let's keep it for now as it's what you have
                } else {
                    const song = songs[currentNote];
                    noteTitleEl.textContent = song.title;
                    noteBodyEl.innerHTML = song.note;
                }
            }


            function loadSong(song) {
                songTitleEl.textContent = song.title;
                songArtistEl.textContent = artistName;
                audioPlayer.src = song.src;
                songArtEl.src = song.image_src; // Set new song art
                songArtEl.classList.remove('is-visible'); // Make it invisible (ready to fade in)
                
                // Close video panel if open
                showVideoPanel(false);
                // Flip notes back to front
                flipper.classList.remove('is-flipped');
                currentNote = currentSongIndex; // Set note to current song
                
                updateActivePlaylistItem();
            }

            function playSong() {
                if (!audioPlayer.src || audioPlayer.src.endsWith('index.html')) {
                    loadSong(songs[currentSongIndex]);
                }
                
                // Close video panel if open
                showVideoPanel(false);

                isPlaying = true;
                audioPlayer.play();
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
                songArtEl.classList.add('is-visible'); // Fade in song art
                mainPlayerDiv.classList.add('is-playing-glow'); // Add glow
                
                currentNote = currentSongIndex; // Set note to current song
                if (flipper.classList.contains('is-flipped')) {
                    updateNoteContent(); // Update notes if panel is already flipped
                }
                updateMediaSession(songs[currentSongIndex]);
            }

            function pauseSong() {
                isPlaying = false;
                audioPlayer.pause();
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                songArtEl.classList.remove('is-visible'); // Fade out song art
                mainPlayerDiv.classList.remove('is-playing-glow'); // Remove glow
                
                // If notes are showing (and not 'about'), switch to album notes
                if (flipper.classList.contains('is-flipped') && currentNote !== 'about') {
                    currentNote = 'album';
                    updateNoteContent();
                }

                updateMediaSession(null);
            }

            function prevSong() {
                currentSongIndex--;
                if (currentSongIndex < 0) currentSongIndex = songs.length - 1;
                loadSong(songs[currentSongIndex]);
                if (isPlaying) playSong();
            }

            function nextSong() {
                currentSongIndex++;
                if (currentSongIndex > songs.length - 1) currentSongIndex = 0;
                loadSong(songs[currentSongIndex]);
                if (isPlaying) playSong();
            }

            function updateProgress(e) {
                const { duration, currentTime } = e.srcElement;
                if (duration) {
                    const progressPercent = (currentTime / duration) * 100;
                    progressBar.value = progressPercent;
                    durationTimeEl.textContent = formatTime(duration);
                    currentTimeEl.textContent = formatTime(currentTime);
                    updatePositionState(); // Update truck progress bar
                }
            }

            function formatTime(seconds) {
                if (isNaN(seconds)) return "0:00";
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            }

            function setProgress() {
                const duration = audioPlayer.duration;
                if (duration) {
                     audioPlayer.currentTime = (progressBar.value / 100) * duration;
                     updatePositionState(); // Update truck progress bar
                }
            }
            
            function updateActivePlaylistItem() {
                const items = document.querySelectorAll('#playlist .playlist-item');
                items.forEach((item, index) => {
                    if (index === currentSongIndex) {
                        item.classList.add('active');
                        item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    } else {
                        item.classList.remove('active');
                    }
                });
            }
            
            function updateActiveVideoItem(activeIndex) {
                currentVideoIndex = activeIndex;
                const items = document.querySelectorAll('#video-playlist .video-item');
                items.forEach((item, index) => {
                    if (index === activeIndex) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
            }


            function createPlaylist() {
                songs.forEach((song, index) => {
                    const item = document.createElement('div');
                    item.classList.add('playlist-item', 'p-3', 'rounded-lg', 'cursor-pointer', 'hover:bg-gray-700', 'transition-colors', 'duration-200');
                    item.innerHTML = `
                        <p class="font-album-title tracking-wider truncate">${song.title}</p>
                        <p class="text-sm text-gray-400">${artistName}</p>
                    `;
                    item.addEventListener('click', () => {
                        currentSongIndex = index;
                        loadSong(song);
                        playSong();
                    });
                    playlistEl.appendChild(item);
                });
            }
            
            function createVideoPlaylist() {
                videos.forEach((video, index) => {
                    const item = document.createElement('div');
                    item.classList.add('video-item', 'p-3', 'rounded-lg', 'cursor-pointer', 'hover:bg-gray-700', 'transition-colors', 'duration-200', 'flex', 'items-center', 'space-x-4');
                    item.innerHTML = `
                        <img src="${video.image_src}" alt="Thumbnail for ${video.title}" class="w-16 h-16 object-cover rounded-md flex-shrink-0">
                        <div class="overflow-hidden">
                            <p class="font-album-title tracking-wider truncate video-title text-gray-100">${video.title}</p>
                            <p class="text-sm text-gray-400 video-artist">${artistName}</p>
                        </div>
                    `;
                    item.addEventListener('click', () => {
                        playVideo(video, index);
                    });
                    videoPlaylistEl.appendChild(item);
                });
            }
            
            function playVideo(video, index) {
                // Pause audio player
                pauseSong();
                // Show video panel
                showVideoPanel(true);
                // Load YouTube video
                youtubePlayer.src = `${video.src}?autoplay=1&rel=0`;
                // Set active item
                updateActiveVideoItem(index);
            }

            // --- 5. EVENT LISTENERS ---
            
            // --- Splash Screen Logic ---
            enterBtn.addEventListener('click', startVideoTransition);
            skipIntroBtn.addEventListener('click', skipIntro);

            // When video finishes, play the intro audio
            splashVideo.addEventListener('ended', () => {
                if(hasUserInteracted) {
                    introAudio.play().catch(e => {
                        console.warn("Intro audio failed to play:", e);
                        transitionToPlayer(); // Failsafe
                    });
                }
            });
            
            // When intro audio finishes, fade to player
            introAudio.addEventListener('ended', () => {
                transitionToPlayer();
            });
            
            // --- Player Logic ---
            playPauseBtn.addEventListener('click', () => {
                if (isPlaying) pauseSong();
                else playSong();
            });
            prevBtn.addEventListener('click', prevSong);
            nextBtn.addEventListener('click', nextSong);
            audioPlayer.addEventListener('timeupdate', updateProgress);
            audioPlayer.addEventListener('ended', nextSong);
            progressBar.addEventListener('input', setProgress);
            
            linerNotesBtn.addEventListener('click', () => {
                // If video is playing, stop it and show notes.
                if (!videoPanel.classList.contains('hidden')) {
                    showVideoPanel(false);
                }
                
                // If 'About' note is showing, switch to song/album note (stays on back)
                if (currentNote === 'about') {
                    currentNote = isPlaying ? currentSongIndex : 'album';
                    updateNoteContent();
                    flipper.classList.add('is-flipped'); // Make sure it STAYS flipped
                } 
                // Otherwise, just toggle
                else {
                    // If we are about to flip TO the back, set the correct note first
                    if (!flipper.classList.contains('is-flipped')) {
                         currentNote = isPlaying ? currentSongIndex : 'album';
                         updateNoteContent();
                    }
                    flipper.classList.toggle('is-flipped');
                }
            });
            
            aboutBtn.addEventListener('click', () => {
                // If video is playing, stop it and show notes.
                if (!videoPanel.classList.contains('hidden')) {
                    showVideoPanel(false);
                }

                currentNote = 'about';
                updateNoteContent();
                flipper.classList.add('is-flipped'); // Force flip to back
            });
            
            // --- Tab Logic ---
            const tabBaseClasses = "w-1/2 p-3 text-center font-album-title tracking-wider text-lg transition-colors duration-200";
            const tabActiveClasses = "bg-red-500 text-white active";
            const tabInactiveClasses = "text-gray-400 bg-gray-700 hover:bg-gray-600 hover:text-gray-200";

            audioTab.addEventListener('click', () => {
                // Set Audio Tab to Active
                audioTab.className = `${tabBaseClasses} ${tabActiveClasses} rounded-tl-lg`;
                // Set Video Tab to Inactive
                videoTab.className = `${tabBaseClasses} ${tabInactiveClasses} rounded-tr-lg`;
                
                // Show/Hide Playlists
                playlistEl.classList.remove('hidden');
                videoPlaylistEl.classList.add('hidden');
            });
            
            videoTab.addEventListener('click', () => {
                // Set Video Tab to Active
                videoTab.className = `${tabBaseClasses} ${tabActiveClasses} rounded-tr-lg`;
                // Set Audio Tab to Inactive
                audioTab.className = `${tabBaseClasses} ${tabInactiveClasses} rounded-tl-lg`;

                // Show/Hide Playlists
                videoPlaylistEl.classList.remove('hidden');
                playlistEl.classList.add('hidden');
            });

            
            // --- Media Session Action Handlers (for truck controls) ---
            if ('mediaSession' in navigator) {
                navigator.mediaSession.setActionHandler('play', playSong);
                navigator.mediaSession.setActionHandler('pause', pauseSong);
                navigator.mediaSession.setActionHandler('previoustrack', prevSong);
                navigator.mediaSession.setActionHandler('nexttrack', nextSong);
                navigator.mediaSession.setActionHandler('seekto', (details) => {
                    audioPlayer.currentTime = details.seekTime;
                    updatePositionState();
                });
            }

            // --- 6. INITIALIZE PLAYER ---
            createPlaylist();
            createVideoPlaylist();
            loadSong(songs[currentSongIndex]);
            currentNote = 'album'; // Start with album note
            updateNoteContent(); // Show album note
            flipper.classList.remove('is-flipped'); // But show front cover
            
            
            // --- 7. PWA Service Worker Registration ---
            // Check if we're in "app" mode
            const isPwa = window.matchMedia('(display-mode: standalone)').matches;

            if (isPwa && 'serviceWorker' in navigator) {
                // --- IT'S THE APP ---
                showBeginButton();

                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful:', registration);
                        
                        // Listen for new worker installs
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New content is available!
                                    // We could show a "New version available, restart" button here
                                    console.log('New content is available, please restart the app.');
                                }
                            });
                        });
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                        // Even if SW fails, show the button
                        showBeginButton();
                    });
            } else {
                // --- IT'S THE PC (or a normal browser tab) ---
                console.log('Not in PWA mode, skipping PWA features.');
                // Just show the "Click to Begin" button
                showBeginButton();
            }
        });
    </script>
</body>
</html>


