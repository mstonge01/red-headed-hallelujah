<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Red-Headed Hallelujah</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter (sans-serif) and Staatliches (blocky, for title) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Staatliches&display=swap" rel="stylesheet">
    
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">
    <!-- Theme color for PWA -->
    <meta name="theme-color" content="#EF4444">
    
    <style>
        /* ... (All your existing styles remain the same) ... */
        body {
            font-family: 'Inter', sans-serif;
        }
        .font-album-title {
            font-family: 'Staatliches', cursive;
        }
        #playlist::-webkit-scrollbar,
        #flipper-back::-webkit-scrollbar {
            width: 8px;
        }
        #playlist::-webkit-scrollbar-track,
        #flipper-back::-webkit-scrollbar-track {
            background: #374151;
            border-radius: 10px;
        }
        #playlist::-webkit-scrollbar-thumb,
        #flipper-back::-webkit-scrollbar-thumb {
            background: #EF4444;
            border-radius: 10px;
        }
        #playlist::-webkit-scrollbar-thumb:hover,
        #flipper-back::-webkit-scrollbar-thumb:hover {
            background: #DC2626;
        }
        .playlist-item.active {
            background-color: #EF4444;
            color: #FFFFFF;
        }
        #progress-bar-container input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #EF4444;
            border-radius: 3px;
            cursor: pointer;
            margin-top: -6px;
        }
        #progress-bar-container input[type=range]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #EF4444;
            border-radius: 3px;
            cursor: pointer;
        }
        #progress-bar-container input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: #4B5563;
            outline: none;
        }
        .player-texture {
            background-color: #1F2937;
            background-image: url('https://www.transparenttextures.com/patterns/stucco.png');
        }
        .flipper-container {
            perspective: 1000px;
            padding-top: 100%;
        }
        #flipper {
            transform-style: preserve-3d;
            transition: transform 0.8s;
        }
        #flipper.is-flipped {
            transform: rotateY(180deg);
        }
        .flipper-front,
        .flipper-back {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }
        .flipper-back {
            transform: rotateY(180deg);
            background-color: #4B5563;
            background-image: url('https://www.transparenttextures.com/patterns/concrete-wall.png');
        }
        #note-body {
            white-space: pre-wrap;
        }

        /* --- NEW: Splash Screen Button/Status Styles --- */
        .splash-button {
            position: absolute;
            z-index: 60;
            background: rgba(239, 68, 68, 0.8); /* red-500 */
            color: white;
            padding: 1rem 2rem;
            font-family: 'Staatliches', cursive;
            font-size: 1.5rem;
            letter-spacing: 0.1em;
            border: 2px solid rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .splash-button:hover {
            background: rgba(220, 38, 38, 1); /* red-600 */
            border-color: white;
            transform: scale(1.05);
        }
        
        /* This is the "Checking for Updates..." text */
        #update-status {
            position: absolute;
            z-index: 60;
            color: white;
            padding: 1rem 2rem;
            font-family: 'Staatliches', cursive;
            font-size: 1.5rem;
            letter-spacing: 0.1em;
            /* Style to look like disabled button */
            background: rgba(107, 114, 128, 0.5); /* gray-500 */
            border: 2px solid rgba(255, 255, 255, 0.2);
        }


        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 15px rgba(239, 68, 68, 0); }
            50% { box-shadow: 0 0 25px rgba(239, 68, 68, 0.4), 0 0 40px rgba(239, 68, 68, 0.2); }
        }
        .is-playing-glow {
            animation: pulseGlow 2.5s infinite ease-in-out;
        }
        .album-art-container {
            position: relative;
            width: 100%;
            height: 100%;
        }
        #base-art {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-cover;
        }
        #song-art {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-cover;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        #song-art.is-visible {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-300 min-h-screen flex items-center justify-center p-4">

    <!-- Video Splash Screen -->
    <div id="splash-screen" class="fixed top-0 left-0 w-full h-full bg-gray-900 z-50 flex items-center justify-center opacity-100 transition-opacity duration-1000">
        
        <!-- NEW: Update Status (This is your "progress bar") -->
        <div id="update-status" class="splash-button" style="display: none;">Checking for Updates...</div>

        <!-- NEW: "Click to Begin" Button (starts hidden) -->
        <button id="enter-btn" class="splash-button" style="display: none;">Click to Begin</button>
        
        <!-- UPDATED: REMOVED 'autoplay' -->
        <video id="splash-video" class="max-w-full max-h-full object-contain" playsinline preload="auto">
            <source src="paint-video.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    </div>

    <!-- ... (The rest of your HTML player container remains identical) ... -->
    <div id="player-container" class="w-full max-w-4xl opacity-0 transition-opacity duration-1000">
        <div class="player-texture shadow-2xl overflow-hidden flex flex-col md:flex-row">
            <div class="w-full md:w-1/2 lg:w-5/12 flex-shrink-0 flex flex-col">
                <div class="relative w-full flipper-container"> 
                    <div id="flipper" class="absolute top-0 left-0 w-full h-full">
                        <div class="flipper-front absolute w-full h-full">
                            <div class="album-art-container">
                                <img id="base-art" src="cover.jpg.jpg" alt="Album Art for Red-Headed Hallelujah">
                                <img id="song-art" src="" alt="">
                            </div>
                        </div>
                        <div id="flipper-back" class="flipper-back absolute w-full h-full p-6 overflow-y-auto">
                            <h3 id="note-title" class="font-album-title text-3xl text-yellow-400 tracking-wider mb-4"></h3>
                            <p id="note-body" class="text-gray-200"></p>
                        </div>
                    </div>
                </div>
                <button id="liner-notes-btn" class="w-full bg-red-500 text-white font-album-title tracking-wider text-lg p-3 hover:bg-red-600 transition-colors duration-200">
                    Liner Notes
                </button>
            </div>
            <div class="w-full md:w-1/2 lg:w-7/12 p-6 flex flex-col justify-between">
                <div class="mb-4">
                    <p class="text-lg uppercase tracking-widest text-red-500 font-album-title">Now Playing</p>
                    <h2 id="song-title" class="text-3xl text-yellow-400 truncate font-album-title tracking-wider">Song Title</h2>
                    <h3 id="song-artist" class="text-lg text-gray-300">A mstonge01 Project</h3>
                </div>
                <div class="mb-4">
                    <div id="progress-bar-container" class="mb-3">
                         <input type="range" id="progress-bar" class="w-full h-1 bg-gray-700 rounded-lg cursor-pointer" value="0" min="0" max="100">
                    </div>
                    <div class="flex justify-between text-sm text-gray-400">
                        <span id="current-time">0:00</span>
                        <span id="duration-time">0:00</span>
                    </div>
                    <div class="flex justify-center items-center space-x-6 mt-4">
                        <button id="prev-btn" class="text-gray-400 hover:text-red-500 transition-colors duration-200">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M8.445 14.832A1 1 0 0010 14.03V5.969a1 1 0 00-1.555-.832L4.12 9.168a1 1 0 000 1.664l4.325 4zM10.879 9.168a1 1 0 000 1.664l4.325 4A1 1 0 0017 14.03V5.969a1 1 0 00-1.555-.832l-4.325 4z"/></svg>
                        </button>
                        <button id="play-pause-btn" class="w-16 h-16 bg-red-500 text-white rounded-full flex items-center justify-center text-2xl hover:bg-red-600 transition-colors duration-200 shadow-lg">
                            <svg id="play-icon" class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8.002v3.996a1 1 0 001.555.832l3.197-1.998a1 1 0 000-1.664l-3.197-1.998z" clip-rule="evenodd"/></svg>
                            <svg id="pause-icon" class="w-8 h-8 hidden" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h1a1 1 0 001-1V8a1 1 0 00-1-1H8zm5 0a1 1 0 00-1 1v4a1 1 0 001 1h1a1 1 0 001-1V8a1 1 0 00-1-1h-1z" clip-rule="evenodd"/></svg>
                        </button>
                        <button id="next-btn" class="text-gray-400 hover:text-red-500 transition-colors duration-200">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M4.555 5.168A1 1 0 003 5.969v8.062a1 1 0 001.555.832l4.325-4a1 1 0 000-1.664l-4.325-4zM10.879 5.168A1 1 0 009.324 5.97v8.062a1 1 0 001.555.832l4.325-4a1 1 0 000-1.664l-4.325-4z"/></svg>
                        </button>
                    </div>
                </div>
                <div class="flex-grow min-h-0">
                    <div id="playlist" class="h-48 md:h-full max-h-48 lg:max-h-56 overflow-y-auto pr-2">
                        <!-- Playlist items will be injected here by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <audio id="audio-player"></audio>
    <audio id="intro-audio" src="hallelujah-intro.mp3" preload="auto"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 1. SONG DATABASE ---
            const songs = [
                // ... (All 12 songs are here, truncated for brevity)
                { 
                    title: "The Crimson Tide", 
                    src: "01-the-crimson-tide.mp3",
                    image_src: "01-the-crimson-tide-art.png",
                    note: `The Crimson Tide is a driving, high-energy rock anthem...`
                },
                { 
                    title: "Real Women", 
                    src: "02-real-women.mp3",
                    image_src: "02-real-women-art.png",
                    note: `This is a fist-pumping, no-nonsense track...`
                },
                { 
                    title: "Red-Headed Hallelujah", 
                    src: "03-red-headed-hallelujah.mp3",
                    image_src: "03-red-headed-hallelujah-art.png",
                    note: `Red-Headed Hallelujah serves as the album’s emotional centerpiece...`
                },
                { 
                    title: "The Good Stuff", 
                    src: "04-the_good_stuff.mp3",
                    image_src: "04-the_good_stuff-art.png",
                    note: `This is a mid-tempo, reflective song...`
                },
                { 
                    title: "Zero Degree Beach", 
                    src: "05-zero-degree-beach.mp3",
                    image_src: "05-zero-degree-beach-art.png",
                    note: `Zero-Degree Beach is a moody, atmospheric track...`
                },
                { 
                    title: "Caps", 
                    src: "06-caps.mp3",
                    image_src: "06-caps-art.png",
                    note: `This is the album’s most direct and playfully sensual love song...`
                },
                { 
                    title: "Interrupted", 
                    src: "07-interrupted.mp3",
                    image_src: "07-interrupted-art.png",
                    note: `Interrupted captures the chaotic but relatable comedy...`
                },
                { 
                    title: "Cinnamon Serenade", 
                    src: "08-cinnamon-serenade.mp3",
                    image_src: "08-cinnamon-serenade-art.png",
                    note: `This track is a rugged, deeply romantic look...`
                },
                { 
                    title: "Golden Devotion", 
                    src: "09-golden-devotion.mp3",
                    image_src: "09-golden-devotion-art.png",
                    note: `Golden Devotion is a sun-drenched, devotional track...`
                },
                { 
                    title: "Natural Magic", 
                    src: "10-natural-magic.mp3",
                    image_src: "10-natural-magic-art.png",
                    note: `The album closes with Natural Magic, a tender, observational song...`
                },
                { 
                    title: "Red-Headed Hallelujah (Guitar)", 
                    src: "11-red-headed-hallelujah-guitar.mp3",
                    image_src: "11-red-headed-hallelujah-guitar-art.png",
                    note: `This cover is a soaring power ballad...`
                },
                { 
                    title: "Red-Headed Hallelujah (Piano)", 
                    src: "12-red-headed-hallelujah-piano.mp3",
                    image_src: "12-red-headed-hallelujah-piano-art.png",
                    note: `Serving as a beautiful, reflective denouement...`
                },
            ];
            const artistName = "A mstonge01 Project";
            const albumTitle = "for Rebecca";
            const albumNote = ``;
            const albumName = "Red-Headed Hallelujah";

            // --- 2. DOM ELEMENT REFERENCES ---
            const splashScreen = document.getElementById('splash-screen');
            const splashVideo = document.getElementById('splash-video');
            const enterBtn = document.getElementById('enter-btn');
            const updateStatusEl = document.getElementById('update-status'); // NEW
            
            const playerContainer = document.getElementById('player-container');
            const audioPlayer = document.getElementById('audio-player');
            const introAudio = document.getElementById('intro-audio');
            // ... (all other player element refs)
            const songTitleEl = document.getElementById('song-title');
            const songArtistEl = document.getElementById('song-artist');
            const playlistEl = document.getElementById('playlist');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const progressBar = document.getElementById('progress-bar');
            const currentTimeEl = document.getElementById('current-time');
            const durationTimeEl = document.getElementById('duration-time');
            const linerNotesBtn = document.getElementById('liner-notes-btn');
            const flipper = document.getElementById('flipper');
            const noteTitleEl = document.getElementById('note-title');
            const noteBodyEl = document.getElementById('note-body');
            const songArtEl = document.getElementById('song-art');
            const mainPlayerDiv = document.querySelector('.player-texture');


            // --- 3. PLAYER STATE ---
            let currentSongIndex = 0;
            let isPlaying = false;
            let hasUserInteracted = false;

            // --- 4. FUNCTIONS ---

            // NEW: Function to show the "Click to Begin" button
            function showBeginButton() {
                updateStatusEl.style.display = 'none';
                enterBtn.textContent = 'Click to Begin';
                enterBtn.style.display = 'block';
                enterBtn.disabled = false;
            }

            function startVideoTransition() {
                if(hasUserInteracted) return;
                hasUserInteracted = true;
                
                // Only send cache message if we're in PWA mode
                if (window.matchMedia('(display-mode: standalone)').matches && 'serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    console.log('Sending cache-content message to SW');
                    navigator.serviceWorker.controller.postMessage({ action: 'cache-content' });
                }
                
                introAudio.load();
                enterBtn.style.display = 'none';

                // Play the video. This is now safe.
                splashVideo.play().then(() => {
                    // Video started!
                }).catch(error => {
                    console.warn("Video play failed even after click:", error);
                    transitionToPlayer(); // Failsafe
                });
            }

            function transitionToPlayer() {
                setTimeout(() => {
                    splashScreen.style.opacity = '0';
                    playerContainer.style.opacity = '1';
                    setTimeout(() => {
                        splashScreen.style.display = 'none';
                    }, 1000);
                }, 1000); // 1-second pause
            }
            
            // ... (All other player functions remain the same)
            function updatePositionState() {
                if ('mediaSession' in navigator && navigator.mediaSession.metadata) {
                    const { duration, currentTime } = audioPlayer;
                    if (duration && isFinite(duration)) {
                        navigator.mediaSession.setPositionState({
                            duration: duration,
                            playbackRate: audioPlayer.playbackRate,
                            position: currentTime
                        });
                    }
                }
            }
            
            function updateMediaSession(song) {
                if ('mediaSession' in navigator) {
                    if (song) {
                        navigator.mediaSession.metadata = new MediaMetadata({
                            title: song.title,
                            artist: artistName,
                            album: albumName,
                            artwork: [
                                { src: song.image_src, sizes: '512x512', type: 'image/png' }
                            ]
                        });
                        navigator.mediaSession.playbackState = "playing";
                    } else {
                        if (navigator.mediaSession.metadata) {
                             navigator.mediaSession.playbackState = "paused";
                        }
                    }
                    updatePositionState();
                }
            }
            
            function updateLinerNotes(index) {
                if (index === null) {
                    noteTitleEl.textContent = albumTitle;
                    noteBodyEl.textContent = albumNote;
                } else {
                    const song = songs[index];
                    noteTitleEl.textContent = song.title;
                    noteBodyEl.textContent = song.note;
                }
            }

            function loadSong(song) {
                songTitleEl.textContent = song.title;
                songArtistEl.textContent = artistName;
                audioPlayer.src = song.src;
                songArtEl.src = song.image_src;
                songArtEl.classList.remove('is-visible');
                flipper.classList.remove('is-flipped');
                updateActivePlaylistItem();
            }

            function playSong() {
                if (!audioPlayer.src || audioPlayer.src.endsWith('index.html')) {
                    loadSong(songs[currentSongIndex]);
                }
                isPlaying = true;
                audioPlayer.play();
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
                songArtEl.classList.add('is-visible');
                mainPlayerDiv.classList.add('is-playing-glow');
                updateLinerNotes(currentSongIndex);
                updateMediaSession(songs[currentSongIndex]);
            }

            function pauseSong() {
                isPlaying = false;
                audioPlayer.pause();
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                songArtEl.classList.remove('is-visible');
                mainPlayerDiv.classList.remove('is-playing-glow');
                updateLinerNotes(null);
                updateMediaSession(null);
            }

            function prevSong() {
                currentSongIndex--;
                if (currentSongIndex < 0) currentSongIndex = songs.length - 1;
                loadSong(songs[currentSongIndex]);
                if (isPlaying) playSong();
            }

            function nextSong() {
                currentSongIndex++;
                if (currentSongIndex > songs.length - 1) currentSongIndex = 0;
                loadSong(songs[currentSongIndex]);
                if (isPlaying) playSong();
            }

            function updateProgress(e) {
                const { duration, currentTime } = e.srcElement;
                if (duration) {
                    const progressPercent = (currentTime / duration) * 100;
                    progressBar.value = progressPercent;
                    durationTimeEl.textContent = formatTime(duration);
                    currentTimeEl.textContent = formatTime(currentTime);
                    updatePositionState();
                }
            }

            function formatTime(seconds) {
                if (isNaN(seconds)) return "0:00";
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            }

            function setProgress() {
                const duration = audioPlayer.duration;
                if (duration) {
                     audioPlayer.currentTime = (progressBar.value / 100) * duration;
                     updatePositionState();
                }
            }
            
            function updateActivePlaylistItem() {
                const items = document.querySelectorAll('.playlist-item');
                items.forEach((item, index) => {
                    if (index === currentSongIndex) {
                        item.classList.add('active');
                        item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    } else {
                        item.classList.remove('active');
                    }
                });
            }

            function createPlaylist() {
                songs.forEach((song, index) => {
                    const item = document.createElement('div');
                    item.classList.add('playlist-item', 'p-3', 'rounded-lg', 'cursor-pointer', 'hover:bg-gray-700', 'transition-colors', 'duration-200');
                    item.innerHTML = `
                        <p class="font-album-title tracking-wider truncate">${song.title}</p>
                        <p class="text-sm text-gray-400">${artistName}</p>
                    `;
                    item.addEventListener('click', () => {
                        currentSongIndex = index;
                        loadSong(song);
                        playSong();
                    });
                    playlistEl.appendChild(item);
                });
            }

            // --- 5. EVENT LISTENERS ---
            
            // --- Splash Screen Logic ---
            enterBtn.addEventListener('click', startVideoTransition);

            splashVideo.addEventListener('ended', () => {
                if(hasUserInteracted) {
                    introAudio.play().catch(e => {
                        console.warn("Intro audio failed to play:", e);
                        transitionToPlayer(); 
                    });
                }
            });
            
            introAudio.addEventListener('ended', () => {
                transitionToPlayer();
            });
            
            // --- Player Logic ---
            playPauseBtn.addEventListener('click', () => {
                if (isPlaying) pauseSong();
                else playSong();
            });
            prevBtn.addEventListener('click', prevSong);
            nextBtn.addEventListener('click', nextSong);
            audioPlayer.addEventListener('timeupdate', updateProgress);
            audioPlayer.addEventListener('ended', nextSong);
            progressBar.addEventListener('input', setProgress);
            linerNotesBtn.addEventListener('click', () => {
                flipper.classList.toggle('is-flipped');
            });
            
            // --- Media Session Action Handlers ---
            if ('mediaSession' in navigator) {
                navigator.mediaSession.setActionHandler('play', playSong);
                navigator.mediaSession.setActionHandler('pause', pauseSong);
                navigator.mediaSession.setActionHandler('previoustrack', prevSong);
                navigator.mediaSession.setActionHandler('nexttrack', nextSong);
                navigator.mediaSession.setActionHandler('seekto', (details) => {
                    audioPlayer.currentTime = details.seekTime;
                    updatePositionState();
                });
            }

            // --- 6. INITIALIZE PLAYER ---
            createPlaylist();
            loadSong(songs[currentSongIndex]);
            updateLinerNotes(null);
            
            // --- 7. PWA Service Worker Registration ---
            // UPDATED: This is the new logic to differentiate PC vs. App
            
            // Check if it's running as an installed PWA (app mode)
            const isPwa = window.matchMedia('(display-mode: standalone)').matches;

            if (isPwa && 'serviceWorker' in navigator) {
                // --- IT'S THE APP ---
                // Show "Checking for Updates..."
                updateStatusEl.style.display = 'block';

                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful:', registration);
                        // The SW is installed and running.
                        // The update check is complete.
                        // Show the "Click to Begin" button.
                        showBeginButton();
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                        // SW failed, but let the user in anyway.
                        showBeginButton();
                    });
            } else {
                // --- IT'S THE PC (or a normal browser tab) ---
                // Just show the "Click to Begin" button immediately.
                console.log('Not in PWA mode, skipping update check.');
                showBeginButton();
            }
        });
    </script>
</body>
</html>


