<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Red-Headed Hallelujah</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter (sans-serif) and Staatliches (blocky, for title) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Staatliches&display=swap" rel="stylesheet">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json?v=3"> <!-- Incremented manifest version -->
    <meta name="theme-color" content="#EF4444">
    
    <style>
        /* Custom styles to match the album art aesthetic */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Using 'Staatliches' for the main album title to mimic the cover font */
        .font-album-title {
            font-family: 'Staatliches', cursive;
        }

        /* Custom scrollbar for playlists */
        #playlist::-webkit-scrollbar,
        #video-playlist::-webkit-scrollbar,
        #flipper-back::-webkit-scrollbar {
            width: 8px;
        }
        #playlist::-webkit-scrollbar-track,
        #video-playlist::-webkit-scrollbar-track,
        #flipper-back::-webkit-scrollbar-track {
            background: #374151; /* gray-700 */
            border-radius: 10px;
        }
        #playlist::-webkit-scrollbar-thumb,
        #video-playlist::-webkit-scrollbar-thumb,
        #flipper-back::-webkit-scrollbar-thumb {
            background: #EF4444; /* red-500 */
            border-radius: 10px;
        }
        #playlist::-webkit-scrollbar-thumb:hover,
        #video-playlist::-webkit-scrollbar-thumb:hover,
        #flipper-back::-webkit-scrollbar-thumb:hover {
            background: #DC2626; /* red-600 */
        }

        /* Style for the currently active playlist item */
        .playlist-item.active {
            background-color: #EF4444; /* red-500 */
            color: #FFFFFF; /* white */
        }

        /* Custom style for the progress bar slider thumb */
        #progress-bar-container input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #EF4444; /* red-500 */
            border-radius: 3px;
            cursor: pointer;
            margin-top: -6px; /* Center the thumb on the track */
        }
        
        #progress-bar-container input[type=range]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #EF4444; /* red-500 */
            border-radius: 3px;
            cursor: pointer;
        }

        /* Custom style for the progress bar track */
        #progress-bar-container input[type=range] {
             -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: #4B5563; /* gray-600 */
            outline: none;
        }

        /* Class for the player texture */
        .player-texture {
            background-color: #1F2937; /* This is Tailwind's bg-gray-800 */
            background-image: url('https://www.transparenttextures.com/patterns/stucco.png');
        }
        
        /* 'Live Glow' Pulse Animation */
        @keyframes pulseGlow {
            0%, 100% {
                box-shadow: 0 0 10px rgba(239, 68, 68, 0.4), 0 0 12px rgba(239, 68, 68, 0.3);
            }
            50% {
                box-shadow: 0 0 16px rgba(239, 68, 68, 0.7), 0 0 20px rgba(239, 68, 68, 0.5);
            }
        }
        
        /* --- Flipper Styles --- */
        .flipper-container {
            perspective: 1000px;
            padding-top: 100%; /* Creates a 1:1 aspect ratio */
        }
        #flipper {
            transform-style: preserve-3d;
            transition: transform 0.8s;
        }
        #flipper.is-flipped {
            transform: rotateY(180deg);
        }
        .flipper-front,
        .flipper-back {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }
        #flipper-back {
            transform: rotateY(180deg);
            background-color: #4B5563; /* gray-600 */
            background-image: url('https://www.transparenttextures.com/patterns/concrete-wall.png');
        }
        #note-body {
            white-space: pre-wrap;
        }
        
        /* --- Song Art Crossfade --- */
        #song-art {
            transition: opacity 0.5s ease-in-out;
            opacity: 0;
        }
        #song-art.is-visible {
            opacity: 1;
        }

        /* --- Splash Screen Styles --- */
        #enter-btn {
            background: rgba(239, 68, 68, 0.8); /* red-500 with 80% opacity */
            border: 2px solid rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
        }
        #enter-btn:hover {
            background: rgba(220, 38, 38, 1); /* red-600 */
            border-color: white;
            transform: scale(1.05);
        }
        #enter-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
        #update-status {
            background: rgba(17, 24, 39, 0.8); /* gray-900 with 80% opacity */
        }

        /* --- Skip Intro Button Style --- */
        #skip-intro-btn {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        #skip-intro-btn:hover {
            background: rgba(0, 0, 0, 0.75);
            border-color: rgba(255, 255, 255, 0.7);
        }
       
    </style>
</head>
<body class="bg-gray-900 text-gray-300 min-h-screen flex items-center justify-center p-4">

    <!-- Video Splash Screen -->
    <div id="splash-screen" class="fixed top-0 left-0 w-full h-full bg-gray-900 z-50 flex items-center justify-center opacity-100 transition-opacity duration-1000">
        
        <!-- Video: NO Autoplay -->
        <video id="splash-video" class="max-w-full max-h-full object-contain" preload="auto" playsinline>
            <source src="paint-video.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        
        <!-- Status / Button Container -->
        <div class="absolute inset-0 flex items-center justify-center">
             <!-- "Checking for Updates..." - Only shown on PWA app load -->
            <div id="update-status" class="hidden p-4 rounded-lg text-white font-album-title text-xl tracking-wider">
                Checking for Updates...
            </div>

            <!-- "Click to Begin" Button - Hidden until check is done -->
            <button id="enter-btn" class="hidden z-60 text-white p-4 px-8 font-album-title text-xl tracking-wider rounded-lg" disabled>
                Click to Begin
            </button>
        </div>

        <!-- Skip Intro Button -->
        <button id="skip-intro-btn" class="hidden absolute bottom-5 left-1/2 -translate-x-1/2 z-60 text-white px-4 py-2 rounded-lg text-sm hover:bg-black/75 transition">
            Skip Intro
        </button>
    </div>

    <!-- Main Player Container (starts invisible) -->
    <div id="player-container" class="w-full max-w-4xl opacity-0 transition-opacity duration-1000">
        
        <!-- Player Container -->
        <div class="player-texture shadow-2xl overflow-hidden flex flex-col md:flex-row">
            
            <!-- Left Side: Album Artwork & Liner Notes -->
            <div class="w-full md:w-1/2 flex-shrink-0 flex flex-col">
                <!-- Flipper container (1:1 aspect ratio) -->
                <div class="relative w-full flipper-container"> 
                    
                    <!-- Flipper (Art/Notes) -->
                    <div id="flipper" class="absolute top-0 left-0 w-full h-full">
                        <!-- FRONT (Album Art) -->
                        <div class="flipper-front absolute w-full h-full">
                            <!-- Main Album Art -->
                            <img src="cover.png" alt="Album Art for Red-Headed Hallelujah" class="w-full h-full object-cover">
                            <!-- Song-Specific Art (fades in) -->
                            <img id="song-art" src="" alt="Song-specific art" class="absolute top-0 left-0 w-full h-full object-cover">
                        </div>
                        <!-- BACK (Liner Notes) -->
                        <div id="flipper-back" class="flipper-back absolute w-full h-full p-6 overflow-y-auto flex flex-col">
                            <div class="flex-grow">
                                <h3 id="note-title" class="font-album-title text-3xl text-yellow-400 tracking-wider mb-4"></h3>
                                <p id="note-body" class="text-gray-200"></p>
                            </div>
                        </div>
                    </div>

                    <!-- NEW: Video Panel (Hidden on top of the flipper) -->
                    <div id="video-panel" class="absolute top-0 left-0 w-full h-full hidden bg-black">
                        <iframe id="video-player-iframe" 
                            src="" 
                            class="w-full h-full"
                            title="YouTube video player" 
                            frameborder="0" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                            allowfullscreen>
                        </iframe>
                    </div>

                </div> <!-- End of flipper-container -->

                <!-- Liner Notes Button -->
                <button id="liner-notes-btn" class="w-full bg-red-500 text-white font-album-title tracking-wider text-lg p-3 hover:bg-red-600 transition-colors duration-200">
                    Liner Notes
                </button>
                <!-- About Button -->
                <button id="about-btn" class="w-full bg-gray-600 text-white font-album-title tracking-wider text-lg p-3 hover:bg-gray-500 transition-colors duration-200">
                    About This App
                </button>
            </div>

            <!-- Right Side: Info, Controls, Playlist -->
            <div class="w-full md:w-1/2 p-6 flex flex-col justify-between">
                
                <!-- Top-Right: Current Song Info -->
                <div class="mb-4">
                    <p class="text-lg uppercase tracking-widest text-red-500 font-album-title">Now Playing</p>
                    <h2 id="song-title" class="text-3xl text-yellow-400 truncate font-album-title tracking-wider">Song Title</h2>
                    <h3 id="song-artist" class="text-lg text-gray-300">A mstonge01 Project</h3>
                </div>

                <!-- Middle-Right: Controls & Progress Bar -->
                <div class="mb-4">
                    <!-- Progress Bar -->
                    <div id="progress-bar-container" class="mb-3">
                         <input type="range" id="progress-bar" class="w-full h-1 bg-gray-700 rounded-lg cursor-pointer" value="0" min="0" max="100">
                    </div>
                    <!-- Time Display -->
                    <div class="flex justify-between text-sm text-gray-400">
                        <span id="current-time">0:00</span>
                        <span id="duration-time">0:00</span>
                    </div>

                    <!-- Controls -->
                    <div class="flex justify-center items-center space-x-6 mt-4">
                        <!-- Previous Button -->
                        <button id="prev-btn" class="text-gray-400 hover:text-red-500 transition-colors duration-200">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M8.445 14.832A1 1 0 0010 14.03V5.969a1 1 0 00-1.555-.832L4.12 9.168a1 1 0 000 1.664l4.325 4zM10.879 9.168a1 1 0 000 1.664l4.325 4A1 1 0 0017 14.03V5.969a1 1 0 00-1.555-.832l-4.325 4z"/></svg>
                        </button>
                        <!-- Play/Pause Button -->
                        <button id="play-pause-btn" class="w-16 h-16 bg-red-500 text-white rounded-full flex items-center justify-center text-2xl hover:bg-red-600 transition-colors duration-200 shadow-lg">
                            <!-- Play Icon -->
                            <svg id="play-icon" class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8.002v3.996a1 1 0 001.555.832l3.197-1.998a1 1 0 000-1.664l-3.197-1.998z" clip-rule="evenodd"/></svg>
                            <!-- Pause Icon (hidden by default) -->
                            <svg id="pause-icon" class="w-8 h-8 hidden" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h1a1 1 0 001-1V8a1 1 0 00-1-1H8zm5 0a1 1 0 00-1 1v4a1 1 0 001 1h1a1 1 0 001-1V8a1 1 0 00-1-1h-1z" clip-rule="evenodd"/></svg>
                        </button>
                        <!-- Next Button -->
                        <button id="next-btn" class="text-gray-400 hover:text-red-500 transition-colors duration-200">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M4.555 5.168A1 1 0 003 5.969v8.062a1 1 0 001.555.832l4.325-4a1 1 0 000-1.664l-4.325-4zM10.879 5.168A1 1 0 009.324 5.97v8.062a1 1 0 001.555.832l4.325-4a1 1 0 000-1.664l-4.325-4z"/></svg>
                        </button>
                    </div>
                </div>
                
                <!-- Bottom-Right: Tabs & Playlists -->
                <div class="flex-grow min-h-0 flex flex-col">
                    <!-- Tab Buttons -->
                    <div class="flex border-b border-gray-700 mb-2">
                        <button id="audio-tab-btn" class="flex-1 py-2 px-4 font-album-title tracking-wider text-lg bg-gray-700 text-white rounded-t-md">
                            Audio
                        </button>
                        <button id="video-tab-btn" class="flex-1 py-2 px-4 font-album-title tracking-wider text-lg text-gray-400 hover:bg-gray-700 hover:text-white transition-colors rounded-t-md">
                            Video
                        </button>
                    </div>

                    <!-- 
                        *** SCROLL FIX IS HERE ***
                        This container now has h-80 (20rem) for mobile height
                        and md:h-auto to allow it to fill space on desktop/tablet.
                    -->
                    <div class="flex-grow min-h-0 relative h-80 md:h-auto">
                        <!-- Audio Playlist -->
                        <div id="playlist" class="absolute inset-0 overflow-y-auto pr-2">
                            <!-- Playlist items will be injected here by JavaScript -->
                        </div>
                        <!-- Video Playlist -->
                        <div id="video-playlist" class="absolute inset-0 overflow-y-auto pr-2 hidden">
                            <!-- Video items will be injected here by JavaScript -->
                        </div>
                    </div>
                </div>


                <!-- Update Button (PWA Only) - REMOVED -->
                <div id="update-container" class="hidden text-center mt-4 p-2 border-t border-gray-700" style="display: none;">
                    <!-- Removed update button -->
                </div>
            </div>
        </div>
    </div>

    <!-- The actual audio element, hidden from view -->
    <audio id="audio-player"></audio>
    <audio id="intro-audio" src="hallelujah-intro.mp3" preload="auto"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 1. DATABASES ---
            const songs = [
                { 
                    title: "Intro", 
                    src: "01-intro.mp3",
                    image_src: "01-intro-art.png",
                    note: ``
                },
                { 
                    title: "The Crimson Tide", 
                    src: "02-the-crimson-tide.mp3",
                    image_src: "02-the-crimson-tide-art.png",
                    note: ``
                },
                { 
                    title: "Real Women", 
                    src: "03-real-women.mp3",
                    image_src: "03-real-women-art.png",
                    note: ``
                },
                { 
                    title: "Red-Headed Hallelujah", 
                    src: "04-red-headed-hallelujah.mp3",
                    image_src: "04-red-headed-hallelujah-art.png",
                    note: ``
                },
                { 
                    title: "The Good Stuff", 
                    src: "05-the_good_stuff.mp3",
                    image_src: "05-the_good_stuff-art.png",
                    note: ``
                },
                { 
                    title: "Zero Degree Beach", 
                    src: "06-zero-degree-beach.mp3",
                    image_src: "06-zero-degree-beach-art.png",
                    note: ``
                },
                { 
                    title: "Caps", 
                    src: "07-caps.mp3",
                    image_src: "07-caps-art.png",
                    note: ``
                },
                { 
                    title: "Interrupted", 
                    src: "08-interrupted.mp3",
                    image_src: "08-interrupted-art.png",
                    note: ``
                },
                { 
                    title: "Cinnamon Serenade", 
                    src: "09-cinnamon-serenade.mp3",
                    image_src: "09-cinnamon-serenade-art.png",
                    note: ``
                },
                { 
                    title: "Golden Devotion", 
                    src: "10-golden-devotion.mp3",
                    image_src: "10-golden-devotion-art.png",
                    note: ``
                },
                { 
                    title: "Natural Magic", 
                    src: "11-natural-magic.mp3",
                    image_src: "11-natural-magic-art.png",
                    note: ``
                },
                { 
                    title: "Outro", 
                    src: "12-outro.mp3",
                    image_src: "12-outro-art.png",
                    note: ``
                },
                { 
                    title: "[Bonus Track] Red-Headed Hallelujah (Guitar)", 
                    src: "13-red-headed-hallelujah-guitar.mp3",
                    image_src: "13-red-headed-hallelujah-guitar-art.png",
                    note: ``
                },
                { 
                    title: "[Bonus Track] Red-Headed Hallelujah (Piano)", 
                    src: "14-red-headed-hallelujah-piano.mp3",
                    image_src: "14-red-headed-hallelujah-piano-art.png",
                    note: ``
                }
            ];

            const videos = [
                {
                    title: "Red-Headed Hallelujah",
                    src: "https://www.youtube.com/embed/UDf9TQ6QDsc",
                    thumbnail: "04-red-headed-hallelujah-art.png" // Updated thumbnail to match new track #
                },
                {
                    title: "Natural Magic",
                    src: "https://www.youtube.com/embed/-zrljNrYX4A",
                    thumbnail: "11-natural-magic-art.png" // Updated thumbnail to match new track #
                }
                // Add more videos here as you make them
            ];

            const artistName = "A mstonge01 Project";
            const albumTitle = "Red-Headed Hallelujah";
            const albumNote = ``; // Blanked out as requested
            const albumName = "Red-Headed Hallelujah"; // Kept for MediaSession

            
            // --- 2. DOM ELEMENT REFERENCES ---
            const splashScreen = document.getElementById('splash-screen');
            const splashVideo = document.getElementById('splash-video');
            const enterBtn = document.getElementById('enter-btn');
            const skipIntroBtn = document.getElementById('skip-intro-btn');
            const updateStatusEl = document.getElementById('update-status'); // "Checking for Updates..." message
            const playerContainer = document.getElementById('player-container');
            const audioPlayer = document.getElementById('audio-player');
            const introAudio = document.getElementById('intro-audio');
            const songTitleEl = document.getElementById('song-title');
            const songArtistEl = document.getElementById('song-artist');
            
            const playPauseBtn = document.getElementById('play-pause-btn');
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const progressBar = document.getElementById('progress-bar');
            const currentTimeEl = document.getElementById('current-time');
            const durationTimeEl = document.getElementById('duration-time');
            const linerNotesBtn = document.getElementById('liner-notes-btn');
            const flipper = document.getElementById('flipper');
            const noteTitleEl = document.getElementById('note-title');
            const noteBodyEl = document.getElementById('note-body');
            const songArtEl = document.getElementById('song-art');
            const mainPlayerDiv = document.querySelector('.player-texture');
            
            // "About" Button
            const aboutBtn = document.getElementById('about-btn');

            // Video & Tab Elements
            const audioTabBtn = document.getElementById('audio-tab-btn');
            const videoTabBtn = document.getElementById('video-tab-btn');
            const playlistEl = document.getElementById('playlist');
            const videoPlaylistEl = document.getElementById('video-playlist');
            
            // *** NEW IN-PLAYER VIDEO REFS ***
            const videoPanel = document.getElementById('video-panel');
            const videoPlayerIframe = document.getElementById('video-player-iframe');


            // --- 3. PLAYER STATE ---
            let currentSongIndex = 0;
            let isPlaying = false;
            let hasUserInteracted = false;
            let isVideoPlaying = false; // NEW state to track video

            // --- 4. FUNCTIONS ---

            // About Text
            const aboutTitle = "About Red-Headed Hallelujah";
            const aboutText = `Welcome to Red-Headed Hallelujah, a digital music experience that is part concept album, part street-art gallery, and part AI-assisted love letter. This project was conceived and directed by mstonge01 as a dedicated gift to his wife, Rebecca, blending personal storytelling with cutting-edge technology.<br><br>This isn't just a website. It's a custom-built Progressive Web App (PWA), designed from the ground up to work perfectly on any device, from a desktop browser to a mobile phone. When installed, it functions as a complete, offline-first application. The app shell loads instantly, while the entire 12-track album and its corresponding artwork are cached in the background, allowing for a seamless, high-fidelity listening experience anywhere, with or without an internet connection.<br><br>The player is deeply integrated with native Media Session controls, meaning the album's art, titles, and playback can be managed directly from your phone's lock screen or your car's dashboard—a testament to its technical polish.<br><br><b class="text-yellow-400 text-lg">The Concept: A Graffiti Tribute</b><br><br>The album's visual identity is rooted in the raw, authentic aesthetic of urban stencil art. The cover and all accompanying track images were created in this high-contrast style, depicting the "Red-Headed Hallelujah" herself in various moments and personas.<br><br>Like a series of tributes painted on a weathered concrete wall, each image tells a story. You'll find a defiant driver in a doorless Jeep for "Real Women," a saint-like figure bathed in holy light for the title track, and a tender portrait of motherhood for "Natural Magic."<br><br>A central feature of this site is the Liner Notes button. Click it, and the artwork performs a 3D flip, revealing the story and lyrics behind each song, much like discovering a hidden message on the back of a physical record sleeve.<br><br><b class="text-yellow-400 text-lg">The Music: The "Red-Headed Rock" Aesthetic</b><br><br>Musically, Red-Headed Hallelujah is a high-energy "Red-Headed Rock" album at its core, but it masterfully explores the full spectrum of a life lived together. While generated with the assistance of AI, each track was painstakingly directed, with custom lyrics and styling to create a cohesive and deeply personal narrative.<br><br>The album opens with the driving, dangerous hard rock of "The Crimson Tide," a symbolic tale of a siren-like mermaid, before moving into the gritty, fuzzed-out blues-rock defiance of "Real Women."<br><br>The experience flows from chaotic, comedic pop-punk ("Interrupted") and playful funk-rock ("Caps") to moments of profound tenderness, like the intimate acoustic folk of "Natural Magic." The album hits its emotional peak with the soaring, choir-backed anthem "Red-Headed Hallelujah" and the rugged, soulful southern rock ballad "Cinnamon Serenade"—a raw ode to love's less-than-glamorous, unconditional moments.<br><br>This is a technical and artistic creation, a digital monument to a real-world muse. Enjoy the experience.`;
            
            // This function now just shows the "Click to Begin" button.
            // It's called after the PWA check (if any) is complete.
            function showBeginButton() {
                updateStatusEl.style.display = 'none'; // Hide "Checking for Updates..."
                enterBtn.textContent = 'Click to Begin';
                enterBtn.style.display = 'block'; // Show the button
                enterBtn.disabled = false;
            }

            // This function handles the intro video and audio sequence
            function startVideoTransition() {
                if(hasUserInteracted) return;
                hasUserInteracted = true;
                
                // Tell the service worker to start caching songs in the background (if it's the app)
                if (window.matchMedia('(display-mode: standalone)').matches && 'serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    console.log('Sending cache-content message to SW');
                    navigator.serviceWorker.controller.postMessage({ action: 'cache-content' });
                }
                
                introAudio.load(); // Preload the intro audio
                enterBtn.style.display = 'none'; // Hide the "Click to Begin" button
                skipIntroBtn.classList.remove('hidden'); // Show the "Skip Intro" button

                // Manually play the video (no autoplay)
                splashVideo.play().then(() => {
                    // Video started!
                }).catch(error => {
                    console.warn("Video play failed even after click:", error);
                    transitionToPlayer(); // Failsafe in case video fails
                });
            }

            // New function to skip the intro
            function skipIntro() {
                splashVideo.pause();
                introAudio.pause(); // Stop the intro audio just in case
                skipIntroBtn.classList.add('hidden'); // Hide skip button
                transitionToPlayer(); // Go right to the player
            }

            // This function fades to the player
            function transitionToPlayer() {
                skipIntroBtn.classList.add('hidden'); // Hide skip button
                // Wait 1 second after intro audio finishes (or skip is clicked)
                setTimeout(() => {
                    splashScreen.style.opacity = '0';
                    playerContainer.style.opacity = '1';
                    
                    // After the fade, remove the splash screen
                    setTimeout(() => {
                        splashScreen.style.display = 'none';
                    }, 1000); // Must match the transition duration
                    
                }, 1000); // 1-second pause
            }
            
            // --- Player Functions ---
            function updatePositionState() {
                if ('mediaSession' in navigator && navigator.mediaSession.metadata) {
                    const { duration, currentTime } = audioPlayer;
                    if (duration && isFinite(duration)) {
                        navigator.mediaSession.setPositionState({
                            duration: duration,
                            playbackRate: audioPlayer.playbackRate,
                            position: currentTime
                        });
                    }
                }
            }
            
            function updateMediaSession(song) {
                if ('mediaSession' in navigator) {
                    if (song) {
                        // Song is playing
                        navigator.mediaSession.metadata = new MediaMetadata({
                            title: song.title,
                            artist: artistName,
                            album: albumName,
                            artwork: [
                                { src: song.image_src, sizes: '512x512', type: 'image/png' }
                            ]
                        });
                        navigator.mediaSession.playbackState = "playing";
                    } else {
                        // Song is paused
                        if (navigator.mediaSession.metadata) {
                             navigator.mediaSession.playbackState = "paused";
                        }
                    }
                    updatePositionState(); // Update progress bar
                }
            }
            
            function updateLinerNotes(index) {
                if (index === null) {
                    noteTitleEl.textContent = albumTitle;
                    noteBodyEl.innerHTML = albumNote; // Use innerHTML for formatted album note
                } else {
                    const song = songs[index];
                    noteTitleEl.textContent = song.title;
                    noteBodyEl.innerHTML = song.note; // Use innerHTML for formatted song notes
                }
            }

            function loadSong(song) {
                songTitleEl.textContent = song.title;
                songArtistEl.textContent = artistName;
                audioPlayer.src = song.src;
                songArtEl.src = song.image_src; // Set new song art
                songArtEl.classList.remove('is-visible'); // Make it invisible (ready to fade in)
                flipper.classList.remove('is-flipped'); // Flip notes back to front
                updateActivePlaylistItem();
            }

            function playSong() {
                closeVideo(); // *** NEW: Close video if it's open
                if (!audioPlayer.src || audioPlayer.src.endsWith('index.html')) {
                    loadSong(songs[currentSongIndex]);
                }
                isPlaying = true;
                audioPlayer.play();
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
                songArtEl.classList.add('is-visible'); // Fade in song art
                mainPlayerDiv.classList.add('is-playing-glow'); // Add glow
                updateLinerNotes(currentSongIndex);
                updateMediaSession(songs[currentSongIndex]);
            }

            function pauseSong() {
                isPlaying = false;
                audioPlayer.pause();
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                songArtEl.classList.remove('is-visible'); // Fade out song art
                mainPlayerDiv.classList.remove('is-playing-glow'); // Remove glow
                updateLinerNotes(null);
                updateMediaSession(null);
            }

            function prevSong() {
                currentSongIndex--;
                if (currentSongIndex < 0) currentSongIndex = songs.length - 1;
                loadSong(songs[currentSongIndex]);
                if (isPlaying) playSong();
            }

            function nextSong() {
                currentSongIndex++;
                if (currentSongIndex > songs.length - 1) currentSongIndex = 0;
                loadSong(songs[currentSongIndex]);
                if (isPlaying) playSong();
            }

            function updateProgress(e) {
                const { duration, currentTime } = e.srcElement;
                if (duration) {
                    const progressPercent = (currentTime / duration) * 100;
                    progressBar.value = progressPercent;
                    durationTimeEl.textContent = formatTime(duration);
                    currentTimeEl.textContent = formatTime(currentTime);
                    updatePositionState(); // Update truck progress bar
                }
            }

            function formatTime(seconds) {
                if (isNaN(seconds)) return "0:00";
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            }

            function setProgress() {
                const duration = audioPlayer.duration;
                if (duration) {
                     audioPlayer.currentTime = (progressBar.value / 100) * duration;
                     updatePositionState(); // Update truck progress bar
                }
            }
            
            function updateActivePlaylistItem() {
                const items = document.querySelectorAll('.playlist-item');
                items.forEach((item, index) => {
                    if (index === currentSongIndex) {
                        item.classList.add('active');
                        item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    } else {
                        item.classList.remove('active');
                    }
                });
            }

            function createPlaylist() {
                songs.forEach((song, index) => {
                    const item = document.createElement('div');
                    item.classList.add('playlist-item', 'p-3', 'rounded-lg', 'cursor-pointer', 'hover:bg-gray-700', 'transition-colors', 'duration-200');
                    item.innerHTML = `
                        <p class="font-album-title tracking-wider truncate">${song.title}</p>
                        <p class="text-sm text-gray-400">${artistName}</p>
                    `;
                    item.addEventListener('click', () => {
                        currentSongIndex = index;
                        loadSong(song);
                        playSong();
                    });
                    playlistEl.appendChild(item);
                });
            }

            // --- *** MODIFIED Video Functions *** ---
            function createVideoPlaylist() {
                videos.forEach((video, index) => {
                    const item = document.createElement('div');
                    item.classList.add('playlist-item', 'p-3', 'rounded-lg', 'cursor-pointer', 'hover:bg-gray-700', 'transition-colors', 'duration-200', 'flex', 'items-center', 'space-x-4');
                    item.innerHTML = `
                        <img src="${video.thumbnail}" alt="${video.title}" class="w-16 h-9 object-cover rounded-md flex-shrink-0">
                        <div>
                            <p class="font-album-title tracking-wider truncate text-white">${video.title}</p>
                            <p class="text-sm text-gray-400">${artistName}</p>
                        </div>
                    `;
                    item.addEventListener('click', () => {
                        playVideo(video);
                    });
                    videoPlaylistEl.appendChild(item);
                });
            }

            // *** NEW playVideo function ***
            function playVideo(video) {
                pauseSong(); // Stop the music
                flipper.classList.remove('is-flipped'); // Ensure notes aren't showing
                videoPanel.classList.remove('hidden'); // Show the video panel
                // Set the iframe src. Added autoplay and other parameters.
                videoPlayerIframe.src = `${video.src}?autoplay=1&modestbranding=1&rel=0`;
                isVideoPlaying = true;
            }

            // *** NEW closeVideo function ***
            function closeVideo() {
                if (!isVideoPlaying) return;
                videoPanel.classList.add('hidden'); // Hide the video panel
                videoPlayerIframe.src = ""; // Set src to empty to stop the video
                isVideoPlaying = false;
            }


            // --- 5. EVENT LISTENERS ---
            
            // --- Splash Screen Logic ---
            enterBtn.addEventListener('click', startVideoTransition);
            skipIntroBtn.addEventListener('click', skipIntro);
            splashVideo.addEventListener('ended', () => {
                if(hasUserInteracted) {
                    introAudio.play().catch(e => {
                        console.warn("Intro audio failed to play:", e);
                        transitionToPlayer(); // Failsafe
                    });
                }
            });
            introAudio.addEventListener('ended', transitionToPlayer);
            
            // --- Player Logic ---
            playPauseBtn.addEventListener('click', () => {
                if (isPlaying) pauseSong();
                else playSong(); // playSong() will auto-close the video
            });
            prevBtn.addEventListener('click', prevSong); // prevSong() calls playSong()
            nextBtn.addEventListener('click', nextSong); // nextSong() calls playSong()
            audioPlayer.addEventListener('timeupdate', updateProgress);
            audioPlayer.addEventListener('ended', nextSong);
            progressBar.addEventListener('input', setProgress);
            
            linerNotesBtn.addEventListener('click', () => {
                closeVideo(); // *** NEW: Close video first
                updateLinerNotes(isPlaying ? currentSongIndex : null);
                flipper.classList.toggle('is-flipped');
            });
            
            // --- "About" Button Listener ---
            aboutBtn.addEventListener('click', () => {
                closeVideo(); // *** NEW: Close video first
                noteTitleEl.textContent = aboutTitle;
                noteBodyEl.innerHTML = aboutText; // Use innerHTML for formatted "About" text
                flipper.classList.add('is-flipped'); // Show the back panel
            });

            // --- Tab Listeners ---
            audioTabBtn.addEventListener('click', () => {
                // Show audio, hide video
                playlistEl.classList.remove('hidden');
                videoPlaylistEl.classList.add('hidden');
                // Style tabs
                audioTabBtn.classList.add('bg-gray-700', 'text-white');
                audioTabBtn.classList.remove('text-gray-400', 'hover:bg-gray-700');
                videoTabBtn.classList.add('text-gray-400', 'hover:bg-gray-700');
                videoTabBtn.classList.remove('bg-gray-700', 'text-white');
            });

            videoTabBtn.addEventListener('click', () => {
                // Show video, hide audio
                videoPlaylistEl.classList.remove('hidden');
                playlistEl.classList.add('hidden');
                // Style tabs
                videoTabBtn.classList.add('bg-gray-700', 'text-white');
                videoTabBtn.classList.remove('text-gray-400', 'hover:bg-gray-700');
                audioTabBtn.classList.add('text-gray-400', 'hover:bg-gray-700');
                audioTabBtn.classList.remove('bg-gray-700', 'text-white');
            });


            // --- Media Session Action Handlers (for truck controls) ---
            if ('mediaSession' in navigator) {
                navigator.mediaSession.setActionHandler('play', playSong);
                navigator.mediaSession.setActionHandler('pause', pauseSong);
                navigator.mediaSession.setActionHandler('previoustrack', prevSong);
                navigator.mediaSession.setActionHandler('nexttrack', nextSong);
                navigator.mediaSession.setActionHandler('seekto', (details) => {
                    audioPlayer.currentTime = details.seekTime;
                    updatePositionState();
                });
            }

            // --- 6. INITIALIZE PLAYER ---
            createPlaylist();
            createVideoPlaylist(); // Create the new video list
            loadSong(songs[currentSongIndex]);
            updateLinerNotes(null);
            
            // --- 7. PWA Service Worker Registration ---
            const isPwa = window.matchMedia('(display-mode: standalone)').matches;

            if (isPwa && 'serviceWorker' in navigator) {
                showBeginButton();

                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful:', registration);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                        showBeginButton(); 
                    });
            } else {
                console.log('Not in PWA mode, skipping PWA features.');
                showBeginButton();
            }
        });
    </script>
</body>
</html>

