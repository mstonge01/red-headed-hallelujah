<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Red-Headed Hallelujah</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter (sans-serif) and Staatliches (blocky, for title) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Staatliches&display=swap" rel="stylesheet">
    
    <!-- Google Cast SDK -->
    <!-- We load this dynamically in JS, but pre-connect to speed it up -->
    <link rel="preconnect" href="https://www.gstatic.com">
    <script type="text/javascript" src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json?v=4"> <!-- Version 4 -->
    <meta name="theme-color" content="#EF4444">
    
    <style>
        /* Custom styles to match the album art aesthetic */
        body {
            font-family: 'Inter', sans-serif;
            /* Prevent scrolling bounces on mobile */
            overscroll-behavior: none;
        }

        /* Using 'Staatliches' for the main album title to mimic the cover font */
        .font-album-title {
            font-family: 'Staatliches', cursive;
        }

        /* Custom scrollbar for the playlist */
        #playlist::-webkit-scrollbar,
        #flipper-back::-webkit-scrollbar {
            width: 8px;
        }
        #playlist::-webkit-scrollbar-track,
        #flipper-back::-webkit-scrollbar-track {
            background: #374151; /* gray-700 */
            border-radius: 10px;
        }
        #playlist::-webkit-scrollbar-thumb,
        #flipper-back::-webkit-scrollbar-thumb {
            background: #EF4444; /* red-500 */
            border-radius: 10px;
        }
        #playlist::-webkit-scrollbar-thumb:hover,
        #flipper-back::-webkit-scrollbar-thumb:hover {
            background: #DC2626; /* red-600 */
        }

        /* Style for the currently active playlist item */
        .playlist-item.active {
            background-color: #EF4444; /* red-500 */
            color: #FFFFFF; /* white */
        }

        /* Custom style for the progress bar slider thumb */
        #progress-bar-container input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #EF4444; /* red-500 */
            border-radius: 3px;
            cursor: pointer;
            margin-top: -6px; /* Center the thumb on the track */
        }
        
        #progress-bar-container input[type=range]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #EF4444; /* red-500 */
            border-radius: 3px;
            cursor: pointer;
        }

        /* Custom style for the progress bar track */
        #progress-bar-container input[type=range] {
             -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px; 
            background: #4B5563; /* gray-600 */
            outline: none;
        }

        /* Class for the player texture */
        .player-texture {
            background-color: #1F2937; /* This is Tailwind's bg-gray-800 */
            background-image: url('https://www.transparenttextures.com/patterns/stucco.png');
        }

        /* --- Liner Notes Flip Animation --- */
        .flipper-container {
            perspective: 1000px;
            padding-top: 100%; /* Creates a 1:1 aspect ratio */
        }
        #flipper {
            transform-style: preserve-3d;
            transition: transform 0.8s;
        }
        #flipper.is-flipped {
            transform: rotateY(180deg);
        }
        .flipper-front,
        .flipper-back {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }
        .flipper-back {
            transform: rotateY(180deg);
            background-color: #4B5563; /* gray-600 */
            background-image: url('https://www.transparenttextures.com/patterns/concrete-wall.png');
        }
        #note-body {
            white-space: pre-wrap;
        }

        /* --- "Live Glow" Pulse Animation --- */
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 10px rgba(239, 68, 68, 0); } /* red-500 with 0 opacity */
            50% { box-shadow: 0 0 20px 5px rgba(239, 68, 68, 0.4); } /* red-500 with 40% opacity */
        }
        .is-playing-glow {
            animation: pulseGlow 3s infinite ease-in-out;
        }
        
        /* --- Simple Crossfade for Song Art --- */
        #song-art {
            /* This is the new art layer, starts invisible */
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        #song-art.is-active {
            /* Fades in when active */
            opacity: 1;
        }

        /* --- Google Cast Button Styling --- */
        google-cast-launcher {
            width: 40px;
            height: 40px;
            --cast-button-color: #FFF; /* White, to match splash screen */
            cursor: pointer;
            margin: 10px;
        }
        
        /* Container for cast button on splash screen */
        #cast-button-container {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 60;
        }
        
        /* Styling for when the button is in the player (DESKTOP AND MOBILE)
          This is the fix:
        */
        #player-cast-btn-container google-cast-launcher,
        #player-cast-btn-container-mobile google-cast-launcher {
             --cast-button-color: #EF4444; /* red-500 */
             width: 24px;
             height: 24px;
             margin: 0;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-300 min-h-screen flex items-center justify-center p-4 overflow-hidden">

    <!-- 
      Splash Screen: 
      Full screen, contains video, update button, and cast button.
    -->
    <div id="splash-screen" class="fixed top-0 left-0 w-full h-full bg-gray-900 z-50 flex items-center justify-center opacity-100 transition-opacity duration-1000">
        
        <!-- Video -->
        <video id="splash-video" class="max-w-full max-h-full object-contain" playsinline>
            <source src="paint-video.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>

        <!-- "Click to Begin" / Status Button -->
        <button id="enter-btn" class="absolute z-60 bg-red-500 text-white p-4 px-6 rounded shadow-lg font-album-title text-2xl tracking-wider hover:bg-red-600 transition-all duration-300 disabled:bg-gray-500 disabled:opacity-75">
            Click to Begin
        </button>

        <!-- "Skip Intro" Button (hidden initially) -->
        <button id="skip-btn" class="hidden absolute bottom-10 left-1/2 -translate-x-1/2 z-60 bg-black bg-opacity-50 text-white py-2 px-4 rounded text-sm hover:bg-opacity-75 transition-all">
            Skip Intro
        </button>
        
        <!-- 
          Cast Button Container
          This whole container will be *moved* into the player later.
        -->
        <div id="cast-button-container">
            <google-cast-launcher id="cast-btn"></google-cast-launcher>
        </div>

        <!-- PWA "Checking for Updates" UI (hidden by default) -->
        <div id="update-ui" class="hidden absolute top-0 left-0 w-full h-full bg-gray-900 bg-opacity-95 z-40 p-8 flex flex-col items-center justify-center text-center">
            <div id="update-checking" class="text-gray-300">
                <p class="font-album-title text-3xl text-yellow-400 tracking-wider mb-4">Checking for Updates...</p>
                <p>Please wait a moment.</p>
            </div>
            <div id="update-available" class="hidden text-gray-300">
                <p class="font-album-title text-3xl text-yellow-400 tracking-wider mb-4">Update Found!</p>
                <p>Downloading new files... please wait.</p>
                <p class="mt-4 text-sm text-gray-400">(The app will reload automatically when done.)</p>
            </div>
        </div>
    </div>

    <!-- 
      Main Player Container 
      (starts invisible, fades in)
    -->
    <div id="player-container" class="w-full max-w-4xl opacity-0 transition-opacity duration-1000 hidden md:block">
        <!-- Player Container -->
        <div class="player-texture shadow-2xl overflow-hidden flex flex-col md:flex-row">
            
            <!-- Left Side: Album Artwork & Liner Notes -->
            <div class="w-full md:w-1/2 lg:w-5/12 flex-shrink-0 flex flex-col">
                <!-- Flipper container (1:1 aspect ratio) -->
                <div class="relative w-full flipper-container overflow-hidden"> 
                    <div id="flipper" class="absolute top-0 left-0 w-full h-full">
                        <!-- FRONT (Album Art) -->
                        <div class="flipper-front absolute w-full h-full">
                            <!-- Base Art (Main Cover) -->
                            <img src="cover.jpg.jpg" alt="Album Art for Red-Headed Hallelujah" class="w-full h-full object-cover">
                            <!-- Song-Specific Art (Fades in over top) -->
                            <img id="song-art" src="" alt="" class="absolute top-0 left-0 w-full h-full object-cover">
                        </div>
                        <!-- BACK (Liner Notes) -->
                        <div id="flipper-back" class="flipper-back absolute w-full h-full p-6 overflow-y-auto">
                            <h3 id="note-title" class="font-album-title text-3xl text-yellow-400 tracking-wider mb-4"></h3>
                            <p id="note-body" class="text-gray-200"></p>
                        </div>
                    </div>
                </div>
                <!-- Liner Notes Button -->
                <button id="liner-notes-btn" class="w-full bg-red-500 text-white font-album-title tracking-wider text-lg p-3 hover:bg-red-600 transition-colors duration-200">
                    Liner Notes
                </button>
            </div>

            <!-- Right Side: Info, Controls, Playlist -->
            <div class="w-full md:w-1/2 lg:w-7/12 p-6 flex flex-col justify-between">
                
                <!-- Top-Right: Current Song Info -->
                <div class="mb-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-lg uppercase tracking-widest text-red-500 font-album-title">Now Playing</p>
                            <h2 id="song-title" class="text-3xl text-yellow-400 truncate font-album-title tracking-wider">Song Title</h2>
                            <h3 id="song-artist" class="text-lg text-gray-300">A mstonge01 Project</h3>
                        </div>
                        <!-- Container where the Cast Button will be MOVED to -->
                        <div id="player-cast-btn-container" class="flex-shrink-0 pt-2">
                            <!-- The cast button will be moved here by JS -->
                        </div>
                    </div>
                </div>

                <!-- Middle-Right: Controls & Progress Bar -->
                <div class="mb-4">
                    <!-- Progress Bar -->
                    <div id="progress-bar-container" class="mb-3">
                         <input type="range" id="progress-bar" class="w-full h-1 bg-gray-700 rounded-lg cursor-pointer" value="0" min="0" max="100">
                    </div>
                    <!-- Time Display -->
                    <div class="flex justify-between text-sm text-gray-400">
                        <span id="current-time">0:00</span>
                        <span id="duration-time">0:00</span>
                    </div>

                    <!-- Controls -->
                    <div class="flex justify-center items-center space-x-6 mt-4">
                        <button id="prev-btn" class="text-gray-400 hover:text-red-500 transition-colors duration-200">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M8.445 14.832A1 1 0 0010 14.03V5.969a1 1 0 00-1.555-.832L4.12 9.168a1 1 0 000 1.664l4.325 4zM10.879 9.168a1 1 0 000 1.664l4.325 4A1 1 0 0017 14.03V5.969a1 1 0 00-1.555-.832l-4.325 4z"/></svg>
                        </button>
                        <button id="play-pause-btn" class="w-16 h-16 bg-red-500 text-white rounded-full flex items-center justify-center text-2xl hover:bg-red-600 transition-colors duration-200 shadow-lg">
                            <svg id="play-icon" class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8.002v3.996a1 1 0 001.555.832l3.197-1.998a1 1 0 000-1.664l-3.197-1.998z" clip-rule="evenodd"/></svg>
                            <svg id="pause-icon" class="w-8 h-8 hidden" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h1a1 1 0 001-1V8a1 1 0 00-1-1H8zm5 0a1 1 0 00-1 1v4a1 1 0 001 1h1a1 1 0 001-1V8a1 1 0 00-1-1h-1z" clip-rule="evenodd"/></svg>
                        </button>
                        <button id="next-btn" class="text-gray-400 hover:text-red-500 transition-colors duration-200">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M4.555 5.168A1 1 0 003 5.969v8.062a1 1 0 001.555.832l4.325-4a1 1 0 000-1.664l-4.325-4zM10.879 5.168A1 1 0 009.324 5.97v8.062a1 1 0 001.555.832l4.325-4a1 1 0 000-1.664l-4.325-4z"/></svg>
                        </button>
                    </div>
                </div>
                
                <!-- Bottom-Right: Playlist -->
                <div class="flex-grow min-h-0">
                    <div id="playlist" class="h-48 md:h-full max-h-48 lg:max-h-56 overflow-y-auto pr-2">
                        <!-- Playlist items will be injected here by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- "Check for Updates" Button (PWA only) -->
        <div id="update-btn-container" class="text-center mt-4" style="display: none;"> <!-- Hidden by default, shown by PWA JS -->
             <button id="update-btn" class="text-gray-500 text-sm hover:text-red-500 transition-colors">Check for Updates</button>
             <p id="update-status" class="text-gray-500 text-sm mt-1"></p>
        </div>
    </div>
    
    <!-- Mobile/Vertical Layout (hidden on md+) -->
    <div id="player-container-mobile" class="w-full max-w-md opacity-0 transition-opacity duration-1000 md:hidden">
        <div class="player-texture shadow-2xl overflow-hidden rounded-lg">
            <!-- Top: Album Artwork & Liner Notes -->
            <div class="w-full flex-shrink-0 flex flex-col">
                <!-- Flipper container (1:1 aspect ratio) -->
                <div class="relative w-full flipper-container overflow-hidden"> 
                    <div id="flipper-mobile" class="absolute top-0 left-0 w-full h-full">
                        <!-- FRONT (Album Art) -->
                        <div class="flipper-front absolute w-full h-full">
                            <img src="cover.jpg.jpg" alt="Album Art for Red-Headed Hallelujah" class="w-full h-full object-cover">
                            <img id="song-art-mobile" src="" alt="" class="absolute top-0 left-0 w-full h-full object-cover">
                        </div>
                        <!-- BACK (Liner Notes) -->
                        <div id="flipper-back-mobile" class="flipper-back absolute w-full h-full p-6 overflow-y-auto">
                            <h3 id="note-title-mobile" class="font-album-title text-3xl text-yellow-400 tracking-wider mb-4"></h3>
                            <p id="note-body-mobile" class="text-gray-200"></p>
                        </div>
                    </div>
                </div>
                <!-- Liner Notes Button -->
                <button id="liner-notes-btn-mobile" class="w-full bg-red-500 text-white font-album-title tracking-wider text-lg p-3 hover:bg-red-600 transition-colors duration-200">
                    Liner Notes
                </button>
            </div>

            <!-- Bottom: Info, Controls, Playlist -->
            <div class="w-full p-6 flex flex-col justify-between">
                <!-- Top: Current Song Info -->
                <div class="mb-4">
                     <div class="flex justify-between items-start">
                        <div>
                            <p class="text-lg uppercase tracking-widest text-red-500 font-album-title">Now Playing</p>
                            <h2 id="song-title-mobile" class="text-3xl text-yellow-400 truncate font-album-title tracking-wider">Song Title</h2>
                            <h3 id="song-artist-mobile" class="text-lg text-gray-300">A mstonge01 Project</h3>
                        </div>
                        <!-- Container where the Cast Button will be MOVED to -->
                        <div id="player-cast-btn-container-mobile" class="flex-shrink-0 pt-2">
                            <!-- The cast button will be moved here by JS -->
                        </div>
                    </div>
                </div>

                <!-- Middle: Controls & Progress Bar -->
                <div class="mb-4">
                    <div id="progress-bar-container-mobile" class="mb-3">
                         <input type="range" id="progress-bar-mobile" class="w-full h-1 bg-gray-700 rounded-lg cursor-pointer" value="0" min="0" max="100">
                    </div>
                    <div class="flex justify-between text-sm text-gray-400">
                        <span id="current-time-mobile">0:00</span>
                        <span id="duration-time-mobile">0:00</span>
                    </div>
                    <div class="flex justify-center items-center space-x-6 mt-4">
                        <button id="prev-btn-mobile" class="text-gray-400 hover:text-red-500 transition-colors duration-200">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M8.445 14.832A1 1 0 0010 14.03V5.969a1 1 0 00-1.555-.832L4.12 9.168a1 1 0 000 1.664l4.325 4zM10.879 9.168a1 1 0 000 1.664l4.325 4A1 1 0 0017 14.03V5.969a1 1 0 00-1.555-.832l-4.325 4z"/></svg>
                        </button>
                        <button id="play-pause-btn-mobile" class="w-16 h-16 bg-red-500 text-white rounded-full flex items-center justify-center text-2xl hover:bg-red-600 transition-colors duration-200 shadow-lg">
                            <svg id="play-icon-mobile" class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8.002v3.996a1 1 0 001.555.832l3.197-1.998a1 1 0 000-1.664l-3.197-1.998z" clip-rule="evenodd"/></svg>
                            <svg id="pause-icon-mobile" class="w-8 h-8 hidden" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h1a1 1 0 001-1V8a1 1 0 00-1-1H8zm5 0a1 1 0 00-1 1v4a1 1 0 001 1h1a1 1 0 001-1V8a1 1 0 00-1-1h-1z" clip-rule="evenodd"/></svg>
                        </button>
                        <button id="next-btn-mobile" class="text-gray-400 hover:text-red-500 transition-colors duration-200">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M4.555 5.168A1 1 0 003 5.969v8.062a1 1 0 001.555.832l4.325-4a1 1 0 000-1.664l-4.325-4zM10.879 5.168A1 1 0 009.324 5.97v8.062a1 1 0 001.555.832l4.325-4a1 1 0 000-1.664l-4.325-4z"/></svg>
                        </button>
                    </div>
                </div>
                
                <!-- Bottom: Playlist -->
                <div class="flex-grow min-h-0">
                    <div id="playlist-mobile" class="h-48 overflow-y-auto pr-2">
                        <!-- Playlist items will be injected here by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- "Check for Updates" Button (PWA only) -->
        <div id="update-btn-container-mobile" class="text-center mt-4" style="display: none;"> <!-- Hidden by default, shown by PWA JS -->
             <button id="update-btn-mobile" class="text-gray-500 text-sm hover:text-red-500 transition-colors">Check for Updates</button>
             <p id="update-status-mobile" class="text-gray-500 text-sm mt-1"></p>
        </div>
    </div>


    <!-- Hidden Audio Elements -->
    <audio id="audio-player"></audio>
    <audio id="intro-audio-clip" src="hallelujah-intro.mp3"></audio>

    <script>
        // --- CAST API INITIALIZATION ---
        let castContext = null;
        let castSession = null;
        let currentMedia = null;
        let isCasting = false;

        window['__onGCastApiAvailable'] = function(isAvailable) {
            if (isAvailable) {
                initializeCastApi();
            } else {
                console.log("Cast API not available");
                // Hide the cast button container if API is not available
                document.getElementById('cast-button-container').style.display = 'none';
            }
        };

        function initializeCastApi() {
            castContext = cast.framework.CastContext.getInstance();
            castContext.setOptions({
                receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
                autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
            });

            castContext.addEventListener(
                cast.framework.CastContextEventType.SESSION_STATE_CHANGED,
                handleCastSessionState
            );
            castContext.addEventListener(
                cast.framework.CastContextEventType.MEDIA_SESSION,
                handleCastMediaSession
            );
        }
        
        function handleCastSessionState(event) {
            const castBtn = document.getElementById('cast-btn');
            if (event.sessionState === cast.framework.SessionState.SESSION_STARTED) {
                console.log("Cast session started");
                castSession = castContext.getCurrentSession();
                isCasting = true;
                // If music is already playing, transfer it
                if (isPlaying) {
                    playSong(); // This will now load into the cast session
                }
                castBtn.style.setProperty('--cast-button-color', '#FACC15'); // Yellow
            } else if (event.sessionState === cast.framework.SessionState.SESSION_ENDED) {
                console.log("Cast session ended");
                castSession = null;
                isCasting = false;
                currentMedia = null;
                if (isPlaying) {
                    // Session ended, resume playback locally
                    // We need to reload the song to play locally
                    const wasPlaying = isPlaying;
                    pauseSong(); // Pause cast session
                    if (wasPlaying) {
                         // Give it a moment, then play locally
                        setTimeout(() => {
                            audioPlayer.currentTime = castMediaCurrentTime;
                            playSong(); // This will now play locally
                        }, 500);
                    }
                }
                castBtn.style.setProperty('--cast-button-color', isPlayerVisible ? '#EF4444' : '#FFF'); // Red or White
            } else {
                 castBtn.style.setProperty('--cast-button-color', isPlayerVisible ? '#EF4444' : '#FFF'); // Red or White
            }
        }
        
        function handleCastMediaSession(event) {
            console.log("Cast media session started");
            currentMedia = event.mediaSession;
            currentMedia.addUpdateListener(onMediaStatusUpdate);
        }
        
        let castMediaCurrentTime = 0;
        function onMediaStatusUpdate(isMuted) {
            if (currentMedia) {
                castMediaCurrentTime = currentMedia.currentTime;
                if (currentMedia.playerState === 'IDLE' && currentMedia.idleReason === 'FINISHED') {
                    // Song finished, play next
                    nextSong();
                }
                // Sync local player UI just in case
                if (isPlaying) {
                    const progressPercent = (currentMedia.currentTime / currentMedia.media.duration) * 100;
                    progressBar.value = progressPercent;
                    progressBarMobile.value = progressPercent;
                    currentTimeEl.textContent = formatTime(currentMedia.currentTime);
                    durationTimeEl.textContent = formatTime(currentMedia.media.duration);
                    currentTimeMobileEl.textContent = formatTime(currentMedia.currentTime);
                    durationTimeMobileEl.textContent = formatTime(currentMedia.media.duration);
                }
            }
        }

        // --- END CAST API ---


        document.addEventListener('DOMContentLoaded', () => {
            // --- 1. SONG DATABASE ---
            const songs = [
                { 
                    title: "The Crimson Tide", 
                    src: "01-the-crimson-tide.mp3",
                    image_src: "01-the-crimson-tide-art.png",
                    note: `The Crimson Tide is a driving, high-energy rock anthem that dives headfirst into themes of danger and irresistible allure. This track establishes the album's mood, telling the tale of a powerful, siren-like figure—a redhead mermaid—who represents a captivating force no sailor can resist. The "Crimson Tide" itself symbolizes that moment when you are willingly lost to a consuming passion or adventure, abandoning all maps and compasses for the thrill of being pulled under. It's a powerful, thunderous opener about giving yourself over to the pull of the deep unknown.`
                },
                { 
                    title: "Real Women", 
                    src: "02-real-women.mp3",
                    image_src: "02-real-women-art.png",
                    note: `This is a fist-pumping, no-nonsense track built around a heavy riff and a fierce, anti-establishment attitude. Real Women is an anthem for authenticity, a celebration of those who refuse to conform to societal expectations or manufactured trends. The song champions the powerful, genuine spirit of a woman who makes her own rules, embraces her rugged freedom, and drives her own path, prioritizing grit and independence over superficial glamour.`
                },
                { 
                    title: "Red-Headed Hallelujah", 
                    src: "03-red-headed-hallelujah.mp3",
                    image_src: "03-red-headed-hallelujah-art.png",
                    note: `Red-Headed Hallelujah serves as the album’s emotional centerpiece, capturing the moment of finding grace and peace amid daily chaos. The lyrics paint a picture of mundane stress and anxiety, only for a brilliant light—the Red Headed Hallelujah—to cut through the darkness. It’s a powerful, soaring track about having that one person or singular moment of clarity that acts as a spiritual lifeline, instantly dissolving stress and restoring faith in the good things.`
                },
                { 
                    title: "The Good Stuff", 
                    src: "04-the_good_stuff.mp3",
                    image_src: "04-the_good_stuff-art.png",
                    note: `This is a mid-tempo, reflective song about the serendipitous nature of life and the lasting value of genuine connection. The Good Stuff tells the story of an unexpected journey—a disastrous start that leads to a profound discovery—that becomes the ultimate reward. It’s a track about recognizing destiny in its simplest form, realizing that all the minor chaos was worth it because it led directly to finding the solid, reliable, sacred trust that forms the foundation of a lasting life.`
                },
                { 
                    title: "Zero Degree Beach", 
                    src: "05-zero-degree-beach.mp3",
                    image_src: "05-zero-degree-beach-art.png",
                    note: `Zero-Degree Beach is a moody, atmospheric track exploring the idea of mental escapism and resilience. Set against the bleak backdrop of a seemingly endless winter, the song is a tribute to the power of a mindset that can conjure summer out of nowhere. It champions the unshakeable spirit of someone who chooses their own climate, finding personal peace, joy, and freedom in a place others see as inhospitable, effectively creating their own private oasis, even in the middle of a blizzard.`
                },
                { 
                    title: "Caps", 
                    src: "06-caps.mp3",
                    image_src: "06-caps-art.png",
                    note: `This is the album’s most direct and playfully sensual love song. Built on a catchy groove, Caps uses a surprisingly detailed and affectionate focus—specifically on the knees and legs—to convey deep, sincere infatuation. It’s a lighthearted but utterly celebratory tribute to physical beauty, declaring that in a world full of wonders, the most compelling destination remains the masterpiece of human form that inspires obsession and joy.`
                },
                { 
                    title: "Interrupted", 
                    src: "07-interrupted.mp3",
                    image_src: "07-interrupted-art.png",
                    note: `Interrupted captures the chaotic but relatable comedy of trying to steal a moment of quiet romance in a household with children. The song builds tension as a couple attempts to create a peaceful evening, only to be hilariously derailed by escalating household distractions, from barking dogs to midnight requests from a "little voice." It is a rocking, tongue-in-cheek ode to the realities of modern family life, concluding with the resilient declaration that even when romantic plans fail, the love remains strong enough to survive the interruptions.`
                },
                { 
                    title: "Cinnamon Serenade", 
                    src: "08-cinnamon-serenade.mp3",
                    image_src: "08-cinnamon-serenade-art.png",
                    note: `This track is a rugged, deeply romantic look at the less-than-glamorous moments of a relationship that truly define commitment. Cinnamon Serenade contrasts the sugary sweetness of a cinnamon-flavored whisky with the messy reality of being there for someone at their absolute worst—in this case, holding back hair at 3 AM. It’s a rock ballad celebrating unconditional love, where the act of humble service (clutching a plastic bowl) is shown to be far more meaningful than any perfect date, proving that true devotion shines brightest in the face of imperfection.`
                },
                { 
                    title: "Golden Devotion", 
                    src: "09-golden-devotion.mp3",
                    image_src: "09-golden-devotion-art.png",
                    note: `Golden Devotion is a sun-drenched, devotional track that feels like a warm escape. It celebrates an individual who possesses a rare, life-affirming energy, described as someone who "worships the sun" and radiates light. The song contrasts the fleeting cold with the subject's unbreakable warmth and spirit, portraying them as a powerful, glowing crown—a central force whose presence is a constant source of heat, love, and bold, quiet strength that inspires those around them.`
                },
                { 
                    title: "Natural Magic", 
                    src: "10-natural-magic.mp3",
                    image_src: "10-natural-magic-art.png",
                    note: `The album closes with Natural Magic, a tender, observational song that marvels at the quiet, everyday competence of a person who keeps the world running. It paints a picture of domestic chaos—scattered belongings, noise, and disorder—that is effortlessly managed by a central figure who handles everything with natural grace and care. The track is a heartfelt tribute to the instinctual, healing power of a partner, whose presence is a gentle, calming force that brings peace and order to a hectic life.`
                },
                { 
                    title: "Red-Headed Hallelujah (Guitar)", 
                    src: "11-red-headed-hallelujah-guitar.mp3",
                    image_src: "11-red-headed-hallelujah-guitar-art.png",
                    note: `This cover is a soaring power ballad about finding a literal and emotional lifeline when life becomes overwhelming. The song chronicles a rough journey of stress and anxiety, only for the world-weary narrator to find instant peace and salvation in a central figure—the Red-Headed Hallelujah. It’s a powerful declaration that love can be a force of redemption, a moment of grace that burns bright enough to banish the darkest nights and make you believe that everything is going to be alright.`
                },
                { 
                    title: "Red-Headed Hallelujah (Piano)", 
                    src: "12-red-headed-hallelujah-piano.mp3",
                    image_src: "12-red-headed-hallelujah-piano-art.png",
                    note: `Serving as a beautiful, reflective denouement, this piano arrangement strips the core melody of the Red-Headed Hallelujah down to its purest, most emotional form. It closes the album with a sense of peace and resolution. After the high-energy and emotional turbulence of the preceding tracks, this instrumental piece offers a final, quiet moment of realization that the "Hallelujah"—the source of grace and love—is a constant, gentle presence.`
                },
            ];
            const artistName = "A mstonge01 Project";
            
            // Album-level info for liner notes
            const albumTitle = "for Rebecca";
            const albumNote = ``; // Empty, as requested

            // --- 2. DOM ELEMENT REFERENCES ---
            // Splash Screen
            const splashScreen = document.getElementById('splash-screen');
            const splashVideo = document.getElementById('splash-video');
            const introAudioClip = document.getElementById('intro-audio-clip');
            const enterBtn = document.getElementById('enter-btn');
            const skipBtn = document.getElementById('skip-btn');
            const castBtnContainer = document.getElementById('cast-button-container'); // The one on the splash screen
            const castBtn = document.getElementById('cast-btn');
            
            // Player Containers
            const playerContainer = document.getElementById('player-container');
            const playerContainerMobile = document.getElementById('player-container-mobile');
            const playerCastBtnContainer = document.getElementById('player-cast-btn-container'); // Desktop player
            const playerCastBtnContainerMobile = document.getElementById('player-cast-btn-container-mobile'); // Mobile player

            // Desktop Player Elements
            const audioPlayer = document.getElementById('audio-player');
            const songTitleEl = document.getElementById('song-title');
            const songArtistEl = document.getElementById('song-artist');
            const songArtEl = document.getElementById('song-art');
            const playlistEl = document.getElementById('playlist');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const progressBar = document.getElementById('progress-bar');
            const currentTimeEl = document.getElementById('current-time');
            const durationTimeEl = document.getElementById('duration-time');
            const linerNotesBtn = document.getElementById('liner-notes-btn');
            const flipper = document.getElementById('flipper');
            const noteTitleEl = document.getElementById('note-title');
            const noteBodyEl = document.getElementById('note-body');
            
            // Mobile Player Elements
            const songTitleMobileEl = document.getElementById('song-title-mobile');
            const songArtistMobileEl = document.getElementById('song-artist-mobile');
            const songArtMobileEl = document.getElementById('song-art-mobile');
            const playlistMobileEl = document.getElementById('playlist-mobile');
            const playPauseBtnMobile = document.getElementById('play-pause-btn-mobile');
            const playIconMobile = document.getElementById('play-icon-mobile');
            const pauseIconMobile = document.getElementById('pause-icon-mobile');
            const prevBtnMobile = document.getElementById('prev-btn-mobile');
            const nextBtnMobile = document.getElementById('next-btn-mobile');
            const progressBarMobile = document.getElementById('progress-bar-mobile');
            const currentTimeMobileEl = document.getElementById('current-time-mobile');
            const durationTimeMobileEl = document.getElementById('duration-time-mobile');
            const linerNotesBtnMobile = document.getElementById('liner-notes-btn-mobile');
            const flipperMobile = document.getElementById('flipper-mobile');
            const noteTitleMobileEl = document.getElementById('note-title-mobile');
            const noteBodyMobileEl = document.getElementById('note-body-mobile');

            // PWA Update UI
            const updateUI = document.getElementById('update-ui');
            const updateChecking = document.getElementById('update-checking');
            const updateAvailable = document.getElementById('update-available');
            const updateBtnContainer = document.getElementById('update-btn-container');
            const updateBtn = document.getElementById('update-btn');
            const updateStatus = document.getElementById('update-status');
            const updateBtnContainerMobile = document.getElementById('update-btn-container-mobile');
            const updateBtnMobile = document.getElementById('update-btn-mobile');
            const updateStatusMobile = document.getElementById('update-status-mobile');
            

            // --- 3. PLAYER STATE ---
            let currentSongIndex = 0;
            let isPlaying = false;
            let isPlayerVisible = false; // For cast button color

            // --- 4. FUNCTIONS ---

            // --- Splash Screen & Transition ---
            function startVideoTransition() {
                enterBtn.style.display = 'none';
                skipBtn.classList.remove('hidden');

                // Play main video (with sound)
                splashVideo.muted = false; // Ensure sound is on
                splashVideo.play().catch(e => {
                    console.warn("Video play failed, proceeding anyway.", e);
                    playIntroAudio(); // If video fails, just play audio
                });
            }

            function playIntroAudio() {
                // Video finished, now play the intro audio clip
                introAudioClip.play().catch(e => {
                    console.warn("Intro audio clip failed, proceeding anyway.", e);
                    transitionToPlayer(); // If audio fails, just transition
                });
            }
            
            function skipIntro() {
                 // Stop both audio sources
                splashVideo.pause();
                introAudioClip.pause();
                // Hide skip button
                skipBtn.classList.add('hidden');
                // Go straight to transition
                transitionToPlayer();
            }

            function transitionToPlayer() {
                isPlayerVisible = true;
                // Fade out splash screen
                splashScreen.style.opacity = '0';
                
                // Show the correct player based on screen size
                playerContainer.style.opacity = '1';
                playerContainerMobile.style.opacity = '1';
                playerContainer.classList.remove('hidden');
                
                // Move the Cast Button into the active player
                // Check which player is visible (mobile-first check)
                if (window.getComputedStyle(playerContainerMobile).display !== 'none') {
                    // We are on mobile
                    playerCastBtnContainerMobile.appendChild(castBtnContainer);
                } else {
                    // We are on desktop
                    playerCastBtnContainer.appendChild(castBtnContainer);
                }
                
                // Update cast button color for player
                castBtn.style.setProperty('--cast-button-color', '#EF4444'); // Red
                
                // After the fade (1s), remove splash screen
                setTimeout(() => {
                    splashScreen.style.display = 'none';
                }, 1000); // Must match the transition duration
            }

            // --- Player Functions ---
            function updateLinerNotes(index) {
                let title, note;
                if (index === null) {
                    title = albumTitle;
                    note = albumNote;
                } else {
                    const song = songs[index];
                    title = song.title;
                    note = song.note;
                }
                // Update both desktop and mobile
                noteTitleEl.textContent = title;
                noteBodyEl.textContent = note;
                noteTitleMobileEl.textContent = title;
                noteBodyMobileEl.textContent = note;
            }

            function loadSong(song) {
                // Update UI for both desktop and mobile
                songTitleEl.textContent = song.title;
                songArtistEl.textContent = artistName;
                songArtEl.src = song.image_src;
                
                songTitleMobileEl.textContent = song.title;
                songArtistMobileEl.textContent = artistName;
                songArtMobileEl.src = song.image_src;

                // --- Media Session API (for truck, etc.) ---
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.metadata = new MediaMetadata({
                        title: song.title,
                        artist: artistName,
                        album: 'Red-Headed Hallelujah',
                        artwork: [
                            // Use the song-specific art!
                            { src: song.image_src, sizes: '512x512', type: 'image/png' },
                        ]
                    });
                }
                
                // --- Load audio for local playback ---
                audioPlayer.src = song.src;
                
                // Reset flippers
                flipper.classList.remove('is-flipped');
                flipperMobile.classList.remove('is-flipped');
                
                // Update playlist highlights
                updateActivePlaylistItem();
            }

            function playSong() {
                // Make sure a song is loaded
                if (!audioPlayer.src || audioPlayer.src.endsWith('/')) {
                    loadSong(songs[currentSongIndex]);
                }
                
                const song = songs[currentSongIndex];
                
                // --- CAST LOGIC ---
                if (isCasting && castSession) {
                    // We are casting! Load media on the receiver.
                    pauseSong(); // Pause local player first
                    
                    const mediaInfo = new chrome.cast.media.MediaInfo(song.src, 'audio/mp3');
                    mediaInfo.metadata = new chrome.cast.media.GenericMediaMetadata();
                    mediaInfo.metadata.title = song.title;
                    mediaInfo.metadata.artist = artistName;
                    mediaInfo.metadata.albumName = 'Red-Headed Hallelujah';
                    mediaInfo.metadata.images = [
                        new chrome.cast.Image(song.image_src)
                    ];
                    
                    const request = new chrome.cast.media.LoadRequest(mediaInfo);
                    
                    castSession.loadMedia(request).then(
                        () => {
                            console.log('Media loaded on cast device');
                            isPlaying = true; // Mark as playing *after* media loads
                            currentMedia = castSession.getMediaSession();
                            if (currentMedia) { // Check if currentMedia is set
                                currentMedia.addUpdateListener(onMediaStatusUpdate);
                            }
                            // Update UI
                            playIcon.classList.add('hidden');
                            pauseIcon.classList.remove('hidden');
                            playIconMobile.classList.add('hidden');
                            pauseIconMobile.classList.remove('hidden');
                            playerContainer.classList.add('is-playing-glow');
                            playerContainerMobile.classList.add('is-playing-glow');
                            songArtEl.classList.add('is-active');
                            songArtMobileEl.classList.add('is-active');
                            updateLinerNotes(currentSongIndex);
                            updateMediaSessionState();
                        },
                        (errorCode) => {
                            console.error('Error loading media on cast device:', errorCode);
                            isPlaying = false;
                        }
                    );
                    return; // Don't play locally
                }
                
                // --- LOCAL PLAYBACK ---
                isPlaying = true;
                audioPlayer.play();
                
                // Update UI (both)
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
                playIconMobile.classList.add('hidden');
                pauseIconMobile.classList.remove('hidden');
                playerContainer.classList.add('is-playing-glow');
                playerContainerMobile.classList.add('is-playing-glow');
                songArtEl.classList.add('is-active');
                songArtMobileEl.classList.add('is-active');
                
                // Update notes and media session
                updateLinerNotes(currentSongIndex);
                updateMediaSessionState();
            }

            function pauseSong() {
                isPlaying = false;

                // --- CAST LOGIC ---
                if (isCasting && currentMedia) {
                    currentMedia.pause(null, 
                        () => { console.log("Cast media paused"); }, 
                        (e) => { console.error("Cast pause failed", e); }
                    );
                }
                
                // --- LOCAL PLAYBACK ---
                audioPlayer.pause();
                
                // Update UI (both)
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                playIconMobile.classList.remove('hidden');
                pauseIconMobile.classList.add('hidden');
                playerContainer.classList.remove('is-playing-glow');
                playerContainerMobile.classList.remove('is-playing-glow');
                songArtEl.classList.remove('is-active');
                songArtMobileEl.classList.remove('is-active');
                
                // Update notes and media session
                updateLinerNotes(null);
                updateMediaSessionState();
            }

            function prevSong() {
                currentSongIndex--;
                if (currentSongIndex < 0) currentSongIndex = songs.length - 1;
                loadSong(songs[currentSongIndex]);
                if (isPlaying) playSong();
            }

            function nextSong() {
                currentSongIndex++;
                if (currentSongIndex > songs.length - 1) currentSongIndex = 0;
                loadSong(songs[currentSongIndex]);
                if (isPlaying) playSong();
            }

            function updateProgress(e) {
                if (isCasting) return; // Cast session handles its own progress
                
                const { duration, currentTime } = e.srcElement;
                if (duration) {
                    const progressPercent = (currentTime / duration) * 100;
                    progressBar.value = progressPercent;
                    progressBarMobile.value = progressPercent;
                    
                    const durationFormatted = formatTime(duration);
                    const currentFormatted = formatTime(currentTime);
                    
                    durationTimeEl.textContent = durationFormatted;
                    currentTimeEl.textContent = currentFormatted;
                    durationTimeMobileEl.textContent = durationFormatted;
                    currentTimeMobileEl.textContent = currentFormatted;
                    
                    // Update Media Session progress
                    updateMediaSessionState(duration, currentTime);
                }
            }

            function formatTime(seconds) {
                if (isNaN(seconds)) return "0:00";
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            }

            function setProgress(e) {
                const value = e.target.value;
                if (isCasting && currentMedia) {
                    // Casting: Seek
                    const newTime = (value / 100) * currentMedia.media.duration;
                    const seekRequest = new chrome.cast.media.SeekRequest();
                    seekRequest.currentTime = newTime;
                    currentMedia.seek(seekRequest, 
                        () => console.log('Cast seek success'), 
                        (e) => console.error('Cast seek failed', e)
                    );
                } else {
                    // Local: Seek
                    const duration = audioPlayer.duration;
                    if (duration) {
                        const newTime = (value / 100) * duration;
                        audioPlayer.currentTime = newTime;
                        updateMediaSessionState(duration, newTime);
                    }
                }
            }
            
            function updateActivePlaylistItem() {
                const items = document.querySelectorAll('.playlist-item');
                items.forEach((item, index) => {
                    if (index === currentSongIndex) {
                        item.classList.add('active');
                        // Only scroll if the item is in a visible playlist
                        if (item.offsetParent !== null) {
                             item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }
                    } else {
                        item.classList.remove('active');
                    }
                });
            }
            
            function createPlaylistItems(playlistContainer, mobile) {
                songs.forEach((song, index) => {
                    const item = document.createElement('div');
                    item.classList.add('playlist-item', 'p-3', 'rounded-lg', 'cursor-pointer', 'hover:bg-gray-700', 'transition-colors', 'duration-200');
                    item.innerHTML = `
                        <p class="font-album-title tracking-wider truncate">${song.title}</p>
                        <p class="text-sm text-gray-400">${artistName}</p>
                    `;
                    item.addEventListener('click', () => {
                        currentSongIndex = index;
                        loadSong(song);
                        playSong();
                    });
                    playlistContainer.appendChild(item);
                });
            }
            
            // --- Media Session State (for truck progress bar) ---
            function updateMediaSessionState(duration, currentTime) {
                if ('mediaSession' in navigator && 'setPositionState' in navigator.mediaSession) {
                    try {
                        const durationValue = isCasting ? currentMedia?.media.duration : audioPlayer.duration;
                        const currentTimeValue = isCasting ? castMediaCurrentTime : audioPlayer.currentTime;
                        
                        if (!isNaN(durationValue) && !isNaN(currentTimeValue)) {
                            navigator.mediaSession.setPositionState({
                                duration: durationValue,
                                playbackRate: 1, 
                                position: currentTimeValue
                            });
                        }
                        navigator.mediaSession.playbackState = isPlaying ? "playing" : "paused";
                    } catch (error) {
                        console.warn("Failed to set media session state:", error);
                    }
                }
            }

            // --- 5. EVENT LISTENERS ---
            
            // --- Splash Screen ---
            enterBtn.addEventListener('click', startVideoTransition);
            splashVideo.addEventListener('ended', playIntroAudio);
            introAudioClip.addEventListener('ended', () => {
                // Wait 1 second after clip ends, then transition
                setTimeout(transitionToPlayer, 1000);
            });
            skipBtn.addEventListener('click', skipIntro);

            // --- Player Controls (Shared Logic) ---
            const playPauseHandler = () => {
                if (isPlaying) pauseSong();
                else playSong();
            };
            const prevHandler = () => prevSong();
            const nextHandler = () => nextSong();
            const progressHandler = (e) => setProgress(e);
            const flipperHandler = (e) => {
                 // Find the flipper for *this* player
                const flipperEl = e.currentTarget.id.includes('mobile') ? flipperMobile : flipper;
                flipperEl.classList.toggle('is-flipped');
            };

            // Desktop Listeners
            playPauseBtn.addEventListener('click', playPauseHandler);
            prevBtn.addEventListener('click', prevHandler);
            nextBtn.addEventListener('click', nextHandler);
            audioPlayer.addEventListener('timeupdate', updateProgress);
            audioPlayer.addEventListener('ended', nextSong);
            progressBar.addEventListener('input', progressHandler);
            linerNotesBtn.addEventListener('click', flipperHandler);
            
            // Mobile Listeners
            playPauseBtnMobile.addEventListener('click', playPauseHandler);
            prevBtnMobile.addEventListener('click', prevHandler);
            nextBtnMobile.addEventListener('click', nextHandler);
            // We need to listen to timeupdate on the *local* player for *both* mobile and desktop
            // The `updateProgress` function updates both sets of UI elements
            progressBarMobile.addEventListener('input', progressHandler);
            linerNotesBtnMobile.addEventListener('click', flipperHandler);
            
            // --- Media Session Actions (for truck buttons, etc.) ---
            if ('mediaSession' in navigator) {
                try {
                    navigator.mediaSession.setActionHandler('play', playSong);
                    navigator.mediaSession.setActionHandler('pause', pauseSong);
                    navigator.mediaSession.setActionHandler('previoustrack', prevSong);
                    navigator.mediaSession.setActionHandler('nexttrack', nextSong);
                    // For seeking
                    navigator.mediaSession.setActionHandler('seekto', (details) => {
                        const newTime = details.seekTime;
                        if (isCasting && currentMedia) {
                            const seekRequest = new chrome.cast.media.SeekRequest();
                            seekRequest.currentTime = newTime;
                            currentMedia.seek(seekRequest);
                        } else {
                            audioPlayer.currentTime = newTime;
                        }
                    });
                } catch (error) {
                    console.warn('Media Session action handlers failed to set:', error);
                }
            }

            // --- PWA Update Logic ---
            let newWorker; // To hold the new service worker

            // Show update button ONLY if PWA is installed
            if ('serviceWorker' in navigator) {
                 // Check if running as an installed PWA
                if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
                    updateBtnContainer.style.display = 'block';
                    updateBtnContainerMobile.style.display = 'block';
                }
                
                const updateButtonHandler = (e) => {
                    const isMobile = e.currentTarget.id.includes('mobile');
                    const statusEl = isMobile ? updateStatusMobile : updateStatus;
                    const btn = isMobile ? updateBtnMobile : updateBtn;

                    btn.disabled = true;
                    statusEl.textContent = 'Checking for updates...';
                    
                    // Manually trigger an update check
                    navigator.serviceWorker.getRegistration().then(reg => {
                        if (!reg) {
                            statusEl.textContent = 'Error: Not installed.';
                            return;
                        }
                        
                        reg.update().then(() => {
                            if (!reg.waiting) {
                                // No new version found
                                statusEl.textContent = 'You are up to date!';
                                btn.disabled = false;
                                setTimeout(() => { statusEl.textContent = ''; }, 3000);
                            }
                            // If reg.waiting *exists*, the 'updatefound' listener will handle it
                        });
                    });
                };

                updateBtn.addEventListener('click', updateButtonHandler);
                updateBtnMobile.addEventListener('click', updateButtonHandler);

                // Listen for a new service worker waiting to activate
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    // This fires when the new SW has taken control
                    window.location.reload();
                });
                
                navigator.serviceWorker.register('./sw.js').then(reg => {
                    console.log('Service worker registered.');
                    
                    // Listen for the "waiting" state
                    reg.addEventListener('updatefound', () => {
                        newWorker = reg.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // New SW is installed & waiting!
                                // Tell the user to restart
                                updateStatus.textContent = 'Update downloaded! Please restart app.';
                                updateStatusMobile.textContent = 'Update downloaded! Please restart app.';
                                
                                // Optional: skip waiting and force reload
                                // newWorker.postMessage({ action: 'skipWaiting' });
                            }
                        });
                    });
                    
                    // --- This is the "Checking for Updates" on load logic ---
                    // It's fast and won't block the UI
                    enterBtn.disabled = true;
                    enterBtn.textContent = 'Checking for Updates...';
                    
                    reg.update().then(() => {
                        // Update check is done (or failed, which is fine)
                        // Enable the "Click to Begin" button
                        enterBtn.disabled = false;
                        enterBtn.textContent = 'Click to Begin';
                    }).catch(err => {
                        // Fails offline, which is fine.
                        console.warn('Update check failed (likely offline):', err);
                        enterBtn.disabled = false;
                        enterBtn.textContent = 'Click to Begin';
                    });

                }).catch(err => {
                    console.error('Service worker registration failed:', err);
                    // Enable button anyway if SW fails
                    enterBtn.disabled = false;
                    enterBtn.textContent = 'Click to Begin';
                });
                
                // --- Message to trigger content caching ---
                // Send message *after* user clicks "Begin"
                enterBtn.addEventListener('click', () => {
                    if (navigator.serviceWorker.controller) {
                        navigator.serviceWorker.controller.postMessage({
                            action: 'cache-content'
                        });
                    }
                }, { once: true }); // Only run this once
            } else {
                 // No service worker support, just enable the button
                 enterBtn.disabled = false;
                 enterBtn.textContent = 'Click to Begin';
            }


            // --- 6. INITIALIZE PLAYER ---
            createPlaylistItems(playlistEl, false);
            createPlaylistItems(playlistMobileEl, true);
            
            // Load first song but don't set liner notes yet
            loadSong(songs[currentSongIndex]);
            // Set liner notes to the *album* notes initially
            updateLinerNotes(null);
            
            // Set initial state for media session
            updateMediaSessionState();
        });
    </script>
</body>
</html>

