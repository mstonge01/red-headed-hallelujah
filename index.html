<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Red-Headed Hallelujah</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter (sans-serif) and Staatliches (blocky, for title) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Staatliches&display=swap" rel="stylesheet">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json?v=2">
    <meta name="theme-color" content="#EF4444">
    
    <style>
        /* Custom styles to match the album art aesthetic */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Using 'Staatliches' for the main album title to mimic the cover font */
        .font-album-title {
            font-family: 'Staatliches', cursive;
        }

        /* Custom scrollbar for playlists */
        #playlist::-webkit-scrollbar,
        #video-playlist::-webkit-scrollbar,
        #flipper-back::-webkit-scrollbar {
            width: 8px;
        }
        #playlist::-webkit-scrollbar-track,
        #video-playlist::-webkit-scrollbar-track,
        #flipper-back::-webkit-scrollbar-track {
            background: #374151; /* gray-700 */
            border-radius: 10px;
        }
        #playlist::-webkit-scrollbar-thumb,
        #video-playlist::-webkit-scrollbar-thumb,
        #flipper-back::-webkit-scrollbar-thumb {
            background: #EF4444; /* red-500 */
            border-radius: 10px;
        }
        #playlist::-webkit-scrollbar-thumb:hover,
        #video-playlist::-webkit-scrollbar-thumb:hover,
        #flipper-back::-webkit-scrollbar-thumb:hover {
            background: #DC2626; /* red-600 */
        }

        /* Style for the currently active playlist item */
        .playlist-item.active {
            background-color: #EF4444; /* red-500 */
            color: #FFFFFF; /* white */
        }

        /* Custom style for the progress bar slider thumb */
        #progress-bar-container input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #EF4444; /* red-500 */
            border-radius: 3px;
            cursor: pointer;
            margin-top: -6px; /* Center the thumb on the track */
        }
        
        #progress-bar-container input[type=range]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #EF4444; /* red-500 */
            border-radius: 3px;
            cursor: pointer;
        }

        /* Custom style for the progress bar track */
        #progress-bar-container input[type=range] {
             -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: #4B5563; /* gray-600 */
            outline: none;
        }

        /* Class for the player texture */
        .player-texture {
            background-color: #1F2937; /* This is Tailwind's bg-gray-800 */
            background-image: url('https://www.transparenttextures.com/patterns/stucco.png');
        }
        
        /* 'Live Glow' Pulse Animation */
        @keyframes pulseGlow {
            0%, 100% {
                box-shadow: 0 0 10px rgba(239, 68, 68, 0.4), 0 0 12px rgba(239, 68, 68, 0.3);
            }
            50% {
                box-shadow: 0 0 16px rgba(239, 68, 68, 0.7), 0 0 20px rgba(239, 68, 68, 0.5);
            }
        }
        
        /* --- Flipper Styles --- */
        .flipper-container {
            perspective: 1000px;
            padding-top: 100%; /* Creates a 1:1 aspect ratio */
        }
        #flipper {
            transform-style: preserve-3d;
            transition: transform 0.8s;
        }
        #flipper.is-flipped {
            transform: rotateY(180deg);
        }
        .flipper-front,
        .flipper-back {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }
        #flipper-back {
            transform: rotateY(180deg);
            background-color: #4B5563; /* gray-600 */
            background-image: url('https://www.transparenttextures.com/patterns/concrete-wall.png');
        }
        #note-body {
            white-space: pre-wrap;
        }
        
        /* --- AI Modal Styles --- */
        #ai-modal {
            background-color: rgba(0, 0, 0, 0.7);
            transition: opacity 0.3s ease;
        }
        #ai-modal-content {
            background-image: url('https://www.transparenttextures.com/patterns/concrete-wall.png');
        }
        /* Spinner Animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .ai-spinner {
            border: 4px solid #4B5563; /* gray-600 */
            border-top: 4px solid #EF4444; /* red-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        /* --- Song Art Crossfade --- */
        #song-art {
            transition: opacity 0.5s ease-in-out;
            opacity: 0;
        }
        #song-art.is-visible {
            opacity: 1;
        }

        /* --- Splash Screen Styles --- */
        #enter-btn {
            background: rgba(239, 68, 68, 0.8); /* red-500 with 80% opacity */
            border: 2px solid rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
        }
        #enter-btn:hover {
            background: rgba(220, 38, 38, 1); /* red-600 */
            border-color: white;
            transform: scale(1.05);
        }
        #enter-btn:disabled, #update-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
        #update-status {
            background: rgba(17, 24, 39, 0.8); /* gray-900 with 80% opacity */
        }

        /* --- Skip Intro Button Style --- */
        #skip-intro-btn {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        #skip-intro-btn:hover {
            background: rgba(0, 0, 0, 0.75);
            border-color: rgba(255, 255, 255, 0.7);
        }

        /* --- Video Modal Styles --- */
        #video-modal {
            background-color: rgba(0, 0, 0, 0.9);
            transition: opacity 0.3s ease;
        }
        #video-modal-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 110;
            color: rgba(255, 255, 255, 0.7);
            transition: all 0.2s ease;
        }
        #video-modal-close-btn:hover {
            color: white;
            transform: scale(1.1);
        }
        #video-player {
            width: 100%;
            height: 100%;
            max-width: 95vw;
            max-height: 95vh;
        }

    </style>
</head>
<body class="bg-gray-900 text-gray-300 min-h-screen flex items-center justify-center p-4">

    <!-- Video Splash Screen -->
    <div id="splash-screen" class="fixed top-0 left-0 w-full h-full bg-gray-900 z-50 flex items-center justify-center opacity-100 transition-opacity duration-1000">
        
        <!-- Video: NO Autoplay -->
        <video id="splash-video" class="max-w-full max-h-full object-contain" preload="auto" playsinline>
            <source src="paint-video.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        
        <!-- Status / Button Container -->
        <div class="absolute inset-0 flex items-center justify-center">
             <!-- "Checking for Updates..." - Only shown on PWA app load -->
            <div id="update-status" class="hidden p-4 rounded-lg text-white font-album-title text-xl tracking-wider">
                Checking for Updates...
            </div>

            <!-- "Click to Begin" Button - Hidden until check is done -->
            <button id="enter-btn" class="hidden z-60 text-white p-4 px-8 font-album-title text-xl tracking-wider rounded-lg" disabled>
                Click to Begin
            </button>
        </div>

        <!-- Skip Intro Button -->
        <button id="skip-intro-btn" class="hidden absolute bottom-5 left-1/2 -translate-x-1/2 z-60 text-white px-4 py-2 rounded-lg text-sm hover:bg-black/75 transition">
            Skip Intro
        </button>
    </div>

    <!-- Main Player Container (starts invisible) -->
    <div id="player-container" class="w-full max-w-4xl opacity-0 transition-opacity duration-1000">
        
        <!-- Player Container -->
        <div class="player-texture shadow-2xl overflow-hidden flex flex-col md:flex-row">
            
            <!-- Left Side: Album Artwork & Liner Notes -->
            <div class="w-full md:w-1/2 flex-shrink-0 flex flex-col">
                <!-- Flipper container (1:1 aspect ratio) -->
                <div class="relative w-full flipper-container"> 
                    <div id="flipper" class="absolute top-0 left-0 w-full h-full">
                        <!-- FRONT (Album Art) -->
                        <div class="flipper-front absolute w-full h-full">
                            <!-- Main Album Art -->
                            <img src="cover.jpg.jpg" alt="Album Art for Red-Headed Hallelujah" class="w-full h-full object-cover">
                            <!-- Song-Specific Art (fades in) -->
                            <img id="song-art" src="" alt="Song-specific art" class="absolute top-0 left-0 w-full h-full object-cover">
                        </div>
                        <!-- BACK (Liner Notes) -->
                        <div id="flipper-back" class="flipper-back absolute w-full h-full p-6 overflow-y-auto flex flex-col">
                            <div class="flex-grow">
                                <h3 id="note-title" class="font-album-title text-3xl text-yellow-400 tracking-wider mb-4"></h3>
                                <p id="note-body" class="text-gray-200"></p>
                            </div>
                            <button id="ask-artist-btn" class="mt-4 w-full bg-yellow-400 text-gray-900 font-album-title tracking-wider text-lg p-2 hover:bg-yellow-300 transition-colors duration-200 rounded-md">
                                Ask the Artist
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Liner Notes Button -->
                <button id="liner-notes-btn" class="w-full bg-red-500 text-white font-album-title tracking-wider text-lg p-3 hover:bg-red-600 transition-colors duration-200">
                    Liner Notes
                </button>
                <!-- About Button -->
                <button id="about-btn" class="w-full bg-gray-600 text-white font-album-title tracking-wider text-lg p-3 hover:bg-gray-500 transition-colors duration-200">
                    About This App
                </button>
            </div>

            <!-- Right Side: Info, Controls, Playlist -->
            <div class="w-full md:w-1/2 p-6 flex flex-col justify-between">
                
                <!-- Top-Right: Current Song Info -->
                <div class="mb-4">
                    <p class="text-lg uppercase tracking-widest text-red-500 font-album-title">Now Playing</p>
                    <h2 id="song-title" class="text-3xl text-yellow-400 truncate font-album-title tracking-wider">Song Title</h2>
                    <h3 id="song-artist" class="text-lg text-gray-300">A mstonge01 Project</h3>
                </div>

                <!-- Middle-Right: Controls & Progress Bar -->
                <div class="mb-4">
                    <!-- Progress Bar -->
                    <div id="progress-bar-container" class="mb-3">
                         <input type="range" id="progress-bar" class="w-full h-1 bg-gray-700 rounded-lg cursor-pointer" value="0" min="0" max="100">
                    </div>
                    <!-- Time Display -->
                    <div class="flex justify-between text-sm text-gray-400">
                        <span id="current-time">0:00</span>
                        <span id="duration-time">0:00</span>
                    </div>

                    <!-- Controls -->
                    <div class="flex justify-center items-center space-x-6 mt-4">
                        <!-- Previous Button -->
                        <button id="prev-btn" class="text-gray-400 hover:text-red-500 transition-colors duration-200">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M8.445 14.832A1 1 0 0010 14.03V5.969a1 1 0 00-1.555-.832L4.12 9.168a1 1 0 000 1.664l4.325 4zM10.879 9.168a1 1 0 000 1.664l4.325 4A1 1 0 0017 14.03V5.969a1 1 0 00-1.555-.832l-4.325 4z"/></svg>
                        </button>
                        <!-- Play/Pause Button -->
                        <button id="play-pause-btn" class="w-16 h-16 bg-red-500 text-white rounded-full flex items-center justify-center text-2xl hover:bg-red-600 transition-colors duration-200 shadow-lg">
                            <!-- Play Icon -->
                            <svg id="play-icon" class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8.002v3.996a1 1 0 001.555.832l3.197-1.998a1 1 0 000-1.664l-3.197-1.998z" clip-rule="evenodd"/></svg>
                            <!-- Pause Icon (hidden by default) -->
                            <svg id="pause-icon" class="w-8 h-8 hidden" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h1a1 1 0 001-1V8a1 1 0 00-1-1H8zm5 0a1 1 0 00-1 1v4a1 1 0 001 1h1a1 1 0 001-1V8a1 1 0 00-1-1h-1z" clip-rule="evenodd"/></svg>
                        </button>
                        <!-- Next Button -->
                        <button id="next-btn" class="text-gray-400 hover:text-red-500 transition-colors duration-200">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M4.555 5.168A1 1 0 003 5.969v8.062a1 1 0 001.555.832l4.325-4a1 1 0 000-1.664l-4.325-4zM10.879 5.168A1 1 0 009.324 5.97v8.062a1 1 0 001.555.832l4.325-4a1 1 0 000-1.664l-4.325-4z"/></svg>
                        </button>
                    </div>
                </div>
                
                <!-- Bottom-Right: Tabs & Playlists -->
                <div class="flex-grow min-h-0 flex flex-col">
                    <!-- Tab Buttons -->
                    <div class="flex border-b border-gray-700 mb-2">
                        <button id="audio-tab-btn" class="flex-1 py-2 px-4 font-album-title tracking-wider text-lg bg-gray-700 text-white rounded-t-md">
                            Audio
                        </button>
                        <button id="video-tab-btn" class="flex-1 py-2 px-4 font-album-title tracking-wider text-lg text-gray-400 hover:bg-gray-700 hover:text-white transition-colors rounded-t-md">
                            Video
                        </button>
                    </div>

                    <!-- Playlist Container -->
                    <div class="flex-grow min-h-0 relative">
                        <!-- Audio Playlist -->
                        <div id="playlist" class="absolute inset-0 h-48 md:h-full max-h-48 lg:max-h-56 overflow-y-auto pr-2">
                            <!-- Playlist items will be injected here by JavaScript -->
                        </div>
                        <!-- Video Playlist -->
                        <div id="video-playlist" class="absolute inset-0 h-48 md:h-full max-h-48 lg:max-h-56 overflow-y-auto pr-2 hidden">
                            <!-- Video items will be injected here by JavaScript -->
                        </div>
                    </div>
                </div>


                <!-- Update Button (PWA Only) -->
                <div id="update-container" class="hidden text-center mt-4 p-2 border-t border-gray-700">
                    <button id="update-btn" class="text-sm text-gray-400 hover:text-red-500 transition-colors">
                        Check for Updates
                    </button>
                    <span id="update-status-text" class="text-sm text-gray-500 ml-2"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- The actual audio element, hidden from view -->
    <audio id="audio-player"></audio>
    <audio id="intro-audio" src="hallelujah-intro.mp3" preload="auto"></audio>

    <!-- AI Modal -->
    <div id="ai-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 opacity-0">
        <div id="ai-modal-content" class="player-texture w-full max-w-lg p-6 rounded-lg shadow-2xl border border-gray-700">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-album-title text-3xl text-yellow-400 tracking-wider">Artist's Note</h3>
                <button id="ai-modal-close-btn" class="text-gray-400 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                </button>
            </div>
            <!-- AI Content Area -->
            <div id="ai-modal-body" class="min-h-[150px] flex items-center justify-center">
                <!-- Spinner -->
                <div id="ai-modal-spinner" class="ai-spinner hidden"></div>
                <!-- Text Content -->
                <p id="ai-modal-text" class="text-gray-200 text-lg"></p>
            </div>
        </div>
    </div>

    <!-- Video Player Modal -->
    <div id="video-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 opacity-0">
        <button id="video-modal-close-btn" class="text-gray-400 hover:text-white transition-colors">
            <svg class="w-10 h-10" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
        </button>
        <video id="video-player" controls class="rounded-lg shadow-2xl" style="background-color: black;">
            <!-- Source will be set by JS -->
        </video>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 1. DATABASES ---
            const songs = [
                { 
                    title: "The Crimson Tide", 
                    src: "01-the-crimson-tide.mp3",
                    image_src: "01-the-crimson-tide-art.png",
                    note: `<b class="text-yellow-400 text-lg">The Song: A Mythic Opening Statement</b><br><br>As the opening track for an album dedicated to a "Red-Headed" muse, "The Crimson Tide" is a masterful and intentional choice. It’s not a simple love song; it’s a mythic sea shanty. The track opens with a raw, rhythmic, foot-stomping beat and group chants of "Hey! Ho!" that immediately conjure the image of sailors on the deck of a ship.<br><br>The instrumentation is perfectly spartan and elemental: a driving acoustic guitar, a relentless "stomp-clap" percussion, and powerful, layered "shanty-man" vocals. This genre choice is brilliant, as it immediately elevates the subject from a simple person to a legendary, elemental force—a figure of folklore.<br><br>The song re-frames the artist's first encounter with his muse as a classic sailor's legend. She is the "Crimson Tide"—an unstoppable, beautiful force of nature. The lyrics are a treasure trove of this metaphor:<br>She is a siren, with "her voice like gold" and "her laughter rang like a siren's song".<br>Her eyes are "green like kelp at dawn".<br>The artist is the sailor, "a man at sea" who is willingly and joyfully captured by this "red-head mermaid [who] stole my heart and dragged me down to where dreams start".<br><br>This isn't a song about "falling in love"; it's a raucous, celebratory tale of being "pulled... deep into the night" by a magical creature he has no desire to escape.<br><br><b class="text-yellow-400 text-lg">The Art: A Stunning, Layered Visual</b><br><br>The accompanying artwork is a literal and brilliant personification of the song's themes. Rendered in the album's signature "stencil graffiti" style, it depicts a mermaid against a stark concrete wall.<br><br>The power of the image comes from its two most specific details:<br>The "Crimson": The only color used is the vibrant, explosive red of the mermaid's flowing hair, a direct visual echo of the song's title and the album's central theme.<br>The Tattoo: In a stunning, meta-level of detail, the mermaid in the artwork has the exact same mermaid/wave sleeve tattoo on her arm that is seen on the muse in the main album cover.<br><br>This is not just a mermaid; this is a literal portrait of Rebecca as the mermaid, perfectly capturing the song's mythological framing. The art confirms that the "red-head mermaid" who "stole my heart" is one and the same as the real-life muse, complete with her own iconic ink.<br><br><b class="text-yellow-400 text-lg">Role on the Album</b><br><br>As the album's lead track, "The Crimson Tide" serves as a powerful declaration. It sets the stakes for the entire record, immediately introducing the "Red-Headed" woman not just as a wife or partner, but as a mythic, captivating, and beautiful force of nature who serves as the "Hallelujah" for the entire project.`
                },
                { 
                    title: "Real Women", 
                    src: "02-real-women.mp3",
                    image_src: "02-real-women-art.png",
                    note: `<b class="text-yellow-400 text-lg">The Song: A Gritty, Blues-Rock Anthem</b><br><br>This track is a shot of pure, unadulterated swagger. It's a gritty, blues-rock anthem that immediately establishes the muse's attitude. The sound is a significant and purposeful shift from the opener's "sea shanty" stomp. This is pure, fuzzed-out, southern-tinged rock. The song is built on a swampy, overdriven electric guitar riff, a low-end bass groove, and a confident, mid-tempo drum beat that feels like a confident strut. The raw, slightly snarled vocal delivery is a perfect match for the song's core thesis. The entire sonic palette feels like a direct nod to artists like The Black Keys or The Sheepdogs—it’s tough, it’s cool, and it has an undeniable groove.<br><br>The song's lyrical structure is a classic "contrast" anthem. The verses are a brilliant, biting takedown of superficiality, painting a picture of a "shallow scene" filled with:<br>"Pink manicures and little white lies"<br>"Little bows and kitten heels, scared to break a sweat"<br>Whispers of gossip in the hall<br><br>The verses build a "straw man" of delicate, inauthentic femininity, only for the chorus to explode as a triumphant, declarative statement of what the artist's muse truly is:<br>"Cause real women drive Jeeps, baby, rooftop down, Tearin' up the blacktop all over this town. Got the sun in our faces, dust in our hair, Don't need a paved road 'cause we don't really care."<br><br>The Jeep is the central, perfect symbol for her authenticity and adventurous spirit. The song celebrates her as someone who is not afraid to get her hands dirty, who lives by her own rules ("spinnin' the tires on a path of our own"), and whose very presence is a rebellious act. The line, "the only gossip we're spreadin' is the bass that shakes the ground," is a fantastic and powerful dismissal of the "whispers" from the verse.<br><br><b class="text-yellow-400 text-lg">The Art: A Literal, Perfect Portrait</b><br><br>The artwork for "Real Women" is perhaps the most direct and literal 1-to-1 translation of a song's theme on the entire album.<br><br>It is a signature-style stencil image of the red-headed muse sitting confidently in the driver's seat of a classic, door-off Jeep Wrangler. Her pose is casual, confident, and completely at ease, perfectly matching the "don't really care" attitude of the chorus.<br><br>This image is the chorus. It's not a metaphor or an abstract concept; it is the visual declaration that "this is her, this is what she drives, and this is why she's a badass." It powerfully connects the "real woman" of the song to the specific, red-headed muse of the album.<br><br><b class="text-yellow-400 text-lg">Role on the Album</b><br><br>After the mythic opener ("The Crimson Tide") introduced Rebecca as a legendary "mermaid," this track yanks her—and the listener—right back to earth in the most glorious way. It grounds the muse in a "real-world" identity, not just a fantasy. She isn't just a siren; she's a "real woman" with "dust in her hair." It establishes her personality as authentic, tough, and adventurous, setting the stage for the album to explore why this specific, real person is worthy of the "Hallelujah" to come.`
                },
                { 
                    title: "Red-Headed Hallelujah", 
                    src: "03-red-headed-hallelujah.mp3",
                    image_src: "03-red-headed-hallelujah-art.png",
                    note: `<b class="text-yellow-400 text-lg">The Song: The Album's Spiritual Core and Thesis Statement</b><br><br>This is the title track, and it is a profound and joyous explosion of pure, choir-backed gospel. It carries the entire emotional and spiritual weight of the record. The song is the "why" behind the whole project, a sonic statement of purpose that elevates the muse from a partner to a source of genuine, spiritual salvation.<br><br>The instrumentation is a powerful, driving piano, rhythmic percussion, and most importantly, a full-throated gospel choir that provides the exultant "Hallelujah! I'm gonna be alright!" refrain. The lead vocal is soulful and raw, delivering the lyrics with a sense of desperate, grateful praise.<br><br>The song's genius lies in its structure, which contrasts the secular "hell" of modern life with the divine "salvation" of her presence:<br>Verse 1 details the professional chaos: "The boss man's yelling, my desk's a mess," "This 9-to-5 feels like a sin."<br>Verse 2 details the domestic chaos: "Two boys screaming, the house is wild," "Spilled milk rivers and tantrum childs."<br>The Bridge is the moment of crisis, a full-blown anxiety attack where "breath is short," "the walls are closing," and he's "on my knees" in a desperate prayer.<br><br>The chorus is the answer to all of it. In every instance, just as the chaos becomes overwhelming, the music swells, and the "Hallelujah" is delivered:<br>"But then I see her, that red-headed light<br>Her smile burns through my darkest night<br>Oh Hallelujah, I'm gonna be alright"<br><br>The use of gospel music is not a gimmick; it is the most literal sonic expression of the song's meaning. She is his salvation, his "Hallelujah," his "red-headed light."<br><br><b class="text-yellow-400 text-lg">The Art: A Modern-Day Icon</b><br><br>The artwork for the title track is a direct, beatific portrait. Continuing the stencil style, it depicts the muse facing the viewer with a knowing, gentle smile.<br><br>The defining feature of this piece is the series of black "rays of light" that emanate from her head and red hair. This is a clear visual halo, a direct representation of the "red-headed light" from the lyrics. The image is a modern-day icon. It visually frames her as a saint, a divine figure of peace and radiance, which perfectly complements the song's celebratory, sacred, and "gospel" sound. This image is the "Hallelujah" in a single frame.<br><br><b class="text-yellow-400 text-lg">Role on the Album</b><br><br>This track is the central pillar, the emotional thesis, and the anchor for the entire album. After the first two tracks established who she is—a mythic mermaid ("The Crimson Tide") and a real-world badass ("Real Women")—this song explains what she means to him.<br><br>She is salvation. She is the anchor. She is the "Hallelujah" that makes the chaos of life not just bearable, but a place of joy. The fact that this song is presented three times (in gospel, acoustic, and piano arrangements) cements it as the album's central, recurring motif—the single most important idea that the artist needs to communicate.`
                },
                { 
                    title: "The Good Stuff", 
                    src: "04-the_good_stuff.mp3",
                    image_src: "04-the_good_stuff-art.png",
                    note: `<b class="text-yellow-400 text-lg">The Song: The "Meet-Cute" Origin Story</b><br><br>This track is a classic, upbeat, narrative-driven country-rock song. It’s the "origin story" of their entire relationship, told with a charming, self-deprecating wit. The music is built on a driving acoustic rhythm, a twangy electric guitar, and a "storyteller" vocal performance that makes the listener lean in.<br><br>The song masterfully sets up a double-entendre with the title "The Good Stuff."<br><br><b class="text-yellow-400 text-lg">The Setup (The "Bust"):</b> The verses tell a hilarious and hyper-specific story from their high school days. The artist's friend "had an 'in' on a class" and tried to set up a meeting for a girl he knew. The friend calls the artist on his "flip-phone" asking for a "favor" to "supply the flavor" for this girl who wanted the "experience." The mission is clear: the artist is supposed to show up and sell "the good stuff" (cannabis).<br><br><b class="text-yellow-400 text-lg">The Climax (The "True" Good Stuff):</b> The chorus is the pivotal moment where the plan hilariously fails, and his life changes forever. He arrives for the meeting—"We met up on a Saturday"—and sees the girl he was supposed to be a dealer for. He is instantly, completely thunderstruck:<br>"And that's the day I saw your face and stumbled where I fell.<br>You had that long red hair and freckles and a choker on your neck.<br>My brain just went offline, I was a total wreck."<br><br><b class="text-yellow-400 text-lg">The Punchline:</b> The "mission was a failure, a total epic bust." He was so floored by her that the original plan evaporated. The song's brilliant hook re-frames the title entirely:<br>"Who needs the good stuff when I'm looking at you?<br>My whole world changed that afternoon."<br><br>He went there to deliver "the good stuff" but found the real "good stuff"—her.<br><br><b class="text-yellow-400 text-lg">The Art: A Witty Visual Punchline</b><br><br>The artwork for this track is a perfect visual representation of the song's narrative and its double meaning. It's a stencil portrait of the red-headed muse in a hoodie, wearing glasses, and holding a lit cigarette or joint, with a wisp of smoke curling upwards.<br><br>This image is a direct, witty nod to the "substance" that was the entire (failed) premise of their meeting. The casual hoodie and glasses give her an authentic, "high school" vibe that perfectly matches the story's time and place. It’s a "portrait of the girl" from that fateful, "total epic bust" of a day.<br><br><b class="text-yellow-400 text-lg">Role on the Album</b><br><br>After the myth ("The Crimson Tide"), the attitude ("Real Women"), and the thesis ("Red-Headed Hallelujah"), this track provides the essential foundation. It's the "how we met" story. It grounds their entire relationship in a specific, funny, and endearingly "imperfect" moment. It’s the narrative starting gun for the whole "biography" of the album, reinforcing the core theme of finding a sacred love in the most profane or comically mundane of circumstances.`
                },
                { 
                    title: "Zero Degree Beach", 
                    src: "05-zero-degree-beach.mp3",
                    image_src: "05-zero-degree-beach-art.png",
                    note: `<b class="text-yellow-400 text-lg">The Song: An Ode to an Adorable Quirk</b><br><br>This track is a piece of charming, quirky indie-pop. It's light, bouncy, and filled with a sense of playful adoration. The instrumentation, featuring bright, clean electric guitars and a simple, driving beat, gives the song an optimistic and sweet-natured feel.<br><br>The lyrics are a hyper-specific, tender, and deeply personal portrait of one of the muse's most unique habits. The song opens by setting a vivid scene: it is a freezing cold Canadian day ("I check the thermostat, read the outside air... 'don't go out there'"), and the artist is layering up ("zipping up my jacket, putting gloves on my hand").<br><br>But then, he hears the "click-clack coming down the hall." It's his wife, who, in defiance of the "freezer-grip" of the "northern land," is heading out in her flip-flops.<br><br>The chorus is a brilliant piece of lyrical re-framing. He doesn't just call it a "quirk"; he elevates it to a place of defiant, personal freedom. He lovingly calls her habit the "Zero-Degree Beach"—a place of comfort and independence that only she can access.<br>"She's walking on the zero-degree beach,<br>The comfort of that plastic, nothing else can reach.<br>...A beautiful, stubborn habit that the cold can't teach."<br><br>He sees this act not as madness, but as a "secret summer" and "the only summer that exists beneath her feet." He even calls it the "perfect life hack," a "choice of her own weather" and "her own peace." The song is a beautiful testament to finding profound meaning and beauty in a partner's smallest, most specific eccentricities.<br><br><b class="text-yellow-400 text-lg">The Art: A Whimsical, Focused Snapshot</b><br><br>The artwork for this track is a whimsical and perfect visual summary. It's a "snapshot" in the stencil style, focusing only on a pair of legs and feet, clad in a patterned skirt or dress and a pair of flip-flops.<br><br>The image is focused, just like the song, on this single, defining quirk. The only color used is the pop of red, but this time it's not on the hair—it's on the toenails. This is a clever and subtle visual twist that keeps the "red" motif alive while being 100% faithful to the song's subject. It’s a playful, intimate, and loving visual representation of her "beautiful, stubborn habit."<br><br><b class="text-yellow-400 text-lg">Role on the Album</b><br><br>This song adds a crucial layer of deep intimacy to the album. We've had the "myth," the "attitude," the "salvation," and the "origin story." This track is the "intimate portrait." It’s a song that could only be written by someone who has spent years lovingly observing this person, someone who knows and adores her every lovable "weird" habit. It shows that his "Hallelujah" isn't just for the big, legendary moments; it's for the small, quiet, "Zero-Degree Beach" moments, too.`
                },
                { 
                    title: "Caps", 
                    src: "06-caps.mp3",
                    image_src: "06-caps-art.png",
                    note: `<b class="text-yellow-400 text-lg">The Song: A Plucky, Hilarious "Dad Joke" Ode</b><br><br>This track is a plucky, charming, and utterly disarming acoustic folk song. It is, in essence, a "dad joke" elevated to the level of high romantic art. The instrumentation is simple and bright—a happy, upbeat acoustic guitar, a simple rhythm, and a conversational, almost "smirking" vocal. The entire song is a loving and minutely detailed appreciation of his wife's... kneecaps.<br><br>This is the album at its most audaciously specific and personal. The song works because it's so sincere in its silliness. It's a love song that finds beauty not in the poetic (eyes, lips) or the sexual, but in the most mundane and overlooked.<br><br>The verses are a celebration of her legs:<br>"They go on for miles like a highway line"<br>"So smooth and silky, Lord, they're fine"<br>"A masterpiece of biology"<br><br>But the chorus is the brilliant, hilarious pivot. After building up the "best pair of legs in all the land," he reveals his true, specific fascination:<br>"But oh, your tiny kneecaps<br>They're like little bottle caps<br>Just sitting there so neat and small<br>They're the cutest part of all."<br><br>He calls them his "favorite maps, leading me to paradise." The song is a playful, intimate, and profoundly "inside" joke. It's a testament to a long-term, comfortable love where you can not only notice but celebrate the silliest, most specific parts of your partner. It's an expression of "I see all of you, and I adore every ridiculous, wonderful bit."<br><br><b class="text-yellow-400 text-lg">The Art: The "Bottle Cap" Personified</b><br><br>The artwork for "Caps" is a perfect companion piece to the song. It’s a full-body stencil portrait of the red-headed muse in a classic pin-up style pose: squatting or sitting, with her knees bent and her arms wrapped around them, all while wearing sunglasses and flip-flops.<br><br>The pose is the key. It's a pose that naturally and playfully makes her kneecaps the central, focal point of her silhouette. The sunglasses add a "cool" factor, while the red hair again identifies her as the muse. It’s a playful, slightly flirty image that directly references the "cutest part of all" by its very composition.<br><br><b class="text-yellow-400 text-lg">Role on the Album</b><br><br>This track is the album's "comic relief" and, simultaneously, one of its most intimate statements. It's the ultimate "in-joke." After the myth, the attitude, the "meet-cute," and the deep, quirky "Zero-Degree Beach," this song brings the adoration to a micro, almost comically-zoomed-in level. It’s a bold declaration that his love is so comprehensive, it even includes odes to her "tiny bottle caps." It's a song of pure, comfortable, long-term adoration, and it adds a critical layer of lighthearted joy and humor to the album's biography.`
                },
                { 
                    title: "Interrupted", 
                    src: "07-interrupted.mp3",
                    image_src: "07-interrupted-art.png",
                    note: `<b class="text-yellow-400 text-lg">The Song: A Raucous, Real-Life Rock and Roll Lament</b><br><br>This track is an upbeat, driving, and comically frustrated bar-room rock and roll narrative. It's the perfect, unvarnished sequel to the sacredness of a song like "Natural Magic." While that track celebrates the magic of motherhood, "Interrupted" is the hilarious, 100% relatable story of the reality of being parents—specifically, the endless, comedic quest to find a single moment of intimacy.<br><br>The song is a masterclass in narrative setup and punchline.<br><br><b class="text-yellow-400 text-lg">Attempt 1:</b> The scene is set perfectly. "The kids are down, the house is finally still." He's setting the mood ("flip the deadbolt"), but just as he makes his move... The Dog "starts barking like he's seen a ghost." The mood is shattered. He's "Busted! Interrupted!"<br><br><b class="text-yellow-400 text-lg">Attempt 2:</b> They try again ("Take two, we're back behind the door"). He puts on "something slow and deep," leans in for the kiss... The Kids. A "little voice" ("Dad, I'm thirsty!") from a nightmare. He's exasperated, "Are you kidding me!?"<br><br>The bridge is a fantastic montage of other failed attempts—the "mailman rang the bell," the "alarm clock went to hell." It's a universal lament for any parent, culminating in the triumphant final-verse solution: a "proper date" night. The song ends in victory, with the couple returning to a "dark and quiet" house, finally "NOT interrupted," and ready to "love her on the sofa, on the bed, and on the floor."<br><br><b class="text-yellow-400 text-lg">The Art: The "Interrupted" Fantasy</b><br><br>The artwork is a brilliant visual representation of the song's goal. It depicts the red-headed muse in the signature stencil style, lying playfully and invitingly on a couch, clad in lingerie or a bikini.<br><br>This image is the "mood" from the first verse. It's the "look in her eye," the "sweet woman... giving me that thrill." It is the romantic, intimate moment that the artist is trying to get to, but is "interrupted" from at every turn by the dog and the kids. The fact that she's on a couch also provides a great visual link to the song's triumphant final line.<br><br><b class="text-yellow-400 text-lg">Role on the Album</b><br><br>This track is the album's "comic-reality" set piece. It's a crucial, grounding moment that reinforces the album's core theme of "real-life love." It's the perfect, chaotic companion piece to the album's "Hallelujah" theme. It says that their love isn't just a "Red-Headed Hallelujah" in the face of outside chaos; it's also a love that has to hilariously fight for its own survival against the domestic chaos they've built together. It’s a funny, honest, and deeply loving portrait of a real relationship.`
                },
                { 
                    title: "Cinnamon Serenade", 
                    src: "08-cinnamon-serenade.mp3",
                    image_src: "08-cinnamon-serenade-art.png",
                    note: `<b class="text-yellow-400 text-lg">The Song: A Gritty, Hilarious, "In-Joke" Love Story</b><br><br>This track is a low-slung, swampy, blues-rock narrative. It's the "bad night" story that has become a legendary "in-joke" in a long-term relationship. The instrumentation is fittingly gritty, built on a heavy electric guitar riff and a "stomp-stomp-clap" drum beat that feels like a bit of a drunken lurch. The vocal delivery is part-storyteller, part-confessional.<br><br>The lyrics tell a hyper-specific, raw, and incredibly funny story:<br><br><b class="text-yellow-400 text-lg">The Setup:</b> The scene is set perfectly at the family cabin ("The cabin lights were settled in, the family fast asleep"). The artist goes to bed ("I said goodnight my darlin' and hit the flannel sheets").<br><br><b class="text-yellow-400 text-lg">The Culprit:</b> His wife, however, "stayed out by the fire glow, sipping something sweet" – "A bottle full of cinnamon, they call it Fireball."<br><br><b class="text-yellow-400 text-lg">The Climax:</b> The inevitable happens. "3 AM came calling with a crash and then a moan." He wakes up to find her "clutching the plastic throne."<br><br><b class="text-yellow-400 text-lg">The "Serenade":</b> This is the core of the song and the brilliance of the title. In this most unglamorous, messy moment, he doesn't scold or complain. He becomes her "humble servant in the pale moonlight, holding back your lovely hair with all my might."<br><br>The chorus is a masterpiece of reframing. He finds romance and devotion in this moment, declaring:<br>"It wasn't wine and roses, It wasn't graceful, no.<br>But you're my Cinnamon Queen, Even watching a bourbon flow."<br><br>It's a "serenade" to a moment of total, unvarnished, human messiness. It's a powerful statement of "I love you through everything, even this."<br><br><b class="text-yellow-400 text-lg">The Art: The "Morning After" Toast</b><br><br>The artwork is a perfect visual punchline to the story. It's a stencil portrait of the red-headed muse in a bathrobe, her hair slightly disheveled. She is holding a rocks glass (like a bourbon tumbler) up in a "toast" or "cheers" gesture.<br><br>The image is a fantastic "morning after" (or "late night") portrait. The robe gives it the perfect intimate, "cabin-night" feel from the song. The glass she's holding is a direct, defiant nod to the "Cinnamon" and "bourbon" that caused the entire "serenade." Her expression is a mix of cool confidence and a knowing "well, that happened" smirk.<br><br><b class="text-yellow-400 text-lg">Role on the Album</b><br><br>This track is a crucial piece of the album's "biography." If "The Good Stuff" was the sweet "meet-cute" origin, "Cinnamon Serenade" is the "raw and real" legend of their adult life together. It reinforces the album's core theme of rejecting polished, greeting-card love. It's a testament to a deep, comfortable, "in it together" relationship, where being a "humble servant" holding back her hair is its own kind of "Hallelujah." It's the ultimate "in-joke" love song, finding beauty and devotion in the most unbeautiful of moments.`
                },
                { 
                    title: "Golden Devotion", 
                    src: "09-golden-devotion.mp3",
                    image_src: "09-golden-devotion-art.png",
                    note: `<b class="text-yellow-400 text-lg">The Song: A Quiet, Sun-Worshipping Hymn</b><br><br>This track is a moment of pure, hushed reverence. It's a gentle, acoustic-driven ballad that serves as a quiet hymn to the muse. The instrumentation is sparse and warm, primarily featuring a delicate acoustic guitar and a soft, tender vocal. The entire song feels like a whisper, a private observation of a sacred moment.<br><br>The song's lyrical theme is a "devotion to her devotion." The artist is lovingly describing his wife as a "sun-worshipper," someone who draws life, energy, and a "glow" from the sun.<br><br>He describes her connection to the sun as intimate and personal: "The summer kisses her fragile frame / Each freckle whispers the sun's name."<br>He sees it as a source of power and life for her: "The cold can't hold her down / She's glowing like a crown."<br><br>The chorus is a simple, repeated, mantra-like declaration: "Oh, she worships the sun / Feel the heat, she's undone / Every ray a soft embrace... Oh, she worships the sun."<br><br>This song is the "yang" to "Zero-Degree Beach's" "yin." While that track celebrated her defiant, quirky rejection of the cold, this song is a beautiful, "golden" ode to her loving embrace of the heat. It paints her as an elemental creature who thrives in the "burning bright" light.<br><br><b class="text-yellow-400 text-lg">The Art: The Sun-Worshipper's Portrait</b><br><br>The artwork for "Golden Devotion" is a direct and powerful portrait of the "sun-worshipper" herself. It's a chest-up stencil of the red-headed muse, facing the viewer with a calm, confident expression.<br><br>The single most important detail of the image is her dark sunglasses. This is the quintessential accessory of a "sun-worshipper," someone "feeling the heat" and "burning bright" in the sun's rays. The tank top she's wearing also clearly displays her signature mermaid tattoo, linking this "golden" version of her to the "mermaid" from "The Crimson Tide." It's a simple, elegant, and "cool" image that perfectly captures the song's theme of her elemental connection to the sun.<br><br><b class="text-yellow-400 text-lg">Role on the Album</b><br><br>This track provides a crucial pause for quiet, simple adoration. After the loud, narrative, and "story-driven" rock of the preceding tracks ("Interrupted" and "Cinnamon Serenade"), "Golden Devotion" strips everything away. It's not a story; it's a simple, "Hallelujah" of praise. It's a moment of "holy" quiet, a soft, golden hymn that allows the listener (and the artist) to just admire the muse in her natural, sun-kissed element. It's a breath of warm air before the album's emotional climax, "Natural Magic."`
                },
                { 
                    title: "Natural Magic", 
                    src: "10-natural-magic.mp3",
                    image_src: "10-natural-magic-art.png",
                    note: `<b class="text-yellow-400 text-lg">The Song: The Reverent, Emotional Climax</b><br><br>This track is the true, emotional climax of the album. It is a stunningly tender, quiet, and reverent lofi ballad. The song's instrumentation is a perfect shift, creating a sense of intimacy and awe. It's built on a simple, gentle beat, a warm bassline, and a soft, almost-whispered vocal. This is the "Red-Headed Hallelujah" in its most personal and sacred form: the "Hallelujah" of a mother.<br><br>The lyrics are a direct, loving observation of his wife in her role as a mother, and he frames her abilities as a kind of effortless, "Natural Magic."<br><br><b class="text-yellow-400 text-lg">Verse 1</b> sets the scene of domestic chaos: "Coffee's cold on the counter," "Fifty sets of boots by the door," "came-in-stuff being scattered like a technicolor storm." He is lost in this chaos ("I'm just trying to find my keys").<br><br><b class="text-yellow-400 text-lg">The Chorus</b> is the revelation. He sees her in the middle of it all, not just coping, but commanding the chaos with a grace he can't understand:<br>"You're the calm inside the hurricane<br>A whisper word that stops the rain<br>It's an instinct I can't understand<br>How you heal the world just with your hand "<br><br><b class="text-yellow-400 text-lg">Verse 2</b> reinforces this theme, showing her as the ultimate protector and nurturer: "A nose bleed and a sudden cry / You're there before the tear can dry." He describes her as "a judge, a nurse, a storyteller / A fortress and a soft warm pillow."<br><br>The song is a profound admission of awe. He is "just caught here in the view," watching her "Natural Magic." The final, beautiful line of the chorus—"Oh, the way you mother, making everything right"—is the song's entire thesis. It's the ultimate expression of his "Hallelujah."<br><br><b class="text-yellow-400 text-lg">The Art: A Modern "Madonna and Child"</b><br><br>The artwork for "Natural Magic" is the most emotionally resonant piece in the collection. It is a direct, visual representation of the song's theme, rendered in the album's signature "stencil" style.<br><br>It depicts the red-headed muse holding a small child, an infant or toddler, in her arms. She is looking out at the viewer with a gentle, knowing, and powerful "mother's" expression. The child is nestled securely against her.<br><br>This image is a modern-day "Madonna and Child." It is a sacred, iconic portrait of her in her most powerful role: the "mother" from the lyrics. The use of the "graffiti" style on a concrete wall adds a beautiful layer of "real-world" strength to this traditionally "soft" image. She is not just a gentle, classical mother; she is a strong, real, "concrete" protector.<br><br><b class="text-yellow-400 text-lg">Role on the Album</b><br><br>This track is the emotional heart of the entire record. If "Red-Headed Hallelujah" is the thesis (she is his salvation), "Natural Magic" is the proof. It provides the deepest, most profound reason for his praise.<br><br>It comes late in the album, serving as the emotional peak before the bonus-track "encores." It's the culmination of all the other songs: the "mermaid," the "real woman," the "high school sweetheart," the "cinnamon queen" – all of these roles have led to this one, the most sacred of all: the "mother" who makes everything right. It is, perhaps, the album's truest, deepest "Hallelujah."`
                },
                { 
                    title: "Red-Headed Hallelujah (Guitar)", 
                    src: "11-red-headed-hallelujah-guitar.mp3",
                    image_src: "11-red-headed-hallelujah-guitar-art.png",
                    note: `<b class="text-yellow-400 text-lg">The Song: The Intimate, "Campfire" Version</b><br><br>This version is a warm, intimate, and "rootsy" acoustic take. The instrumentation is centered on a clean, confidently strummed acoustic guitar, a simple, understated beat, and a more "singer-songwriter" vocal performance. The full, joyous "choir" of the original is replaced with more subtle, layered backing vocals, giving it a feeling of a close-knit group singing together.<br><br>The effect is transformative. If the "gospel" version was a joyous shout of praise from a crowded church, this "Guitar" version is an intimate "serenade" sung by a campfire. It takes the "Hallelujah" from a public declaration to a personal one. The message feels less "I'm saved!" and more "You save me." It’s a version that feels perfect for the "cabin" setting mentioned in "Cinnamon Serenade"—it's grounded, warm, and deeply personal.<br><br><b class="text-yellow-400 text-lg">Role on the Album</b><br><br>As the first bonus track, it serves as a beautiful "come down" from the emotional peak of "Natural Magic." It gently re-centers the listener on the album's core thesis, presenting the "Hallelujah" in a new light: as a song of comfort, warmth, and personal devotion.`
                },
                { 
                    title: "Red-Headed Hallelujah (Piano)", 
                    src: "12-red-headed-hallelujah-piano.mp3",
                    image_src: "12-red-headed-hallelujah-piano-art.png",
                    note: `<b class="text-yellow-400 text-lg">The Song: The "Vulnerable" Lullaby Version</b><br><br>This final track is the album's most vulnerable and emotionally raw statement. It strips the song down to its absolute, barest essentials: a sparse, delicate piano and a single, soulful vocal. The tempo is slowed slightly, and the vocal delivery is softer, more fragile, and filled with a tender reverence.<br><br>This is the "Hallelujah" as a whisper in the dark. It is the "lullaby" version, the "quiet moment after the kids are finally asleep" version. The piano notes hang in the air, giving weight to every word. The "desperation" of the original ("breath is short," "walls are closing") feels more immediate and real in this sparse setting, making the "red-headed light" feel like an even more profound, quiet miracle.<br><br><b class="text-yellow-400 text-lg">Role on the Album</b><br><br>As the album's closer, this track is a masterstroke. It’s the final, definitive, and most intimate reading of the album's central theme. The record, which began with a raucous, stomping "Hey! Ho!" ("The Crimson Tide"), now ends on the quietest, most delicate note possible. It’s a perfect bookend, resolving all the "chaos" (from "Interrupted," "Real Women," etc.) into this one, simple, beautiful moment of peace. It's the final "Amen" to the album's prayer.`
                },
            ];

            const videos = [
                {
                    title: "Red-Headed Hallelujah",
                    src: "red-headed-hallelujah.mp4",
                    thumbnail: "03-red-headed-hallelujah-art.png" // Use song art as thumbnail
                }
                // Add more videos here as you make them
            ];

            const artistName = "A mstonge01 Project";
            const albumTitle = "Red-Headed Hallelujah";
            const albumNote = `A Raw, Raucous, and Deeply Personal Sonic Biography<br><br>'Red-Headed Hallelujah' is not merely an album; it is a meticulously crafted sonic biography, a "mixtape" of a life shared. Under the artist name 'A mstonge01 Project', this collection of songs serves as a hyper-specific and unflinchingly honest tribute to a single muse: the artist's wife, Rebecca. The album's power lies in its complete rejection of generic, greeting-card sentiment. Instead, it builds a musical monument out of specific, shared memories—from the hilarious and the quirky to the profound and the sacred.<br><br>The album title itself is the record's central thesis. "Red-Headed" is the physical identifier, the recurring visual motif, the muse. "Hallelujah" is the emotional response—a word that is at once a cry of praise, a sigh of relief, and an acknowledgment of salvation. This concept is so central, it is rightfully presented in three different musical settings (gospel, acoustic, and piano), acting as the album's anchor.<br><br><b class="text-yellow-400 text-lg">The Visual Aesthetic: A Street-Art Shrine</b><br><br>The album's visual language is as powerful and defined as its music. The cover and all accompanying song art share a unified "stencil graffiti" style. This choice is brilliant. It presents these images as raw, edgy, and permanent declarations, spray-painted on the rough, imperfect texture of a concrete wall.<br><br>The palette is a stark, high-contrast black on grey, which makes the one, singular "pop" color—that vibrant, defiant red—all the more explosive. This red is used almost exclusively for Rebecca's hair, visually cementing her as the album's central, blazing focus.<br><br>This is not a soft-focus fantasy. This is a cool, real, and undeniable tribute. The specificity is astounding, most notably on the album cover and the art for "The Crimson Tide," which perfectly capture the real-life mermaid tattoo on her arm. This is not a generic woman; this is her. The art says what the music confirms: this love is not polished or perfect, it is real, it has grit, and it's worthy of being shouted from the rooftops (or, in this case, immortalized on a public wall).<br><br><b class="text-yellow-400 text-lg">The Sonic Journey: A Mixtape of a Life</b><br><br>Musically, 'Red-Headed Hallelujah' is a wonderfully eclectic journey, mirroring the diverse "record collection" of a life lived together. It refuses to be boxed into one genre, instead pulling from the perfect sound to tell each specific story.<br><br>The album opens with the stomping, mythic sea shanty of "The Crimson Tide."<br>It swerves into the gritty, southern blues-rock of "Real Women," a track that feels like it could have been pulled from a Black Keys or The Sheepdogs record.<br>It then explodes into the full-throated, choir-backed gospel of the title track, "Red-Headed Hallelujah."<br>This is followed by the upbeat, narrative-driven country-rock of "The Good Stuff," the quirky and tender indie-pop of "Zero-Degree Beach," and the plucky, comedic acoustic folk of "Caps."<br><br>The back half of the album leans into raucous, bar-room rock and roll with "Interrupted," gets low and swampy with the bluesy, storytelling of "Cinnamon Serenade," and then quiets down for the reverent, acoustic hymn "Golden Devotion" and the tender, lofi ballad "Natural Magic."<br><br>The common thread is an raw authenticity. The production is clean but never sterile, allowing the storytelling and the genuine, varied instrumentation—from roaring electric guitars and banjos to soulful choirs and intimate piano—to take center stage.<br><br><b class="text-yellow-400 text-lg">The Lyrical Pillars: A Biography in Song</b><br><br>This is the heart of the album. The lyrics form a mosaic of a shared history, built on three distinct pillars.<br><br><b class="text-yellow-400 text-lg">1. The Origin & The "Lore":</b> The album documents the legendary "key moments" that build a relationship's private lore. "The Good Stuff" is the perfect "meet-cute" origin story, a fantastic piece of country-rock narrative about a comically failed high-school plan that led to the most important meeting of his life. On the other end of the spectrum is "Cinnamon Serenade," a raw, hilarious, and deeply "in-joke" story of a specific, messy night with Fireball. It’s a testament to loving someone through the imperfect, real-life moments, not just the idealized ones.<br><br><b class="text-yellow-400 text-lg">2. A Hymn to the Muse (The Quirks and the Power):</b> Several tracks are pure, observational praise of Rebecca's unique personality. "The Crimson Tide" is a brilliant, mythic anthem that transforms her red hair and mermaid tattoo into the stuff of legends. "Real Women" is a badass, gritty anthem celebrating her attitude and her Jeep. Then, you have the more intimate odes: "Zero-Degree Beach" is a tender, loving portrait of a magnificent "quirk"—her insistence on wearing flip-flops in the Canadian winter, which he re-frames as her "secret summer." And most audaciously, there is "Caps," a plucky, hilarious "dad joke" of a song that finds beauty and adoration in the most specific and mundane of places: her kneecaps.<br><br><b class="text-yellow-400 text-lg">3. The Anchor in the Chaos (The "Hallelujah"):</b> This is the album's emotional core. The title track, "Red-Headed Hallelujah," serves as the thesis: the world is chaos ("Boss man's yelling," "two boys screaming"), but she is the "red-headed light" who burns through it and makes him "gonna be alright."<br><br>The album then beautifully explores both the sacred and the profane sides of this. "Natural Magic" is a stunning, quiet, and reverent ballad about her power as a mother—her "quiet strength," her "healing the world with your hand," her "calmest place I've ever known." It is the album at its most tender. This is immediately and hilariously contrasted by "Interrupted," the real-life, rock-and-roll sequel. It’s a song about the chaotic, un-sexy, and loving reality of being parents—the dog, the nightmares ("Dad, I'm thirsty!"), and the constant, loving failure to find a moment alone. It is the perfect encapsulation of the album's themes: the love is sacred, but the life is a glorious, interrupted mess.<br><br><b class="text-yellow-400 text-lg">Conclusion: A Masterpiece of Personalization</b><br><br>'Red-Headed Hallelujah' is an overwhelming success as a project. It works because it is so unflinchingly specific. The love here is not defined by clichés, but by "tiny bottle caps," a "cinnamon serenade," flip-flops in the snow, and a Jeep.<br><br>By presenting the title track in three distinct versions, the album hammers home its central message: this person is a source of praise (the gospel version), a source of comfort (the acoustic version), and a source of profound, quiet love (the piano version).<br><br>It is a raw, funny, edgy, and beautiful testament to a life built together—a complete and stunningly personal work of art.`;
            const albumName = "Red-Headed Hallelujah";

            // --- 2. DOM ELEMENT REFERENCES ---
            const splashScreen = document.getElementById('splash-screen');
            const splashVideo = document.getElementById('splash-video');
            const enterBtn = document.getElementById('enter-btn');
            const skipIntroBtn = document.getElementById('skip-intro-btn');
            const updateStatusEl = document.getElementById('update-status'); // "Checking for Updates..." message
            const playerContainer = document.getElementById('player-container');
            const audioPlayer = document.getElementById('audio-player');
            const introAudio = document.getElementById('intro-audio');
            const songTitleEl = document.getElementById('song-title');
            const songArtistEl = document.getElementById('song-artist');
            
            const playPauseBtn = document.getElementById('play-pause-btn');
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const progressBar = document.getElementById('progress-bar');
            const currentTimeEl = document.getElementById('current-time');
            const durationTimeEl = document.getElementById('duration-time');
            const linerNotesBtn = document.getElementById('liner-notes-btn');
            const flipper = document.getElementById('flipper');
            const noteTitleEl = document.getElementById('note-title');
            const noteBodyEl = document.getElementById('note-body');
            const songArtEl = document.getElementById('song-art');
            const mainPlayerDiv = document.querySelector('.player-texture');
            
            // AI Modal Elements
            const aiModal = document.getElementById('ai-modal');
            const aiModalContent = document.getElementById('ai-modal-content');
            const aiModalCloseBtn = document.getElementById('ai-modal-close-btn');
            const askArtistBtn = document.getElementById('ask-artist-btn');
            const aiModalSpinner = document.getElementById('ai-modal-spinner');
            const aiModalText = document.getElementById('ai-modal-text');

            // "About" Button
            const aboutBtn = document.getElementById('about-btn');

            // Update Button Elements
            const updateContainer = document.getElementById('update-container');
            const updateBtn = document.getElementById('update-btn');
            const updateStatusText = document.getElementById('update-status-text');

            // Video & Tab Elements
            const audioTabBtn = document.getElementById('audio-tab-btn');
            const videoTabBtn = document.getElementById('video-tab-btn');
            const playlistEl = document.getElementById('playlist');
            const videoPlaylistEl = document.getElementById('video-playlist');
            const videoModal = document.getElementById('video-modal');
            const videoModalCloseBtn = document.getElementById('video-modal-close-btn');
            const videoPlayer = document.getElementById('video-player');


            // --- 3. PLAYER STATE ---
            let currentSongIndex = 0;
            let isPlaying = false;
            let hasUserInteracted = false;
            let isAiModalOpen = false; // Track modal state
            let isVideoModalOpen = false; // Track video modal state

            // --- 4. FUNCTIONS ---

            // About Text
            const aboutTitle = "About Red-Headed Hallelujah";
            const aboutText = `Welcome to Red-Headed Hallelujah, a digital music experience that is part concept album, part street-art gallery, and part AI-assisted love letter. This project was conceived and directed by mstonge01 as a dedicated gift to his wife, Rebecca, blending personal storytelling with cutting-edge technology.<br><br>This isn't just a website. It's a custom-built Progressive Web App (PWA), designed from the ground up to work perfectly on any device, from a desktop browser to a mobile phone. When installed, it functions as a complete, offline-first application. The app shell loads instantly, while the entire 12-track album and its corresponding artwork are cached in the background, allowing for a seamless, high-fidelity listening experience anywhere, with or without an internet connection.<br><br>The player is deeply integrated with native Media Session controls, meaning the album's art, titles, and playback can be managed directly from your phone's lock screen or your car's dashboard—a testament to its technical polish.<br><br><b class="text-yellow-400 text-lg">The Concept: A Graffiti Tribute</b><br><br>The album's visual identity is rooted in the raw, authentic aesthetic of urban stencil art. The cover and all accompanying track images were created in this high-contrast style, depicting the "Red-Headed Hallelujah" herself in various moments and personas.<br><br>Like a series of tributes painted on a weathered concrete wall, each image tells a story. You'll find a defiant driver in a doorless Jeep for "Real Women," a saint-like figure bathed in holy light for the title track, and a tender portrait of motherhood for "Natural Magic."<br><br>A central feature of this site is the Liner Notes button. Click it, and the artwork performs a 3D flip, revealing the story and lyrics behind each song, much like discovering a hidden message on the back of a physical record sleeve.<br><br><b class="text-yellow-400 text-lg">The Music: The "Red-Headed Rock" Aesthetic</b><br><br>Musically, Red-Headed Hallelujah is a high-energy "Red-Headed Rock" album at its core, but it masterfully explores the full spectrum of a life lived together. While generated with the assistance of AI, each track was painstakingly directed, with custom lyrics and styling to create a cohesive and deeply personal narrative.<br><br>The album opens with the driving, dangerous hard rock of "The Crimson Tide," a symbolic tale of a siren-like mermaid, before moving into the gritty, fuzzed-out blues-rock defiance of "Real Women."<br><br>The experience flows from chaotic, comedic pop-punk ("Interrupted") and playful funk-rock ("Caps") to moments of profound tenderness, like the intimate acoustic folk of "Natural Magic." The album hits its emotional peak with the soaring, choir-backed anthem "Red-Headed Hallelujah" and the rugged, soulful southern rock ballad "Cinnamon Serenade"—a raw ode to love's less-than-glamorous, unconditional moments.<br><br>This is a technical and artistic creation, a digital monument to a real-world muse. Enjoy the experience.`;
            
            // This function now just shows the "Click to Begin" button.
            // It's called after the PWA check (if any) is complete.
            function showBeginButton() {
                updateStatusEl.style.display = 'none'; // Hide "Checking for Updates..."
                enterBtn.textContent = 'Click to Begin';
                enterBtn.style.display = 'block'; // Show the button
                enterBtn.disabled = false;
            }

            // This function handles the intro video and audio sequence
            function startVideoTransition() {
                if(hasUserInteracted) return;
                hasUserInteracted = true;
                
                // Tell the service worker to start caching songs in the background (if it's the app)
                if (window.matchMedia('(display-mode: standalone)').matches && 'serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    console.log('Sending cache-content message to SW');
                    navigator.serviceWorker.controller.postMessage({ action: 'cache-content' });
                }
                
                introAudio.load(); // Preload the intro audio
                enterBtn.style.display = 'none'; // Hide the "Click to Begin" button
                skipIntroBtn.classList.remove('hidden'); // Show the "Skip Intro" button

                // Manually play the video (no autoplay)
                splashVideo.play().then(() => {
                    // Video started!
                }).catch(error => {
                    console.warn("Video play failed even after click:", error);
                    transitionToPlayer(); // Failsafe in case video fails
                });
            }

            // New function to skip the intro
            function skipIntro() {
                splashVideo.pause();
                introAudio.pause(); // Stop the intro audio just in case
                skipIntroBtn.classList.add('hidden'); // Hide skip button
                transitionToPlayer(); // Go right to the player
            }

            // This function fades to the player
            function transitionToPlayer() {
                skipIntroBtn.classList.add('hidden'); // Hide skip button
                // Wait 1 second after intro audio finishes (or skip is clicked)
                setTimeout(() => {
                    splashScreen.style.opacity = '0';
                    playerContainer.style.opacity = '1';
                    
                    // After the fade, remove the splash screen
                    setTimeout(() => {
                        splashScreen.style.display = 'none';
                    }, 1000); // Must match the transition duration
                    
                }, 1000); // 1-second pause
            }
            
            // --- Player Functions ---
            function updatePositionState() {
                if ('mediaSession' in navigator && navigator.mediaSession.metadata) {
                    const { duration, currentTime } = audioPlayer;
                    if (duration && isFinite(duration)) {
                        navigator.mediaSession.setPositionState({
                            duration: duration,
                            playbackRate: audioPlayer.playbackRate,
                            position: currentTime
                        });
                    }
                }
            }
            
            function updateMediaSession(song) {
                if ('mediaSession' in navigator) {
                    if (song) {
                        // Song is playing
                        navigator.mediaSession.metadata = new MediaMetadata({
                            title: song.title,
                            artist: artistName,
                            album: albumName,
                            artwork: [
                                { src: song.image_src, sizes: '512x512', type: 'image/png' }
                            ]
                        });
                        navigator.mediaSession.playbackState = "playing";
                    } else {
                        // Song is paused
                        if (navigator.mediaSession.metadata) {
                             navigator.mediaSession.playbackState = "paused";
                        }
                    }
                    updatePositionState(); // Update progress bar
                }
            }
            
            function updateLinerNotes(index) {
                if (index === null) {
                    noteTitleEl.textContent = albumTitle;
                    noteBodyEl.innerHTML = albumNote; // Use innerHTML for formatted album note
                } else {
                    const song = songs[index];
                    noteTitleEl.textContent = song.title;
                    noteBodyEl.innerHTML = song.note; // Use innerHTML for formatted song notes
                }
            }

            function loadSong(song) {
                songTitleEl.textContent = song.title;
                songArtistEl.textContent = artistName;
                audioPlayer.src = song.src;
                songArtEl.src = song.image_src; // Set new song art
                songArtEl.classList.remove('is-visible'); // Make it invisible (ready to fade in)
                flipper.classList.remove('is-flipped'); // Flip notes back to front
                updateActivePlaylistItem();
            }

            function playSong() {
                closeVideoModal(); // Close video if it's open
                if (!audioPlayer.src || audioPlayer.src.endsWith('index.html')) {
                    loadSong(songs[currentSongIndex]);
                }
                isPlaying = true;
                audioPlayer.play();
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
                songArtEl.classList.add('is-visible'); // Fade in song art
                updateLinerNotes(currentSongIndex);
                updateMediaSession(songs[currentSongIndex]);
            }

            function pauseSong() {
                isPlaying = false;
                audioPlayer.pause();
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                songArtEl.classList.remove('is-visible'); // Fade out song art
                updateLinerNotes(null);
                updateMediaSession(null);
            }

            function prevSong() {
                currentSongIndex--;
                if (currentSongIndex < 0) currentSongIndex = songs.length - 1;
                loadSong(songs[currentSongIndex]);
                if (isPlaying) playSong();
            }

            function nextSong() {
                currentSongIndex++;
                if (currentSongIndex > songs.length - 1) currentSongIndex = 0;
                loadSong(songs[currentSongIndex]);
                if (isPlaying) playSong();
            }

            function updateProgress(e) {
                const { duration, currentTime } = e.srcElement;
                if (duration) {
                    const progressPercent = (currentTime / duration) * 100;
                    progressBar.value = progressPercent;
                    durationTimeEl.textContent = formatTime(duration);
                    currentTimeEl.textContent = formatTime(currentTime);
                    updatePositionState(); // Update truck progress bar
                }
            }

            function formatTime(seconds) {
                if (isNaN(seconds)) return "0:00";
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            }

            function setProgress() {
                const duration = audioPlayer.duration;
                if (duration) {
                     audioPlayer.currentTime = (progressBar.value / 100) * duration;
                     updatePositionState(); // Update truck progress bar
                }
            }
            
            function updateActivePlaylistItem() {
                const items = document.querySelectorAll('.playlist-item');
                items.forEach((item, index) => {
                    if (index === currentSongIndex) {
                        item.classList.add('active');
                        item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    } else {
                        item.classList.remove('active');
                    }
                });
            }

            function createPlaylist() {
                songs.forEach((song, index) => {
                    const item = document.createElement('div');
                    item.classList.add('playlist-item', 'p-3', 'rounded-lg', 'cursor-pointer', 'hover:bg-gray-700', 'transition-colors', 'duration-200');
                    item.innerHTML = `
                        <p class="font-album-title tracking-wider truncate">${song.title}</p>
                        <p class="text-sm text-gray-400">${artistName}</p>
                    `;
                    item.addEventListener('click', () => {
                        currentSongIndex = index;
                        loadSong(song);
                        playSong();
                    });
                    playlistEl.appendChild(item);
                });
            }

            // --- New Video Functions ---
            function createVideoPlaylist() {
                videos.forEach((video, index) => {
                    const item = document.createElement('div');
                    item.classList.add('playlist-item', 'p-3', 'rounded-lg', 'cursor-pointer', 'hover:bg-gray-700', 'transition-colors', 'duration-200', 'flex', 'items-center', 'space-x-4');
                    item.innerHTML = `
                        <img src="${video.thumbnail}" alt="${video.title}" class="w-16 h-9 object-cover rounded-md flex-shrink-0">
                        <div>
                            <p class="font-album-title tracking-wider truncate text-white">${video.title}</p>
                            <p class="text-sm text-gray-400">${artistName}</p>
                        </div>
                    `;
                    item.addEventListener('click', () => {
                        playVideo(video);
                    });
                    videoPlaylistEl.appendChild(item);
                });
            }

            function playVideo(video) {
                pauseSong(); // Stop the music
                isVideoModalOpen = true;
                videoPlayer.src = video.src;
                videoModal.classList.remove('hidden');
                setTimeout(() => videoModal.style.opacity = '1', 10); // Fade in
                videoPlayer.play();
            }

            function closeVideoModal() {
                if (!isVideoModalOpen) return;
                isVideoModalOpen = false;
                videoModal.style.opacity = '0';
                setTimeout(() => videoModal.classList.add('hidden'), 300); // Hide after fade
                videoPlayer.pause();
                videoPlayer.src = ""; // Stop loading
            }


            // --- 5. EVENT LISTENERS ---
            
            // --- Splash Screen Logic ---
            enterBtn.addEventListener('click', startVideoTransition);
            skipIntroBtn.addEventListener('click', skipIntro);
            splashVideo.addEventListener('ended', () => {
                if(hasUserInteracted) {
                    introAudio.play().catch(e => {
                        console.warn("Intro audio failed to play:", e);
                        transitionToPlayer(); // Failsafe
                    });
                }
            });
            introAudio.addEventListener('ended', transitionToPlayer);
            
            // --- Player Logic ---
            playPauseBtn.addEventListener('click', () => {
                if (isPlaying) pauseSong();
                else playSong();
            });
            prevBtn.addEventListener('click', prevSong);
            nextBtn.addEventListener('click', nextSong);
            audioPlayer.addEventListener('timeupdate', updateProgress);
            audioPlayer.addEventListener('ended', nextSong);
            progressBar.addEventListener('input', setProgress);
            
            linerNotesBtn.addEventListener('click', () => {
                updateLinerNotes(isPlaying ? currentSongIndex : null);
                flipper.classList.toggle('is-flipped');
            });
            
            // --- "About" Button Listener ---
            aboutBtn.addEventListener('click', () => {
                noteTitleEl.textContent = aboutTitle;
                noteBodyEl.innerHTML = aboutText; // Use innerHTML for formatted "About" text
                flipper.classList.add('is-flipped'); // Show the back panel
            });

            // --- AI Modal Listeners ---
            askArtistBtn.addEventListener('click', () => {
                if (flipper.classList.contains('is-flipped')) {
                    isAiModalOpen = true;
                    aiModal.classList.remove('hidden');
                    setTimeout(() => aiModal.style.opacity = '1', 10); // Fade in
                    getAiCommentary();
                }
            });
            aiModalCloseBtn.addEventListener('click', () => {
                isAiModalOpen = false;
                aiModal.style.opacity = '0';
                setTimeout(() => aiModal.classList.add('hidden'), 300); // Hide after fade
            });
            aiModal.addEventListener('click', (e) => {
                if (e.target === aiModal) aiModalCloseBtn.click();
            });

            // --- Video Modal Listeners ---
            videoModalCloseBtn.addEventListener('click', closeVideoModal);
            videoModal.addEventListener('click', (e) => {
                if (e.target === videoModal) closeVideoModal();
            });

            // --- Tab Listeners ---
            audioTabBtn.addEventListener('click', () => {
                // Show audio, hide video
                playlistEl.classList.remove('hidden');
                videoPlaylistEl.classList.add('hidden');
                // Style tabs
                audioTabBtn.classList.add('bg-gray-700', 'text-white');
                audioTabBtn.classList.remove('text-gray-400', 'hover:bg-gray-700');
                videoTabBtn.classList.add('text-gray-400', 'hover:bg-gray-700');
                videoTabBtn.classList.remove('bg-gray-700', 'text-white');
            });

            videoTabBtn.addEventListener('click', () => {
                // Show video, hide audio
                videoPlaylistEl.classList.remove('hidden');
                playlistEl.classList.add('hidden');
                // Style tabs
                videoTabBtn.classList.add('bg-gray-700', 'text-white');
                videoTabBtn.classList.remove('text-gray-400', 'hover:bg-gray-700');
                audioTabBtn.classList.add('text-gray-400', 'hover:bg-gray-700');
                audioTabBtn.classList.remove('bg-gray-700', 'text-white');
            });


            // --- Media Session Action Handlers (for truck controls) ---
            if ('mediaSession' in navigator) {
                navigator.mediaSession.setActionHandler('play', playSong);
                navigator.mediaSession.setActionHandler('pause', pauseSong);
                navigator.mediaSession.setActionHandler('previoustrack', prevSong);
                navigator.mediaSession.setActionHandler('nexttrack', nextSong);
                navigator.mediaSession.setActionHandler('seekto', (details) => {
                    audioPlayer.currentTime = details.seekTime;
                    updatePositionState();
                });
            }

            // --- 6. INITIALIZE PLAYER ---
            createPlaylist();
            createVideoPlaylist(); // Create the new video list
            loadSong(songs[currentSongIndex]);
            updateLinerNotes(null);
            
            // --- 7. NEW AI FUNCTIONS ---

            /**
             * Calls the Gemini API with exponential backoff.
             */
            async function callGeminiApi(payload, retries = 5, delay = 1000) {
                const apiKey = ""; // Keep this empty, it's handled by the environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload),
                    });

                    if (!response.ok) {
                        if (response.status === 429 && retries > 0) { // Throttling
                            await new Promise(resolve => setTimeout(resolve, delay));
                            return callGeminiApi(payload, retries - 1, delay * 2); // Exponential backoff
                        }
                        throw new Error(`API Error: ${response.statusText}`);
                    }
                    return await response.json();
                } catch (error) {
                    if (retries > 0) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return callGeminiApi(payload, retries - 1, delay * 2); // Exponential backoff
                    }
                    console.error("Error calling Gemini API after retries:", error);
                    throw error;
                }
            }

            /**
             * Fetches AI-generated commentary for the current song.
             */
            async function getAiCommentary() {
                if (!isAiModalOpen) return; // Stop if modal was closed

                // 1. Set loading state
                aiModalSpinner.classList.remove('hidden');
                aiModalText.classList.add('hidden');

                // Determine which note to use
                let promptTitle, promptNote;
                if (isPlaying) {
                    // Use current song
                    const currentSong = songs[currentSongIndex];
                    promptTitle = currentSong.title;
                    promptNote = currentSong.note;
                } else {
                    // Use album note
                    promptTitle = albumTitle;
                    promptNote = albumNote; 
                }

                // If "About" page is showing, use that instead
                if (noteTitleEl.textContent === aboutTitle) {
                    promptTitle = "About This App";
                    promptNote = aboutText;
                }
                
                // 2. Define the prompts
                const systemPrompt = "Act as the artist of the album 'Red-Headed Hallelujah.' You are a creative, thoughtful, and slightly rugged rock musician. Based on the song title and your official notes, write a short, personal, and creative story about what inspired you to write this song, as if you're sharing a secret with a fan. Keep it under 100 words. If the notes are about the whole album or 'About This App', provide a brief, appreciative 'behind-the-scenes' comment as the creator.";
                
                const userQuery = `Topic: "${promptTitle}"\nMy Official Notes: "${promptNote.replace(/<[^>]*>?/gm, '')}"\n\nGive me a new creative story or comment about this.`;

                // 3. Construct the payload
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };

                // 4. Call the API
                try {
                    const result = await callGeminiApi(payload);
                    const aiText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (aiText && isAiModalOpen) {
                        aiModalText.textContent = aiText.trim();
                    } else if (isAiModalOpen) {
                        throw new Error("Invalid response structure from API.");
                    }
                } catch (error) {
                    console.error("Failed to get AI commentary:", error);
                    if (isAiModalOpen) {
                        aiModalText.textContent = "Couldn't reach the artist right now. Please try again in a moment.";
                    }
                } finally {
                    // 5. Set final state
                    if (isAiModalOpen) {
                        aiModalSpinner.classList.add('hidden');
                        aiModalText.classList.remove('hidden');
                    }
                }
            }


            // --- 8. PWA Service Worker Registration ---
            const isPwa = window.matchMedia('(display-mode: standalone)').matches;

            if (isPwa && 'serviceWorker' in navigator) {
                showBeginButton();

                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful:', registration);
                        
                        updateContainer.classList.remove('hidden');

                        updateBtn.addEventListener('click', () => {
                            updateStatusText.textContent = 'Checking...';
                            
                            registration.update().then(() => {
                                if (registration.installing) {
                                    const newWorker = registration.installing;
                                    newWorker.addEventListener('statechange', () => {
                                        if (newWorker.state === 'installed') {
                                            updateStatusText.textContent = 'Update downloaded! Please restart app.';
                                        }
                                    });
                                } else {
                                    updateStatusText.textContent = 'You are up to date.';
                                }
                            }).catch(err => {
                                console.error('Error updating service worker:', err);
                                updateStatusText.textContent = 'Update check failed.';
                            });
                        });
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                        showBeginButton();
                    });
            } else {
                console.log('Not in PWA mode, skipping PWA features.');
                showBeginButton();
            }
        });
    </script>
</body>
</html>

