<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Red-Headed Hallelujah</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter (sans-serif) and Staatliches (blocky, for title) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Staatliches&display=swap" rel="stylesheet">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json?v=3">
    <meta name="theme-color" content="#EF4444">
    
    <style>
        /* Custom styles to match the album art aesthetic */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Using 'Staatliches' for the main album title to mimic the cover font */
        .font-album-title {
            font-family: 'Staatliches', cursive;
        }

        /* Custom scrollbar for playlists */
        #playlist::-webkit-scrollbar,
        #video-playlist::-webkit-scrollbar,
        #flipper-back::-webkit-scrollbar {
            width: 8px;
        }
        #playlist::-webkit-scrollbar-track,
        #video-playlist::-webkit-scrollbar-track,
        #flipper-back::-webkit-scrollbar-track {
            background: #374151; /* gray-700 */
            border-radius: 10px;
        }
        #playlist::-webkit-scrollbar-thumb,
        #video-playlist::-webkit-scrollbar-thumb,
        #flipper-back::-webkit-scrollbar-thumb {
            background: #EF4444; /* red-500 */
            border-radius: 10px;
        }
        #playlist::-webkit-scrollbar-thumb:hover,
        #video-playlist::-webkit-scrollbar-thumb:hover,
        #flipper-back::-webkit-scrollbar-thumb:hover {
            background: #DC2626; /* red-600 */
        }

        /* Style for the currently active playlist item */
        .playlist-item.active {
            background-color: #EF4444; /* red-500 */
            color: #FFFFFF; /* white */
        }

        /* Custom style for the progress bar slider thumb */
        #progress-bar-container input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #EF4444; /* red-500 */
            border-radius: 3px;
            cursor: pointer;
            margin-top: -6px; /* Center the thumb on the track */
        }
        
        #progress-bar-container input[type=range]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #EF4444; /* red-500 */
            border-radius: 3px;
            cursor: pointer;
        }

        /* Custom style for the progress bar track */
        #progress-bar-container input[type=range] {
             -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: #4B5563; /* gray-600 */
            outline: none;
        }

        /* Class for the player texture */
        .player-texture {
            background-color: #1F2937; /* This is Tailwind's bg-gray-800 */
            background-image: url('https://www.transparenttextures.com/patterns/stucco.png');
        }
        
        /* 'Live Glow' Pulse Animation */
        @keyframes pulseGlow {
            0%, 100% {
                box-shadow: 0 0 10px rgba(239, 68, 68, 0.4), 0 0 12px rgba(239, 68, 68, 0.3);
            }
            50% {
                box-shadow: 0 0 16px rgba(239, 68, 68, 0.7), 0 0 20px rgba(239, 68, 68, 0.5);
            }
        }
        
        .is-playing-glow {
            animation: pulseGlow 2.5s infinite ease-in-out;
        }

        /* --- Flipper Styles --- */
        .flipper-container {
            perspective: 1000px;
            padding-top: 100%; /* Creates a 1:1 aspect ratio */
        }
        #flipper {
            transform-style: preserve-3d;
            transition: transform 0.8s;
        }
        #flipper.is-flipped {
            transform: rotateY(180deg);
        }
        .flipper-front,
        .flipper-back {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }
        #flipper-back {
            transform: rotateY(180deg);
            background-color: #4B5563; /* gray-600 */
            background-image: url('https://www.transparenttextures.com/patterns/concrete-wall.png');
        }
        
        /* --- Song Art Crossfade --- */
        #song-art {
            transition: opacity 0.5s ease-in-out;
            opacity: 0;
        }
        #song-art.is-visible {
            opacity: 1;
        }

        /* --- Splash Screen Styles --- */
        #enter-btn {
            background: rgba(239, 68, 68, 0.8); /* red-500 with 80% opacity */
            border: 2px solid rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
        }
        #enter-btn:hover {
            background: rgba(220, 38, 38, 1); /* red-600 */
            border-color: white;
            transform: scale(1.05);
        }
        #enter-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
        #update-status {
            background: rgba(17, 24, 39, 0.8); /* gray-900 with 80% opacity */
        }

        /* --- Skip Intro Button Style --- */
        #skip-intro-btn {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        #skip-intro-btn:hover {
            background: rgba(0, 0, 0, 0.75);
            border-color: rgba(255, 255, 255, 0.7);
        }

        /* --- Karaoke/Lyrics Styles (RE-IMPLEMENTED) --- */
        #lyrics-container {
            font-family: 'Staatliches', cursive; /* Use album font for lyrics */
            font-size: 1.5rem; /* 24px */
            line-height: 2rem; /* 32px */
            letter-spacing: 0.05em;
            text-align: center;
        }

        .lyric-line {
            transition: all 0.3s ease-in-out;
            opacity: 0.4;
            padding: 4px 8px;
            border-radius: 4px;
            transform: scale(0.95);
        }

        .lyric-line.active-lyric {
            opacity: 1;
            color: #FBBF24; /* yellow-400 */
            background: rgba(17, 24, 39, 0.4); /* gray-900 with 40% opacity */
            transform: scale(1);
        }

    </style>
</head>
<body class="bg-gray-900 text-gray-300 min-h-screen flex items-center justify-center p-4">

    <!-- Video Splash Screen -->
    <div id="splash-screen" class="fixed top-0 left-0 w-full h-full bg-gray-900 z-50 flex items-center justify-center opacity-100 transition-opacity duration-1000">
        
        <!-- Video: NO Autoplay -->
        <video id="splash-video" class="max-w-full max-h-full object-contain" preload="auto" playsinline>
            <source src="paint-video.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        
        <!-- Status / Button Container -->
        <div class="absolute inset-0 flex items-center justify-center">
             <!-- "Checking for Updates..." - Only shown on PWA app load -->
            <div id="update-status" class="hidden p-4 rounded-lg text-white font-album-title text-xl tracking-wider">
                Checking for Updates...
            </div>

            <!-- "Click to Begin" Button - Hidden until check is done -->
            <button id="enter-btn" class="hidden z-60 text-white p-4 px-8 font-album-title text-xl tracking-wider rounded-lg" disabled>
                Click to Begin
            </button>
        </div>

        <!-- Skip Intro Button -->
        <button id="skip-intro-btn" class="hidden absolute bottom-5 left-1/2 -translate-x-1/2 z-60 text-white px-4 py-2 rounded-lg text-sm hover:bg-black/75 transition">
            Skip Intro
        </button>
    </div>

    <!-- Main Player Container (starts invisible) -->
    <div id="player-container" class="w-full max-w-4xl opacity-0 transition-opacity duration-1000">
        
        <!-- Player Container -->
        <div class="player-texture shadow-2xl overflow-hidden flex flex-col md:flex-row">
            
            <!-- Left Side: Album Artwork, Video, & Lyrics -->
            <div class="w-full md:w-1/2 flex-shrink-0 flex flex-col">
                <!-- Flipper container (1:1 aspect ratio) -->
                <div class="relative w-full flipper-container bg-black"> 
                    
                    <!-- Video Panel (Starts Hidden) -->
                    <div id="video-panel" class="absolute top-0 left-0 w-full h-full z-20 hidden">
                        <iframe id="video-iframe" class="w-full h-full" src="" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
                    </div>
                    
                    <!-- Artwork & Lyrics Flipper -->
                    <div id="flipper" class="absolute top-0 left-0 w-full h-full z-10">
                        <!-- FRONT (Album Art) -->
                        <div class="flipper-front absolute w-full h-full">
                            <!-- Main Album Art -->
                            <img src="cover.png" alt="Album Art for Red-Headed Hallelujah" class="w-full h-full object-cover">
                            <!-- Song-Specific Art (fades in) -->
                            <img id="song-art" src="" alt="Song-specific art" class="absolute top-0 left-0 w-full h-full object-cover">
                        </div>
                        <!-- BACK (Lyrics) -->
                        <div id="flipper-back" class="flipper-back absolute w-full h-full p-6 overflow-y-auto">
                            <!-- Lyrics will be injected here -->
                            <div id="lyrics-container" class="text-gray-200 space-y-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Buttons: Lyrics & About -->
                <div class="flex">
                    <button id="lyrics-btn" class="flex-1 bg-red-500 text-white font-album-title tracking-wider text-lg p-3 hover:bg-red-600 transition-colors duration-200">
                        Lyrics
                    </button>
                    <button id="about-btn" class="flex-1 bg-gray-600 text-white font-album-title tracking-wider text-lg p-3 hover:bg-gray-700 transition-colors duration-200 border-l border-gray-800">
                        About This App
                    </button>
                </div>
            </div>

            <!-- Right Side: Info, Controls, Playlist -->
            <div class="w-full md:w-1/2 p-6 flex flex-col">
                
                <!-- Top-Right: Current Song Info -->
                <div class="mb-4 flex-shrink-0">
                    <p class="text-lg uppercase tracking-widest text-red-500 font-album-title">Now Playing</p>
                    <h2 id="song-title" class="text-3xl text-yellow-400 truncate font-album-title tracking-wider">Song Title</h2>
                    <h3 id="song-artist" class="text-lg text-gray-300">A mstonge01 Project</h3>
                </div>

                <!-- Middle-Right: Controls & Progress Bar -->
                <div class="mb-4 flex-shrink-0">
                    <!-- Progress Bar -->
                    <div id="progress-bar-container" class="mb-3">
                         <input type="range" id="progress-bar" class="w-full h-1 bg-gray-700 rounded-lg cursor-pointer" value="0" min="0" max="100">
                    </div>
                    <!-- Time Display -->
                    <div class="flex justify-between text-sm text-gray-400">
                        <span id="current-time">0:00</span>
                        <span id="duration-time">0:00</span>
                    </div>

                    <!-- Controls -->
                    <div class="flex justify-center items-center space-x-6 mt-4">
                        <!-- Previous Button -->
                        <button id="prev-btn" class="text-gray-400 hover:text-red-500 transition-colors duration-200">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M8.445 14.832A1 1 0 0010 14.03V5.969a1 1 0 00-1.555-.832L4.12 9.168a1 1 0 000 1.664l4.325 4zM10.879 9.168a1 1 0 000 1.664l4.325 4A1 1 0 0017 14.03V5.969a1 1 0 00-1.555-.832l-4.325 4z"/></svg>
                        </button>
                        <!-- Play/Pause Button -->
                        <button id="play-pause-btn" class="w-16 h-16 bg-red-500 text-white rounded-full flex items-center justify-center text-2xl hover:bg-red-600 transition-colors duration-200 shadow-lg">
                            <!-- Play Icon -->
                            <svg id="play-icon" class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8.002v3.996a1 1 0 001.555.832l3.197-1.998a1 1 0 000-1.664l-3.197-1.998z" clip-rule="evenodd"/></svg>
                            <!-- Pause Icon (hidden by default) -->
                            <svg id="pause-icon" class="w-8 h-8 hidden" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h1a1 1 0 001-1V8a1 1 0 00-1-1H8zm5 0a1 1 0 00-1 1v4a1 1 0 001 1h1a1 1 0 001-1V8a1 1 0 00-1-1h-1z" clip-rule="evenodd"/></svg>
                        </button>
                        <!-- Next Button -->
                        <button id="next-btn" class="text-gray-400 hover:text-red-500 transition-colors duration-200">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M4.555 5.168A1 1 0 003 5.969v8.062a1 1 0 001.555.832l4.325-4a1 1 0 000-1.664l-4.325-4zM10.879 5.168A1 1 0 009.324 5.97v8.062a1 1 0 001.555.832l4.325-4a1 1 0 000-1.664l-4.325-4z"/></svg>
                        </button>
                    </div>
                </div>
                
                <!-- Bottom-Right: Playlist Tabs & Container -->
                <div class="flex-grow flex flex-col min-h-0">
                    <!-- Tabs -->
                    <div class="flex-shrink-0 flex">
                        <button id="audio-tab" class="flex-1 p-3 font-album-title tracking-wider text-lg transition-colors duration-200 border-b-2 bg-gray-700/50 border-red-500 text-white">Audio</button>
                        <button id="video-tab" class="flex-1 p-3 font-album-title tracking-wider text-lg transition-colors duration-200 border-b-2 bg-transparent border-gray-700 text-gray-500 hover:bg-gray-800/50">Video</button>
                    </div>

                    <!-- Playlist Container -->
                    <div class="flex-grow relative min-h-0 h-80 md:h-auto">
                        <!-- Audio Playlist -->
                        <div id="playlist" class="absolute top-0 left-0 w-full h-full overflow-y-auto pr-2">
                            <!-- Playlist items will be injected here by JavaScript -->
                        </div>
                        <!-- Video Playlist (Hidden) -->
                        <div id="video-playlist" class="absolute top-0 left-0 w-full h-full overflow-y-auto pr-2 hidden">
                            <!-- Video items will be injected here by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- The actual audio element, hidden from view -->
    <audio id="audio-player"></audio>
    <audio id="intro-audio" src="hallelujah-intro.mp3" preload="auto"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 1. DATABASES ---
            
            // --- UPDATED SONGS ARRAY ---
            // 'lyrics' property is for STATIC lyrics (like Intro)
            // 'srt' property points to the .srt file for DYNAMIC lyrics
            const songs = [
                { 
                    title: "Intro", 
                    src: "01-intro.mp3",
                    image_src: "01-intro-art.png",
                    // Static lyrics for "Intro" as requested
                    lyrics: [
                        { time: 26, text: "They say a light can't be contained..." },
                        { time: 33, text: "And a fire can't be tamed." },
                        { time: 40, text: "Well, this one's got red hair." },
                        { time: 44, text: "Let's start the story there..." }
                    ]
                },
                { 
                    title: "The Crimson Tide", 
                    src: "02-the-crimson-tide.mp3",
                    image_src: "02-the-crimson-tide-art.png",
                    srt: "The Crimson Tide.srt"
                },
                { 
                    title: "Real Women", 
                    src: "03-real-women.mp3",
                    image_src: "03-real-women-art.png",
                    srt: "Real Women.srt"
                },
                { 
                    title: "Red-Headed Hallelujah", 
                    src: "04-red-headed-hallelujah.mp3",
                    image_src: "04-red-headed-hallelujah-art.png",
                    srt: "Red-Headed Hallelujah.srt"
                },
                { 
                    title: "The Good Stuff", 
                    src: "05-the_good_stuff.mp3",
                    image_src: "05-the_good_stuff-art.png",
                    srt: "The Good Stuff.srt"
                },
                { 
                    title: "Zero Degree Beach", 
                    src: "06-zero-degree-beach.mp3",
                    image_src: "06-zero-degree-beach-art.png",
                    srt: "Zero-Degree Beach.srt"
                },
                { 
                    title: "Caps", 
                    src: "07-caps.mp3",
                    image_src: "07-caps-art.png",
                    srt: "Caps.srt"
                },
                { 
                    title: "Red Paddle Queen", 
                    src: "08-red-paddle-queen.mp3",
                    image_src: "08-red-paddle-queen.png",
                    srt: "Red Paddle Queen.srt"
                },
                { 
                    title: "Interrupted", 
                    src: "09-interrupted.mp3",
                    image_src: "09-interrupted-art.png",
                    srt: "Interrupted.srt"
                },
                { 
                    title: "Cinnamon Serenade", 
                    src: "10-cinnamon-serenade.mp3",
                    image_src: "10-cinnamon-serenade-art.png",
                    srt: "Cinnamon Serenade.srt"
                },
                { 
                    title: "Basement Stereo Glow", 
                    src: "11-basement-stereo-glow.mp3",
                    image_src: "11-basement-stereo-glow.png",
                    srt: "Basement Stereo Glow.srt"
                },
                { 
                    title: "Golden Devotion", 
                    src: "12-golden-devotion.mp3",
                    image_src: "12-golden-devotion-art.png",
                    srt: "Golden Devotion.srt"
                },
                { 
                    title: "Natural Magic", 
                    src: "13-natural-magic.mp3",
                    image_src: "13-natural-magic-art.png",
                    srt: "Natural Magic.srt"
                },
                { 
                    title: "Outro", 
                    src: "14-outro.mp3",
                    image_src: "14-outro-art.png",
                    srt: "Outro.srt"
                },
                { 
                    title: "[Bonus Track] Red-Headed Hallelujah (Guitar Cover)", 
                    src: "15-red-headed-hallelujah-guitar.mp3",
                    image_src: "04-red-headed-hallelujah-art.png", // Uses Track 4 art
                    srt: "Red-Headed Hallelujah (Guitar).srt"
                },
                { 
                    title: "[Bonus Track] Natural Magic (Acoustic)", 
                    src: "16-natural-magic-acoustic.mp3",
                    image_src: "13-natural-magic-art.png", // Uses Track 13 art
                    srt: "Natural Magic (Acoustic).srt"
                }
            ];

            const videos = [
                {
                    title: "Real Women",
                    src: "https://www.youtube.com/embed/VXiXI-mZvL4",
                    image_src: "03-real-women-art.png"
                },
                {
                    title: "Red-Headed Hallelujah",
                    src: "https://www.youtube.com/embed/0WVY004pOng",
                    image_src: "04-red-headed-hallelujah-art.png"
                },
                {
                    title: "Natural Magic",
                    src: "https://www.youtube.com/embed/usGSmvYKI5c",
                    image_src: "13-natural-magic-art.png"
                },
                {
                    title: "Natural Magic (Acoustic)",
                    src: "https://www.youtube.com/embed/YGCpLq5Bd6E",
                    image_src: "13-natural-magic-art.png"
                }
            ];

            const artistName = "A mstonge01 Project";
            const albumTitle = "Lyrics";
            const albumNote = ``; // Cleared
            const aboutNote = ``; // Cleared
            const albumName = "Red-Headed Hallelujah";

            // --- 2. DOM ELEMENT REFERENCES ---
            const splashScreen = document.getElementById('splash-screen');
            const splashVideo = document.getElementById('splash-video');
            const enterBtn = document.getElementById('enter-btn');
            const skipIntroBtn = document.getElementById('skip-intro-btn');
            const updateStatusEl = document.getElementById('update-status'); 
            const playerContainer = document.getElementById('player-container');
            const audioPlayer = document.getElementById('audio-player');
            const introAudio = document.getElementById('intro-audio');
            const songTitleEl = document.getElementById('song-title');
            const songArtistEl = document.getElementById('song-artist');
            
            const playlistEl = document.getElementById('playlist');
            const videoPlaylistEl = document.getElementById('video-playlist');
            const audioTab = document.getElementById('audio-tab');
            const videoTab = document.getElementById('video-tab');
            
            const playPauseBtn = document.getElementById('play-pause-btn');
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const progressBar = document.getElementById('progress-bar');
            const currentTimeEl = document.getElementById('current-time');
            const durationTimeEl = document.getElementById('duration-time');
            
            const lyricsBtn = document.getElementById('lyrics-btn');
            const aboutBtn = document.getElementById('about-btn');
            const flipper = document.getElementById('flipper');
            const lyricsContainerEl = document.getElementById('lyrics-container');
            const songArtEl = document.getElementById('song-art');
            const mainPlayerDiv = document.querySelector('.player-texture');

            const videoPanel = document.getElementById('video-panel');
            const videoIframe = document.getElementById('video-iframe');
            

            // --- 3. PLAYER STATE ---
            let currentSongIndex = 0;
            let isPlaying = false;
            let hasUserInteracted = false;
            let currentView = 'lyrics'; // 'lyrics' or 'about'
            let currentLyrics = []; // Holds the parsed SRT data [{start, end, text}] or static data [{time, text}]
            let currentLyricIndex = -1; // For tracking karaoke highlighting

            // --- 4. FUNCTIONS ---
            
            function showBeginButton() {
                updateStatusEl.style.display = 'none';
                enterBtn.textContent = 'Click to Begin';
                enterBtn.style.display = 'block';
                enterBtn.disabled = false;
            }

            function startVideoTransition() {
                if(hasUserInteracted) return;
                hasUserInteracted = true;
                
                if (window.matchMedia('(display-mode: standalone)').matches && 'serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    console.log('Sending cache-content message to SW');
                    navigator.serviceWorker.controller.postMessage({ action: 'cache-content' });
                }
                
                introAudio.load(); 
                enterBtn.style.display = 'none';
                skipIntroBtn.classList.remove('hidden'); 

                splashVideo.play().catch(error => {
                    console.warn("Video play failed even after click:", error);
                    transitionToPlayer(); 
                });
            }

            function skipIntro() {
                splashVideo.pause();
                introAudio.pause(); 
                skipIntroBtn.classList.add('hidden'); 
                transitionToPlayer(); 
            }

            function transitionToPlayer() {
                skipIntroBtn.classList.add('hidden'); 
                setTimeout(() => {
                    splashScreen.style.opacity = '0';
                    playerContainer.style.opacity = '1';
                    
                    setTimeout(() => {
                        splashScreen.style.display = 'none';
                    }, 1000); 
                    
                }, 1000); 
            }
            
            function showVideoPanel(show, src = "") {
                if (show) {
                    pauseSong(); 
                    videoIframe.src = src + "?autoplay=1&modestbranding=1&rel=0";
                    videoPanel.classList.remove('hidden');
                    flipper.classList.add('hidden'); 
                } else {
                    videoIframe.src = ""; 
                    videoPanel.classList.add('hidden');
                    flipper.classList.remove('hidden'); 
                }
            }
            
            function updatePositionState() {
                if ('mediaSession' in navigator && navigator.mediaSession.metadata) {
                    const { duration, currentTime } = audioPlayer;
                    if (duration && isFinite(duration)) {
                        navigator.mediaSession.setPositionState({
                            duration: duration,
                            playbackRate: audioPlayer.playbackRate,
                            position: currentTime
                        });
                    }
                }
            }
            
            function updateMediaSession(song) {
                if ('mediaSession' in navigator) {
                    if (song) {
                        navigator.mediaSession.metadata = new MediaMetadata({
                            title: song.title,
                            artist: artistName,
                            album: albumName,
                            artwork: [
                                { src: song.image_src, sizes: '512x512', type: 'image/png' }
                            ]
                        });
                        navigator.mediaSession.playbackState = "playing";
                    } else {
                        if (navigator.mediaSession.metadata) {
                             navigator.mediaSession.playbackState = "paused";
                        }
                    }
                    updatePositionState(); 
                }
            }
            
            // --- NEW SRT PARSING FUNCTIONS ---
            
            /**
             * Converts an SRT timecode (00:01:15,345) to seconds (75.345)
             */
            function srtTimeToSeconds(timecode) {
                const parts = timecode.split(':');
                const secondsParts = parts[2].split(',');
                const hours = parseInt(parts[0], 10);
                const minutes = parseInt(parts[1], 10);
                const seconds = parseInt(secondsParts[0], 10);
                const milliseconds = parseInt(secondsParts[1], 10);
                return (hours * 3600) + (minutes * 60) + seconds + (milliseconds / 1000);
            }

            /**
             * Parses raw SRT text into a JavaScript array of lyric objects
             */
            function parseSRT(srtText) {
                const lines = [];
                const blocks = srtText.trim().split('\n\n');
                
                for (const block of blocks) {
                    const blockLines = block.split('\n');
                    if (blockLines.length >= 3) {
                        try {
                            const timecode = blockLines[1].split(' --> ');
                            const start = srtTimeToSeconds(timecode[0].trim());
                            const end = srtTimeToSeconds(timecode[1].trim());
                            const text = blockLines.slice(2).join(' ').trim();
                            lines.push({ start, end, text });
                        } catch (e) {
                            console.warn("Skipping malformed SRT block:", block);
                        }
                    }
                }
                return lines;
            }
            
            /**
             * Fetches and parses an SRT file, then updates the lyrics panel
             */
            async function fetchAndParseSRT(srtFile) {
                try {
                    const response = await fetch(srtFile);
                    if (!response.ok) {
                        throw new Error(`SRT file not found: ${srtFile}`);
                    }
                    const srtText = await response.text();
                    currentLyrics = parseSRT(srtText);
                } catch (error) {
                    console.error("Error loading lyrics:", error);
                    currentLyrics = []; // Set to empty on error
                }
                updateLyricsContent(); // Update panel after fetch (or fail)
            }


            // --- UPDATED LYRIC FUNCTIONS ---

            /**
             * Populates the lyrics panel based on the current state
             */
            function updateLyricsContent() {
                lyricsContainerEl.innerHTML = ''; // Clear previous lyrics
                
                let lyricsToDisplay = [];
                
                if (currentView === 'about') {
                    lyricsContainerEl.innerHTML = aboutNote; // This is empty, but respects the view
                    return;
                } 
                
                // 'currentLyrics' is populated by loadSong
                if (currentLyrics && currentLyrics.length > 0) {
                    lyricsToDisplay = currentLyrics;
                }

                if (lyricsToDisplay.length > 0) {
                    lyricsToDisplay.forEach(line => {
                        const lineEl = document.createElement('div');
                        lineEl.classList.add('lyric-line');
                        lineEl.textContent = line.text;
                        lyricsContainerEl.appendChild(lineEl);
                    });
                } else {
                    // Show a message if no lyrics are available
                    lyricsContainerEl.innerHTML = `<div class="lyric-line" style="opacity: 0.7;">No lyrics available for this track.</div>`;
                }
            }

            /**
             * Handles the karaoke-style highlighting (RE-IMPLEMENTED)
             */
            function updateLyricHighlighting() {
                // Check if currentLyrics is dynamic (has 'start') or static (has 'time')
                if (!currentLyrics || currentLyrics.length === 0 || !currentLyrics[0].hasOwnProperty('start')) {
                    // This is static ("Intro") or empty, so no highlighting.
                    // Clear any existing highlights just in case.
                    if (currentLyricIndex !== -1) {
                         const allLyricLines = document.querySelectorAll('#lyrics-container .lyric-line');
                         allLyricLines.forEach(line => line.classList.remove('active-lyric'));
                         currentLyricIndex = -1;
                    }
                    return; 
                }
                
                const currentTime = audioPlayer.currentTime;
                let newLyricIndex = -1;

                // Find the currently active lyric line
                for (let i = 0; i < currentLyrics.length; i++) {
                    if (currentTime >= currentLyrics[i].start && currentTime < currentLyrics[i].end) {
                        newLyricIndex = i;
                        break;
                    }
                }

                if (newLyricIndex !== currentLyricIndex) {
                    currentLyricIndex = newLyricIndex;
                    const allLyricLines = document.querySelectorAll('#lyrics-container .lyric-line');
                    
                    allLyricLines.forEach((line, index) => {
                        if (index === currentLyricIndex) {
                            line.classList.add('active-lyric');
                            // Scroll the active line into view
                            line.scrollIntoView({
                                behavior: 'smooth',
                                block: 'center'
                            });
                        } else {
                            line.classList.remove('active-lyric');
                        }
                    });
                }
            }


            function loadSong(song) {
                songTitleEl.textContent = song.title;
                songArtistEl.textContent = artistName;
                audioPlayer.src = song.src;
                songArtEl.src = song.image_src; 
                songArtEl.classList.remove('is-visible'); 
                
                if (!videoPanel.classList.contains('hidden')) {
                    showVideoPanel(false);
                }
                
                flipper.classList.remove('is-flipped');
                currentView = 'lyrics'; // Default to lyrics view
                currentLyricIndex = -1; // Reset lyric highlighting
                
                // --- NEW: Load lyrics based on type ---
                currentLyrics = []; // Clear old lyrics immediately
                
                if (song.srt) {
                    // It's dynamic, fetch the SRT file
                    fetchAndParseSRT(song.srt);
                } else if (song.lyrics) {
                    // It's static (like Intro)
                    currentLyrics = song.lyrics;
                    updateLyricsContent(); // Populate panel immediately
                } else {
                    // No lyrics
                    updateLyricsContent(); // Will show "No lyrics" message
                }
                
                updateActivePlaylistItem();
            }

            function playSong() {
                if (!audioPlayer.src || audioPlayer.src.endsWith('index.html')) {
                    loadSong(songs[currentSongIndex]);
                }
                
                if (!videoPanel.classList.contains('hidden')) {
                    showVideoPanel(false);
                }

                isPlaying = true;
                audioPlayer.play();
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
                songArtEl.classList.add('is-visible'); 
                mainPlayerDiv.classList.add('is-playing-glow'); 
                
                // Don't need to update content here, loadSong does it
                updateMediaSession(songs[currentSongIndex]);
            }

            function pauseSong() {
                isPlaying = false;
                audioPlayer.pause();
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                songArtEl.classList.remove('is-visible');
                mainPlayerDiv.classList.remove('is-playing-glow');
                
                updateMediaSession(null);
            }

            function prevSong() {
                currentSongIndex--;
                if (currentSongIndex < 0) currentSongIndex = songs.length - 1;
                loadSong(songs[currentSongIndex]);
                if (isPlaying) playSong();
            }

            function nextSong() {
                currentSongIndex++;
                if (currentSongIndex > songs.length - 1) currentSongIndex = 0;
                loadSong(songs[currentSongIndex]);
                if (isPlaying) playSong();
            }

            function updateProgress(e) {
                const { duration, currentTime } = e.srcElement;
                if (duration) {
                    const progressPercent = (currentTime / duration) * 100;
                    progressBar.value = progressPercent;
                    durationTimeEl.textContent = formatTime(duration);
                    currentTimeEl.textContent = formatTime(currentTime);
                    updatePositionState();
                }
            }

            function formatTime(seconds) {
                if (isNaN(seconds)) return "0:00";
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            }

            function setProgress() {
                const duration = audioPlayer.duration;
                if (duration) {
                     audioPlayer.currentTime = (progressBar.value / 100) * duration;
                     updatePositionState();
                     updateLyricHighlighting(); // Update karaoke on seek
                }
            }
            
            function updateActivePlaylistItem() {
                const items = document.querySelectorAll('#playlist .playlist-item');
                items.forEach((item, index) => {
                    if (index === currentSongIndex) {
                        item.classList.add('active');
                        item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    } else {
                        item.classList.remove('active');
                    }
                });
            }

            function createPlaylist() {
                songs.forEach((song, index) => {
                    const item = document.createElement('div');
                    item.classList.add('playlist-item', 'p-3', 'rounded-lg', 'cursor-pointer', 'hover:bg-gray-700', 'transition-colors', 'duration-200', 'flex', 'items-center', 'space-x-3');
                    item.innerHTML = `
                        <img src="${song.image_src}" alt="Art for ${song.title}" class="w-12 h-12 rounded object-cover flex-shrink-0">
                        <div class="min-w-0">
                            <p class="font-album-title tracking-wider truncate text-base">${song.title}</p>
                            <p class="text-sm text-gray-400 truncate">${artistName}</p>
                        </div>
                    `;
                    item.addEventListener('click', () => {
                        currentSongIndex = index;
                        loadSong(song);
                        playSong();
                    });
                    playlistEl.appendChild(item);
                });
            }

            function createVideoPlaylist() {
                videos.forEach((video, index) => {
                    const item = document.createElement('div');
                    item.classList.add('playlist-item', 'p-3', 'rounded-lg', 'cursor-pointer', 'hover:bg-gray-700', 'transition-colors', 'duration-200', 'flex', 'items-center', 'space-x-3');
                    item.innerHTML = `
                        <img src="${video.image_src}" alt="Art for ${video.title}" class="w-12 h-12 rounded object-cover flex-shrink-0">
                        <div class="min-w-0">
                            <p class="font-album-title tracking-wider truncate text-base">${video.title}</p>
                            <p class="text-sm text-gray-400 truncate">Music Video</p>
                        </div>
                    `;
                    item.addEventListener('click', () => {
                        showVideoPanel(true, video.src);
                    });
                    videoPlaylistEl.appendChild(item);
                });
            }

            // --- 5. EVENT LISTENERS ---
            
            enterBtn.addEventListener('click', startVideoTransition);
            skipIntroBtn.addEventListener('click', skipIntro);

            splashVideo.addEventListener('ended', () => {
                if(hasUserInteracted) {
                    introAudio.play().catch(e => {
                        console.warn("Intro audio failed to play:", e);
                        transitionToPlayer(); 
                    });
                }
            });
            
            introAudio.addEventListener('ended', () => {
                transitionToPlayer();
            });
            
            playPauseBtn.addEventListener('click', () => {
                if (isPlaying) pauseSong();
                else playSong();
            });
            prevBtn.addEventListener('click', prevSong);
            nextBtn.addEventListener('click', nextSong);
            
            // Combined timeupdate listener (RE-IMPLEMENTED)
            audioPlayer.addEventListener('timeupdate', () => {
                updateProgress({ srcElement: audioPlayer });
                updateLyricHighlighting(); // Karaoke sync
            });

            audioPlayer.addEventListener('ended', nextSong);
            progressBar.addEventListener('input', setProgress);
            
            // Lyrics Button Handler
            lyricsBtn.addEventListener('click', () => {
                if (!videoPanel.classList.contains('hidden')) {
                    showVideoPanel(false);
                }
                
                if (currentView === 'about') {
                    currentView = 'lyrics';
                    updateLyricsContent();
                    flipper.classList.add('is-flipped'); // Stay flipped
                } 
                else {
                    if (!flipper.classList.contains('is-flipped')) {
                         currentView = 'lyrics';
                         updateLyricsContent(); // Make sure lyrics are populated before flip
                    }
                    flipper.classList.toggle('is-flipped');
                }
            });
            
            // About Button Handler
            aboutBtn.addEventListener('click', () => {
                if (!videoPanel.classList.contains('hidden')) {
                    showVideoPanel(false);
                }

                currentView = 'about';
                updateLyricsContent();
                flipper.classList.add('is-flipped'); // Force flip
            });
            
            // --- Tab Logic ---
            function showPlaylist(type) {
                if (type === 'audio') {
                    playlistEl.classList.remove('hidden');
                    videoPlaylistEl.classList.add('hidden');
                    audioTab.className = "flex-1 p-3 font-album-title tracking-wider text-lg transition-colors duration-200 border-b-2 bg-gray-700/50 border-red-500 text-white";
                    videoTab.className = "flex-1 p-3 font-album-title tracking-wider text-lg transition-colors duration-200 border-b-2 bg-transparent border-gray-700 text-gray-500 hover:bg-gray-800/50";
                } else {
                    playlistEl.classList.add('hidden');
                    videoPlaylistEl.classList.remove('hidden');
                    videoTab.className = "flex-1 p-3 font-album-title tracking-wider text-lg transition-colors duration-200 border-b-2 bg-gray-700/50 border-red-500 text-white";
                    audioTab.className = "flex-1 p-3 font-album-title tracking-wider text-lg transition-colors duration-200 border-b-2 bg-transparent border-gray-700 text-gray-500 hover:bg-gray-800/50";
                }
            }

            audioTab.addEventListener('click', () => showPlaylist('audio'));
            videoTab.addEventListener('click', () => showPlaylist('video'));
            
            // --- Media Session Action Handlers ---
            if ('mediaSession' in navigator) {
                navigator.mediaSession.setActionHandler('play', playSong);
                navigator.mediaSession.setActionHandler('pause', pauseSong);
                navigator.mediaSession.setActionHandler('previoustrack', prevSong);
                navigator.mediaSession.setActionHandler('nexttrack', nextSong);
                navigator.mediaSession.setActionHandler('seekto', (details) => {
                    audioPlayer.currentTime = details.seekTime;
                    updatePositionState();
                    updateLyricHighlighting(); // Update karaoke on seek
                });
            }

            // --- 6. INITIALIZE PLAYER ---
            createPlaylist();
            createVideoPlaylist();
            loadSong(songs[currentSongIndex]); // Load first song
            currentView = 'lyrics'; // Set initial view state
            // updateLyricsContent(); // loadSong now handles this
            flipper.classList.remove('is-flipped'); // Ensure it starts on the front
            
            
            // --- 7. PWA Service Worker Registration ---
            const isPwa = window.matchMedia('(display-mode: standalone)').matches;
            showBeginButton(); // Show button immediately

            if (isPwa && 'serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful:', registration);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            } else {
                console.log('Not in PWA mode, skipping PWA features.');
            }
        });
    </script>
</body>
</html>
